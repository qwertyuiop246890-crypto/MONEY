<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>極簡記帳 (Minimalist Tracker)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons (UMD) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        input, select, textarea { font-size: 16px !important; }
        /* 增加預算條的斜線紋理，表示預估 */
        .bg-striped {
            background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent);
            background-size: 1rem 1rem;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        
        // --- Icon Wrapper (終極穩定版) ---
        // 使用 React.memo 和 key 來強制在屬性變更時重建 DOM，避免 React Reconciliation 錯誤
        const Icon = React.memo(({ name, size = 20, className = "" }) => {
            const iconName = name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
            const containerRef = useRef(null);

            useEffect(() => {
                if (window.lucide && containerRef.current) {
                    const iElement = document.createElement('i');
                    iElement.setAttribute('data-lucide', iconName);
                    iElement.setAttribute('width', size);
                    iElement.setAttribute('height', size);
                    if (className) iElement.setAttribute('class', className);

                    // 安全地清空容器
                    while (containerRef.current.firstChild) {
                        containerRef.current.removeChild(containerRef.current.firstChild);
                    }
                    containerRef.current.appendChild(iElement);
                    window.lucide.createIcons({ root: containerRef.current });
                }
            }, [iconName, size, className]);

            // key={iconName} 是關鍵：當 icon 改變時，React 會直接換掉這個 span，而不是嘗試更新它
            // 這避免了 "The node to be removed is not a child of this node" 錯誤
            return <span key={iconName} ref={containerRef} style={{ display: 'inline-flex', verticalAlign: 'middle' }}></span>;
        });

        // --- 工具函數 ---
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const formatCurrency = (amount) => {
            if (amount === undefined || amount === null || isNaN(amount)) return "$0";
            return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(amount);
        };
        const formatMonth = (date) => {
            try { return date.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long' }); } catch(e) { return ''; }
        };
        const safeDate = (iso) => {
            if (!iso) return new Date();
            const d = new Date(iso);
            return isNaN(d.getTime()) ? new Date() : d;
        };
        const formatDateTime = (iso) => safeDate(iso).toLocaleString('zh-TW', {month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'});
        const toInputDate = (iso) => safeDate(iso).toISOString().split('T')[0];
        const toInputDateTime = (iso) => {
            const d = safeDate(iso);
            d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
            return d.toISOString().slice(0, 16);
        };
        const getRelativeDate = (days) => { 
            const d = new Date(); 
            d.setDate(d.getDate() + days); 
            return d.toISOString(); 
        };
        const getMonthRange = (date) => {
            const d = safeDate(date);
            const y = d.getFullYear();
            const m = d.getMonth();
            return { firstDay: new Date(y, m, 1), lastDay: new Date(y, m + 1, 0, 23, 59, 59, 999) };
        };
        const getAccountCycleRange = (viewDate, startDay = 1) => {
            const d = safeDate(viewDate);
            const y = d.getFullYear();
            const m = d.getMonth();
            if (startDay === 1) return { start: new Date(y, m, 1), end: new Date(y, m + 1, 0, 23, 59, 59, 999), label: formatMonth(d) };
            
            // 如果今天是 12/5，起始日是 25，則週期是 11/25 - 12/24
            // 如果今天是 12/26，起始日是 25，則週期是 12/25 - 1/24
            // 這裡傳入的 viewDate 已經是 "當前檢視月份" 的 1 號 (由 DashboardView 控制)
            // 所以我們只需要根據那個月份計算即可
            const start = new Date(y, m, startDay);
            const end = new Date(y, m + 1, startDay - 1, 23, 59, 59, 999);
            return { start, end, label: `${start.getMonth()+1}/${start.getDate()} - ${end.getMonth()+1}/${end.getDate()}` };
        };

        const calculateAccountBalance = (account, transactions) => {
            if (!account || !transactions) return 0;
            let balance = parseFloat(account.initialBalance || 0);
            transactions.forEach(t => {
                const amount = parseFloat(t.amount);
                if (t.accountId === account.id) {
                    if (t.type === 'expense') balance -= amount;
                    if (t.type === 'income') balance += amount;
                    if (t.type === 'transfer_out') balance -= amount;
                }
                if (t.toAccountId === account.id && t.type === 'transfer_in') balance += amount;
            });
            return balance;
        };

        // --- 核心邏輯：處理週期性帳務產生 ---
        const processRules = (rules, currentTxs) => {
            const now = new Date();
            let newTxList = [...currentTxs];
            let hasUpdates = false;

            const updatedRules = rules.map(rule => {
                if (!rule.active) return rule;
                let ruleUpdated = false;
                let nextDate = new Date(rule.nextDueDate);
                let count = rule.remainingCount;

                // 檢查是否需產生交易 (下次執行日 <= 現在)
                while (nextDate <= now && (count === null || count > 0)) {
                    const newTx = {
                        id: generateId(),
                        type: rule.type,
                        amount: parseFloat(rule.amount),
                        date: nextDate.toISOString(),
                        categoryId: rule.categoryId,
                        accountId: rule.accountId,
                        note: `[週期] ${rule.note}`,
                        installments: 1,
                        excludeFromBudget: rule.excludeFromBudget || false 
                    };
                    newTxList.push(newTx);
                    nextDate.setMonth(nextDate.getMonth() + 1);
                    if (count !== null) count--;
                    hasUpdates = true;
                    ruleUpdated = true;
                }

                if (ruleUpdated) {
                    if (count === 0) return { ...rule, nextDueDate: nextDate.toISOString(), remainingCount: 0, active: false };
                    return { ...rule, nextDueDate: nextDate.toISOString(), remainingCount: count };
                }
                return rule;
            });

            return { rules: updatedRules, txs: newTxList, hasUpdates };
        };

        // --- 範例資料 ---
        const INITIAL_ACCOUNTS = [
            { id: 'a1', name: '錢包現金', type: 'cash', balance: 0, initialBalance: 3000 },
            { id: 'a2', name: '薪資帳戶', type: 'bank', balance: 0, initialBalance: 52000 },
            { id: 'a3', name: '台新黑狗卡', type: 'credit', balance: 0, initialBalance: 0, creditLimit: 150000, statementDay: 1, dueDay: 15 },
        ];
        const INITIAL_CATEGORIES = [
            { id: 'c1', name: '餐飲', type: 'expense', icon: 'Utensils', color: 'bg-orange-100 text-orange-600' },
            { id: 'c2', name: '交通', type: 'expense', icon: 'Bus', color: 'bg-blue-100 text-blue-600' },
            { id: 'c3', name: '購物', type: 'expense', icon: 'ShoppingBag', color: 'bg-pink-100 text-pink-600' },
            { id: 'c4', name: '娛樂', type: 'expense', icon: 'Gamepad2', color: 'bg-purple-100 text-purple-600' },
            { id: 'c5', name: '居住', type: 'expense', icon: 'Home', color: 'bg-green-100 text-green-600' },
            { id: 'c6', name: '薪資', type: 'income', icon: 'Banknote', color: 'bg-yellow-100 text-yellow-600' },
            { id: 'c7', name: '獎金', type: 'income', icon: 'Gem', color: 'bg-teal-100 text-teal-600' },
            { id: 'c11', name: '訂閱', type: 'expense', icon: 'Repeat', color: 'bg-indigo-100 text-indigo-600' },
        ];
        const INITIAL_BUDGET = { amount: 25000, resetDay: 1, enabled: true };
        const INITIAL_RECURRING = [
             { id: 'r1', type: 'expense', amount: 390, categoryId: 'c11', accountId: 'a3', note: 'Netflix', nextDueDate: getRelativeDate(20), remainingCount: null, active: true, excludeFromBudget: false }
        ];
        const INITIAL_TRANSACTIONS = [
            { id: 't1', date: getRelativeDate(-5), type: 'income', amount: 60000, accountId: 'a2', categoryId: 'c6', note: '十月薪資', verified: true, excludeFromBudget: false },
            { id: 't2', date: getRelativeDate(-2), type: 'expense', amount: 150, accountId: 'a1', categoryId: 'c1', note: '牛肉麵', verified: true, excludeFromBudget: false },
            { id: 't3', date: getRelativeDate(-1), type: 'expense', amount: 1200, accountId: 'a3', categoryId: 'c2', note: '加油', verified: false, excludeFromBudget: false },
            { id: 't4', date: getRelativeDate(0), type: 'expense', amount: 450, accountId: 'a1', categoryId: 'c1', note: '聚餐', verified: false, excludeFromBudget: false },
            { id: 't5', date: getRelativeDate(0), type: 'expense', amount: 8000, accountId: 'a2', categoryId: 'c5', note: '房租(不計預算)', excludeFromBudget: true, verified: false },
        ];

        // --- 子元件 ---

        const CustomDialog = ({ isOpen, type, title, message, onConfirm, onCancel, defaultValue = '' }) => {
            const [inputValue, setInputValue] = useState(defaultValue);
            useEffect(() => { if (isOpen) setInputValue(defaultValue); }, [isOpen, defaultValue]);
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                    <div className="bg-white rounded-2xl shadow-xl w-full max-w-xs overflow-hidden animate-in fade-in zoom-in duration-200">
                        <div className="p-5 text-center">
                            <div className="mx-auto mb-3 flex justify-center">
                                {type === 'alert' && <Icon name="AlertCircle" className="text-red-500" size={40} />}
                                {type === 'confirm' && <Icon name="AlertTriangle" className="text-amber-500" size={40} />}
                                {type === 'prompt' && <Icon name="Edit2" className="text-blue-500" size={40} />}
                            </div>
                            <h3 className="font-bold text-lg text-slate-800 mb-2">{title}</h3>
                            <p className="text-sm text-slate-500 mb-4 whitespace-pre-line">{message}</p>
                            {type === 'prompt' && <input type="number" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl mb-4 text-center font-bold text-lg" value={inputValue} onChange={(e) => setInputValue(e.target.value)} autoFocus />}
                            <div className="flex gap-2 justify-center">
                                {type !== 'alert' && <button onClick={onCancel} className="flex-1 py-3 px-4 rounded-xl bg-slate-100 text-slate-600 font-bold active:bg-slate-200 transition-colors">取消</button>}
                                <button onClick={() => onConfirm(type === 'prompt' ? inputValue : undefined)} className={`flex-1 py-3 px-4 rounded-xl font-bold text-white shadow-lg active:scale-95 transition-transform ${type === 'alert' ? 'bg-red-500' : 'bg-slate-900'}`}>確定</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const SummaryCard = ({ title, amount, color, onClick }) => (
            <div onClick={onClick} className="bg-white p-3 rounded-xl shadow-sm flex-1 mx-1 border border-slate-100 cursor-pointer active:bg-slate-50">
                <div className="text-slate-500 text-xs mb-1 font-bold">{title}</div>
                <div className={`text-lg font-bold ${color}`}>{formatCurrency(amount)}</div>
            </div>
        );

        const TransactionItem = ({ tx, onClick, categories, accounts, handleToggleVerified, showCheckbox, isPending = false }) => {
            const cat = categories.find(c => c.id === tx.categoryId) || {};
            const acc = accounts.find(a => a.id === tx.accountId) || {};
            const isTransfer = tx.type.includes('transfer');
            const color = tx.type === 'income' || tx.type === 'transfer_in' ? 'text-green-600' : 'text-red-600';
            const sign = tx.type === 'income' || tx.type === 'transfer_in' ? '+' : '-';
            
            return (
                <div className={`flex items-center justify-between p-3 mb-2 rounded-lg shadow-sm border ${isPending ? 'bg-slate-50 border-dashed border-slate-300 opacity-80 cursor-pointer' : 'bg-white border-slate-100'}`} onClick={onClick}>
                    <div className="flex items-center gap-3 flex-1">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${isPending ? 'bg-slate-200 text-slate-400' : 'bg-gray-100'}`}>
                            <Icon name={isTransfer ? "ArrowRightLeft" : (cat.icon || 'Tag')} size={18} />
                        </div>
                        <div>
                            <div className="font-bold text-slate-800 flex items-center gap-2">
                                {isTransfer ? '轉帳' : (cat.name || '未分類')}
                                {tx.installments > 1 && <span className="text-[10px] bg-blue-100 text-blue-600 px-1 rounded">分期</span>}
                                {tx.excludeFromBudget && <span className="text-[10px] bg-gray-200 text-gray-500 px-1 rounded">不計預算</span>}
                                {isPending && <span className="text-[10px] bg-indigo-100 text-indigo-600 px-1 rounded">預估</span>}
                            </div>
                            <div className="text-xs text-slate-500">
                                {safeDate(tx.date).toLocaleDateString()} • {acc.name || '預設帳戶'}
                                {tx.note && <span className="ml-1 text-slate-400">({tx.note})</span>}
                            </div>
                        </div>
                    </div>
                    <div className="flex items-center gap-3">
                        <div className={`font-bold ${color}`}>{sign}{formatCurrency(tx.amount)}</div>
                        {showCheckbox && !isPending && <button onClick={(e) => { e.stopPropagation(); handleToggleVerified(tx.id); }} className="text-slate-300">
                            {tx.verified ? <Icon name="CheckSquare" className="text-green-500" /> : <Icon name="Square" />}
                        </button>}
                        {isPending && <Icon name="Edit2" size={14} className="text-slate-300" />}
                    </div>
                </div>
            );
        };

        const DashboardView = ({ transactions, accounts, budget, categories, setView, setDrillDownData, setEditingTransaction, handleToggleVerified, currentViewDate, setCurrentViewDate, setActiveTab, recurringRules }) => {
            const resetDay = (budget.enabled && budget.resetDay) ? parseInt(budget.resetDay) : 1;
            const { start: firstDay, end: lastDay, label: dateLabel } = getAccountCycleRange(currentViewDate, resetDay);

            const monthTx = transactions.filter(t => { const d = safeDate(t.date); return d >= firstDay && d <= lastDay; });
            const income = monthTx.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            const expense = monthTx.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
            const totalAssets = accounts.reduce((acc, cur) => acc + calculateAccountBalance(cur, transactions), 0);
            
            // --- 預算計算：實際 + 預估 ---
            const actualBudgetTx = monthTx.filter(t => t.type === 'expense' && !t.excludeFromBudget);
            const actualBudgetUsed = actualBudgetTx.reduce((s, t) => s + t.amount, 0);

            // 計算本月尚未發生但「應」發生的固定支出 (含跨月預覽)
            // 修正：不只是看 nextDueDate，而是要展開所有落在區間內的預估項目
            const pendingTxList = [];
            (recurringRules || []).forEach(rule => {
                if (!rule.active) return;
                
                let currentRuleDate = new Date(rule.nextDueDate);
                // 預估邏輯：從 nextDueDate 開始往後推，只要落在本月檢視範圍內就加入
                let safety = 0;
                while(currentRuleDate <= lastDay && safety < 24) { 
                    if (currentRuleDate >= firstDay) {
                         pendingTxList.push({
                            id: `pending-${rule.id}-${currentRuleDate.getTime()}`,
                            ruleId: rule.id, // 重要：用於識別關聯的規則
                            date: currentRuleDate.toISOString(),
                            type: rule.type,
                            amount: parseFloat(rule.amount),
                            categoryId: rule.categoryId,
                            accountId: rule.accountId,
                            note: `[預估固定] ${rule.note}`,
                            isPending: true,
                            excludeFromBudget: rule.excludeFromBudget
                        });
                    }
                    currentRuleDate.setMonth(currentRuleDate.getMonth() + 1);
                    safety++;
                }
            });

            // 計算預估的預算金額 (從展開後的列表計算，修正之前的 Bug)
            const pendingBudgetTx = pendingTxList.filter(t => t.type === 'expense' && !t.excludeFromBudget);
            const pendingBudgetAmount = pendingBudgetTx.reduce((s, t) => s + t.amount, 0);

            // 合併顯示列表：實際交易 + 預估固定支出，並依照日期排序 (新到舊)
            const allDisplayTx = [...monthTx, ...pendingTxList].sort((a,b) => safeDate(b.date) - safeDate(a.date));

            const totalBudgetUsed = actualBudgetUsed + pendingBudgetAmount;
            const totalPct = budget.amount > 0 ? Math.min((totalBudgetUsed / budget.amount) * 100, 100) : 0;
            const actualPct = budget.amount > 0 ? Math.min((actualBudgetUsed / budget.amount) * 100, 100) : 0;
            const pendingPct = totalPct - actualPct; 

            const creditIds = accounts.filter(a => a.type === 'credit').map(a => a.id);
            const creditUsed = monthTx.filter(t => t.type === 'expense' && creditIds.includes(t.accountId)).reduce((s, t) => s + t.amount, 0);
            const creditTx = monthTx.filter(t => t.type === 'expense' && creditIds.includes(t.accountId));
            const futureInstallments = transactions.filter(t => t.type === 'expense' && creditIds.includes(t.accountId) && safeDate(t.date) > lastDay).reduce((s, t) => s + t.amount, 0);
            const futureTx = transactions.filter(t => t.type === 'expense' && creditIds.includes(t.accountId) && safeDate(t.date) > lastDay);
            const recurringSum = (recurringRules || []).filter(r => r.active).reduce((s, r) => s + parseFloat(r.amount), 0);

            return (
                <div className="space-y-4 pb-24">
                    <div className="flex items-center justify-between px-2">
                        <button onClick={() => setCurrentViewDate(new Date(currentViewDate.setMonth(currentViewDate.getMonth() - 1)))} className="p-2 bg-white rounded shadow-sm"><Icon name="ChevronLeft"/></button>
                        <div className="font-bold text-lg flex items-center gap-2"><Icon name="Calendar"/> {dateLabel}</div>
                        <button onClick={() => setCurrentViewDate(new Date(currentViewDate.setMonth(currentViewDate.getMonth() + 1)))} className="p-2 bg-white rounded shadow-sm"><Icon name="ChevronRight"/></button>
                    </div>

                    <div className="bg-slate-900 text-white p-6 rounded-2xl shadow-lg" onClick={() => setActiveTab('accounts')}>
                        <div className="text-sm opacity-70">淨資產總額</div>
                        <div className="text-3xl font-bold">{formatCurrency(totalAssets)}</div>
                    </div>

                    {budget.enabled && (
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200" onClick={() => { 
                            setDrillDownData({title: '本月預算明細 (含預估)', txList: allDisplayTx.filter(t => t.type === 'expense' && !t.excludeFromBudget)}); 
                            setView('drill_down'); 
                        }}>
                            <div className="flex justify-between mb-2">
                                <span className="font-bold text-slate-700">本月預算</span>
                                <span className={budget.amount - totalBudgetUsed < 0 ? 'text-red-500 font-bold' : 'text-green-600 font-bold'}>剩餘 {formatCurrency(budget.amount - totalBudgetUsed)}</span>
                            </div>
                            <div className="h-4 bg-slate-100 rounded-full overflow-hidden relative flex">
                                <div className={`h-full ${actualPct > 90 ? 'bg-red-500' : 'bg-blue-600'} transition-all duration-500`} style={{width: `${actualPct}%`}}></div>
                                <div className="h-full bg-blue-300 bg-striped transition-all duration-500" style={{width: `${pendingPct}%`}}></div>
                            </div>
                            <div className="flex justify-between items-start mt-2">
                                <div className="text-[11px] text-slate-500 flex flex-col gap-1">
                                    <span className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-blue-600"></div>實際: {formatCurrency(actualBudgetUsed)}</span>
                                    {pendingBudgetAmount > 0 && <span className="flex items-center gap-1 text-blue-500"><div className="w-2 h-2 rounded-full bg-blue-300"></div>+ 預估固定: {formatCurrency(pendingBudgetAmount)}</span>}
                                </div>
                                <div className="text-xs text-right text-slate-400 font-bold mt-auto">
                                    總計 {formatCurrency(totalBudgetUsed)} / {formatCurrency(budget.amount)}
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="grid grid-cols-3 gap-2">
                         <div className="bg-white p-2 rounded-xl border border-slate-200 text-center" onClick={() => { setDrillDownData({title:'本月信用卡消費', txList: creditTx}); setView('drill_down'); }}>
                            <div className="text-[10px] text-slate-500">信用卡本月</div>
                            <div className="font-bold text-slate-800">{formatCurrency(creditUsed)}</div>
                         </div>
                         <div className="bg-white p-2 rounded-xl border border-slate-200 text-center" onClick={() => { setDrillDownData({title:'未來分期餘額', txList: futureTx}); setView('drill_down'); }}>
                            <div className="text-[10px] text-slate-500">分期未到期</div>
                            <div className="font-bold text-blue-600">{formatCurrency(futureInstallments)}</div>
                         </div>
                         <div className="bg-white p-2 rounded-xl border border-slate-200 text-center" onClick={() => setView('recurring_manager')}>
                            <div className="text-[10px] text-slate-500">固定/週期支出</div>
                            <div className="font-bold text-indigo-600">{formatCurrency(recurringSum)}</div>
                         </div>
                    </div>

                    <div className="flex gap-2">
                        <SummaryCard title="本月收入" amount={income} color="text-green-600" onClick={() => { setDrillDownData({title:'本月收入', txList: monthTx.filter(t=>t.type==='income')}); setView('drill_down'); }} />
                        <SummaryCard title="本月支出" amount={expense} color="text-red-600" onClick={() => { setDrillDownData({title:'本月支出', txList: monthTx.filter(t=>t.type==='expense')}); setView('drill_down'); }} />
                    </div>

                    <div>
                        <h3 className="font-bold text-slate-700 mb-2">近期活動 (含預估)</h3>
                        {allDisplayTx.slice(0, 10).map(tx => (
                            <TransactionItem key={tx.id} tx={tx} categories={categories} accounts={accounts} onClick={() => { setEditingTransaction(tx); setView('add_transaction'); }} handleToggleVerified={handleToggleVerified} showCheckbox={!tx.isPending} isPending={tx.isPending} />
                        ))}
                    </div>
                </div>
            );
        };

        const AccountsList = ({ accounts, setAccounts, transactions, setView, setSelectedAccount }) => {
            const moveAccount = (idx, dir) => {
                const newAcc = [...accounts];
                if (dir === 'up' && idx > 0) [newAcc[idx], newAcc[idx-1]] = [newAcc[idx-1], newAcc[idx]];
                if (dir === 'down' && idx < newAcc.length-1) [newAcc[idx], newAcc[idx+1]] = [newAcc[idx+1], newAcc[idx]];
                setAccounts(newAcc);
            };
            return (
                <div className="space-y-3 pb-24">
                    {accounts.map((acc, idx) => (
                        <div key={acc.id} className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex justify-between items-center" onClick={() => { setSelectedAccount(acc); setView('account_detail'); }}>
                            <div className="flex items-center gap-3">
                                <div className="bg-slate-100 p-2 rounded-full text-xl">{acc.type === 'credit' ? <Icon name="CreditCard"/> : acc.type === 'bank' ? <Icon name="Home"/> : <Icon name="DollarSign"/>}</div>
                                <div><div className="font-bold">{acc.name}</div><div className="text-xs text-slate-500 capitalize">{acc.type}</div></div>
                            </div>
                            <div className="flex items-center gap-2">
                                <div className="font-bold text-right">{formatCurrency(calculateAccountBalance(acc, transactions))}</div>
                                <div className="flex flex-col" onClick={e => e.stopPropagation()}>
                                    <button onClick={() => moveAccount(idx, 'up')} className="text-slate-300 hover:text-slate-600 disabled:opacity-20" disabled={idx===0}><Icon name="ArrowUp" size={14}/></button>
                                    <button onClick={() => moveAccount(idx, 'down')} className="text-slate-300 hover:text-slate-600 disabled:opacity-20" disabled={idx===accounts.length-1}><Icon name="ArrowDown" size={14}/></button>
                                </div>
                            </div>
                        </div>
                    ))}
                    <button onClick={() => { setSelectedAccount(null); setView('edit_account'); }} className="w-full py-3 border-2 border-dashed border-slate-300 rounded-xl text-slate-400 font-bold flex items-center justify-center gap-2"><Icon name="Plus"/> 新增帳戶</button>
                </div>
            );
        };

        const SettingsView = ({ setView, exportRange, setExportRange, exportCSV, handleImportCSV, handleExportJSON, handleImportJSON }) => (
            <div className="p-4 space-y-6 pb-24">
                <h2 className="text-xl font-bold">設定</h2>
                <div className="bg-white rounded-xl p-4 shadow-sm border border-slate-100">
                    <h3 className="font-bold mb-4 text-sm text-slate-500 uppercase">功能設定</h3>
                    <button onClick={() => setView('category_manager')} className="w-full flex items-center justify-between p-3 hover:bg-slate-50 rounded-lg"><div className="flex items-center gap-3"><Icon name="Tag" className="text-orange-500"/><span>類別管理</span></div><Icon name="ChevronRight" className="text-slate-300"/></button>
                    <button onClick={() => setView('budget_settings')} className="w-full flex items-center justify-between p-3 hover:bg-slate-50 rounded-lg"><div className="flex items-center gap-3"><Icon name="Target" className="text-purple-500"/><span>預算設定</span></div><Icon name="ChevronRight" className="text-slate-300"/></button>
                    <button onClick={() => setView('recurring_manager')} className="w-full flex items-center justify-between p-3 hover:bg-slate-50 rounded-lg"><div className="flex items-center gap-3"><Icon name="Repeat" className="text-indigo-500"/><span>週期性帳務管理</span></div><Icon name="ChevronRight" className="text-slate-300"/></button>
                </div>
                
                <div className="bg-white rounded-xl p-4 shadow-sm border border-slate-100">
                    <h3 className="font-bold mb-4 text-sm text-slate-500 uppercase">完整備份</h3>
                    <div className="space-y-3">
                        <button onClick={handleExportJSON} className="w-full flex items-center justify-between p-3 bg-slate-50 hover:bg-slate-100 rounded-lg text-slate-700"><div className="flex items-center gap-3"><Icon name="Save" className="text-blue-600"/><span>匯出備份 (JSON)</span></div><Icon name="Download" size={16} /></button>
                        <div className="relative w-full">
                            <button className="w-full flex items-center justify-between p-3 bg-slate-50 hover:bg-slate-100 rounded-lg text-slate-700"><div className="flex items-center gap-3"><Icon name="Upload" className="text-orange-600"/><span>還原備份 (JSON)</span></div><Icon name="Upload" size={16} /></button>
                            <input type="file" accept=".json" onChange={handleImportJSON} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"/>
                        </div>
                    </div>
                </div>

                <div className="bg-white rounded-xl p-4 shadow-sm border border-slate-100">
                    <h3 className="font-bold mb-4 text-sm text-slate-500 uppercase">交易明細 (電腦編輯)</h3>
                    <p className="text-xs text-slate-400 mb-3">匯出 CSV 後可在電腦 Excel/Google Sheets 修改，再匯入手機即可更新資料 (ID 相同者會自動覆蓋)。</p>
                    <div className="flex gap-2 mb-3 px-3">
                        <div className="flex-1"><label className="text-[10px] text-slate-400 block mb-1 font-bold">匯出開始日期</label><input type="date" value={exportRange.start} onChange={e => setExportRange({...exportRange, start: e.target.value})} className="w-full p-2 bg-slate-50 rounded-lg text-xs border border-slate-200"/></div>
                        <div className="flex-1"><label className="text-[10px] text-slate-400 block mb-1 font-bold">匯出結束日期</label><input type="date" value={exportRange.end} onChange={e => setExportRange({...exportRange, end: e.target.value})} className="w-full p-2 bg-slate-50 rounded-lg text-xs border border-slate-200"/></div>
                    </div>
                    <button onClick={exportCSV} className="w-full flex items-center justify-between p-3 hover:bg-slate-50 rounded-lg"><div className="flex items-center gap-3"><Icon name="Download" className="text-blue-500"/><span>匯出完整 CSV (中文)</span></div><Icon name="ChevronRight" className="text-slate-300"/></button>
                    <div className="relative w-full">
                        <button className="w-full flex items-center justify-between p-3 hover:bg-slate-50 rounded-lg"><div className="flex items-center gap-3"><Icon name="Upload" className="text-green-500"/><span>匯入/更新 CSV (中文)</span></div><Icon name="ChevronRight" className="text-slate-300"/></button>
                        <input type="file" accept=".csv" onChange={handleImportCSV} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"/>
                    </div>
                </div>
                <div className="text-center text-xs text-slate-300 pt-4">Minimalist Tracker v2.8 (Full Fix)</div>
            </div>
        );

        const AccountEditForm = ({ initialData, onClose, handleDeleteAccount, handleUpdateAccount }) => {
            const [form, setForm] = useState(initialData || {name: '', type: 'cash', initialBalance: 0});
            return (
                <div className="fixed inset-0 bg-white z-50 p-4">
                    <div className="flex items-center mb-4"><button onClick={onClose}><Icon name="X"/></button><h2 className="flex-1 text-center font-bold">帳戶設定</h2></div>
                    <div className="space-y-4">
                        <div><label className="text-xs text-slate-500">帳戶名稱</label><input className="w-full p-3 bg-slate-50 rounded-lg mt-1" value={form.name} onChange={e=>setForm({...form, name: e.target.value})} /></div>
                        <div><label className="text-xs text-slate-500">類型</label><div className="flex gap-2 mt-1">{['cash', 'bank', 'credit'].map(t => (<button key={t} onClick={() => setForm({...form, type: t})} className={`flex-1 py-2 rounded-lg border ${form.type === t ? 'border-slate-800 bg-slate-100 font-bold' : 'border-slate-200'}`}>{t === 'cash' ? '現金' : t === 'bank' ? '銀行' : '信用卡'}</button>))}</div></div>
                        <div><label className="text-xs text-slate-500">初始餘額</label><input type="number" className="w-full p-3 bg-slate-50 rounded-lg mt-1" value={form.initialBalance} onChange={e=>setForm({...form, initialBalance: parseFloat(e.target.value)})} /></div>
                        {form.type === 'credit' && (<div className="bg-slate-50 p-4 rounded-lg space-y-3"><h4 className="font-bold text-sm">信用卡設定</h4><div><label className="text-xs text-slate-500">信用額度</label><input type="number" className="w-full p-2 bg-white border rounded mt-1" value={form.creditLimit} onChange={e => setForm({...form, creditLimit: parseFloat(e.target.value)})} /></div><div className="flex gap-3"><div className="flex-1"><label className="text-xs text-slate-500">結帳日</label><input type="number" className="w-full p-2 bg-white border rounded mt-1" value={form.statementDay} onChange={e => setForm({...form, statementDay: parseInt(e.target.value)})} /></div><div className="flex-1"><label className="text-xs text-slate-500">繳款截止</label><input type="number" className="w-full p-2 bg-white border rounded mt-1" value={form.dueDay} onChange={e => setForm({...form, dueDay: parseInt(e.target.value)})} /></div></div></div>)}
                        <button onClick={()=>{ handleUpdateAccount({...form, isNew: !initialData}); onClose(); }} className="w-full bg-slate-900 text-white p-3 rounded-xl">儲存</button>
                        {initialData && <button onClick={()=>handleDeleteAccount(initialData.id)} className="w-full text-red-500 p-3 flex items-center justify-center gap-2"><Icon name="Trash2" size={16}/> 刪除帳戶</button>}
                    </div>
                </div>
            );
        };

        const AccountDetail = ({ selectedAccount, accounts, transactions, setView, setEditingTransaction, showPrompt, showAlert, showConfirm, handleAddTransaction, categories, handleToggleVerified }) => {
            const [viewDate, setViewDate] = useState(new Date());
            if (!selectedAccount) return null;
            const balance = calculateAccountBalance(selectedAccount, transactions);
            const statementDay = selectedAccount.type === 'credit' ? (selectedAccount.statementDay || 1) : 1;
            const { start, end, label } = getAccountCycleRange(viewDate, statementDay);

            const accTx = transactions
                .filter(t => t.accountId === selectedAccount.id || t.toAccountId === selectedAccount.id)
                .filter(t => { const d = safeDate(t.date); return d >= start && d <= end; })
                .sort((a, b) => safeDate(b.date) - safeDate(a.date));

            const verifiedBalance = accTx.filter(t => t.verified).reduce((sum, t) => { if (t.type === 'expense' || t.type === 'transfer_out') return sum - t.amount; if (t.type === 'income' || t.type === 'transfer_in') return sum + t.amount; return sum; }, 0);
            const currentPeriodNet = accTx.reduce((sum, t) => { if (t.type === 'expense') return sum - t.amount; if (t.type === 'income') return sum + t.amount; if (t.accountId === selectedAccount.id && t.type === 'transfer_out') return sum - t.amount; if (t.toAccountId === selectedAccount.id && t.type === 'transfer_in') return sum + t.amount; return sum; }, 0);

            const handleReconcile = () => {
                showPrompt('對帳', `目前總餘額 ${formatCurrency(balance)}\n請輸入實際餘額：`, balance, (actualStr) => {
                    const actual = parseFloat(actualStr);
                    if (isNaN(actual)) return;
                    const diff = actual - balance;
                    if (Math.abs(diff) < 1) return showAlert('對帳成功', '金額相符');
                    showConfirm('建立調整交易', `計算差異為 ${formatCurrency(diff)}，是否自動建立調整交易？`, () => {
                        handleAddTransaction({ type: diff > 0 ? 'income' : 'expense', amount: Math.abs(diff), date: new Date().toISOString(), categoryId: diff > 0 ? 'c10' : 'c9', accountId: selectedAccount.id, note: '對帳調整', installments: 1 });
                    });
                });
            };

            const handlePayCard = () => {
                const amountToPay = currentPeriodNet < 0 ? Math.abs(currentPeriodNet) : 0;
                setEditingTransaction({ type: 'transfer', amount: amountToPay, date: new Date().toISOString(), toAccountId: selectedAccount.id, accountId: accounts.find(a => a.type === 'bank')?.id || '', note: `繳交 ${selectedAccount.name} (${label}) 卡費` });
                setView('add_transaction');
            };

            const prevMonth = () => setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth() - 1, 1));
            const nextMonth = () => setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 1));

            return (
                <div className="bg-slate-50 min-h-screen pb-safe">
                    <div className="bg-slate-900 text-white p-6 pb-12 sticky top-0 z-10">
                        <div className="flex items-center mb-4"><button onClick={() => setView('main')}><Icon name="ChevronLeft"/></button><h2 className="flex-1 text-center font-bold">{selectedAccount.name}</h2><button onClick={() => setView('edit_account')}><Icon name="Edit2" size={18} /></button></div>
                        <div className="text-center"><div className="text-slate-400 text-sm">當前總餘額</div><div className="text-3xl font-bold my-1">{formatCurrency(balance)}</div>{selectedAccount.type === 'credit' && (<div className="text-xs text-slate-500">可用額度: {formatCurrency((selectedAccount.creditLimit || 0) + balance)}</div>)}</div>
                        <div className="flex justify-center gap-3 mt-6">
                            <button onClick={handleReconcile} className="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-full text-sm flex items-center gap-2"><Icon name="CheckCircle" size={14}/> 對帳</button>
                            {selectedAccount.type === 'credit' && currentPeriodNet < 0 && (<button onClick={handlePayCard} className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-full text-sm flex items-center gap-2"><Icon name="CreditCard" size={14}/> 繳本期帳單</button>)}
                        </div>
                    </div>
                    <div className="px-4 -mt-6">
                        <div className="bg-white rounded-xl shadow-sm min-h-[500px] p-2">
                            <div className="flex items-center justify-between p-2 mb-2 border-b border-slate-100 pb-3"><button onClick={prevMonth} className="p-1 hover:bg-slate-100 rounded"><Icon name="ChevronLeft" size={20} className="text-slate-400"/></button><div className="text-center"><div className="font-bold text-slate-800">{formatMonth(viewDate)}</div><div className="text-[10px] text-slate-400">週期: {label}</div></div><button onClick={nextMonth} className="p-1 hover:bg-slate-100 rounded"><Icon name="ChevronRight" size={20} className="text-slate-400"/></button></div>
                            <div className="text-center text-xs text-slate-500 mb-3 bg-slate-50 p-2 rounded-lg mx-2 border border-slate-100">已確認金額: <span className={`font-bold ${verifiedBalance < 0 ? 'text-red-500' : 'text-slate-700'}`}>{formatCurrency(verifiedBalance)}</span></div>
                            {accTx.map(tx => (<TransactionItem key={tx.id} tx={tx} onClick={() => { setEditingTransaction(tx); setView('add_transaction'); }} showCheckbox={true} categories={categories} accounts={accounts} handleToggleVerified={handleToggleVerified} />))}{accTx.length === 0 && <div className="text-center text-slate-400 py-10">此區間無交易紀錄</div>}
                        </div>
                    </div>
                </div>
            );
        };

        const DrillDownView = ({ title, txList, setView, setEditingTransaction, categories, accounts, handleToggleVerified }) => {
            const sorted = [...txList].sort((a,b) => safeDate(b.date) - safeDate(a.date));
            const total = sorted.reduce((s, t) => s + (t.type==='income' || t.type==='transfer_in' ? t.amount : -t.amount), 0);
            const grouped = {};
            sorted.forEach(tx => {
                const d = safeDate(tx.date).toLocaleDateString('zh-TW');
                if(!grouped[d]) grouped[d] = [];
                grouped[d].push(tx);
            });
            return (
                <div className="fixed inset-0 bg-white z-40 overflow-y-auto pb-safe">
                    <div className="flex items-center p-4 border-b sticky top-0 bg-white"><button onClick={() => setView('main')}><Icon name="ChevronLeft"/></button><h2 className="flex-1 text-center font-bold">{title}</h2></div>
                    <div className="p-4 bg-slate-50 min-h-screen">
                        <div className="bg-slate-900 text-white p-4 rounded-xl mb-4 text-center"><div className="text-sm opacity-70">合計</div><div className="text-2xl font-bold">{formatCurrency(Math.abs(total))}</div></div>
                        {Object.entries(grouped).map(([date, txs]) => (
                            <div key={date} className="mb-4">
                                <div className="text-xs text-slate-500 font-bold mb-2 ml-1">{date}</div>
                                {txs.map(tx => (<TransactionItem key={tx.id} tx={tx} categories={categories} accounts={accounts} onClick={() => { setEditingTransaction(tx); setView('add_transaction'); }} handleToggleVerified={handleToggleVerified} showCheckbox={!tx.isPending} isPending={tx.isPending} />))}
                            </div>
                        ))}
                        {sorted.length === 0 && <div className="text-center text-slate-400 py-10">無交易紀錄</div>}
                    </div>
                </div>
            );
        };

        const AddTransactionForm = ({ editingTransaction, setEditingTransaction, accounts, categories, handleAddTransaction, handleDeleteTransaction, setView }) => {
            const isEdit = !!editingTransaction;
            const isPending = editingTransaction && editingTransaction.isPending;
            const [form, setForm] = useState(editingTransaction ? {
                ...editingTransaction,
                id: isPending ? generateId() : editingTransaction.id,
                date: toInputDateTime(editingTransaction.date),
                ruleId: editingTransaction.ruleId // 確保 ruleId 有被帶入
            } : {
                 id: generateId(), type: 'expense', amount: '', date: toInputDateTime(new Date()),
                 categoryId: categories[0]?.id || '', accountId: accounts[0]?.id, toAccountId: accounts[1]?.id,
                 note: '', installments: 1, excludeFromBudget: false, verified: false
            });

            const handleSubmit = () => { if (!form.amount) return; handleAddTransaction({ ...form, amount: parseFloat(form.amount), date: new Date(form.date).toISOString(), installments: parseInt(form.installments) }, form.ruleId); }; // 傳入 ruleId
            return (
                <div className="fixed inset-0 bg-white z-50 p-4 overflow-y-auto">
                    <div className="flex justify-between items-center mb-4">
                        <button onClick={() => { setView('main'); setEditingTransaction(null); }}><Icon name="X"/></button>
                        <h2 className="font-bold">{isPending ? '確認週期性交易' : (editingTransaction ? '編輯交易' : '新增交易')}</h2>
                        {editingTransaction && !isPending ? <button onClick={() => handleDeleteTransaction(editingTransaction.id)} className="text-red-500"><Icon name="Trash2"/></button> : <div className="w-5"></div>}
                    </div>
                    <div className="space-y-4">
                        <div className="flex gap-2">{['expense','income','transfer'].map(t => (<button key={t} onClick={() => setForm({...form, type: t})} className={`flex-1 py-2 rounded-lg border ${form.type === t ? 'bg-slate-900 text-white' : 'bg-white'}`}>{t==='expense'?'支出':t==='income'?'收入':'轉帳'}</button>))}</div>
                        <input type="number" value={form.amount} onChange={e => setForm({...form, amount: e.target.value})} className="w-full text-4xl font-bold border-b p-2" placeholder="0" autoFocus />
                        {form.type !== 'transfer' && (<div className="flex flex-wrap gap-2 max-h-40 overflow-y-auto">{categories.filter(c => c.type === (form.type==='expense'?'expense':'income')).map(c => (<button key={c.id} onClick={() => setForm({...form, categoryId: c.id})} className={`p-2 border rounded-lg flex flex-col items-center ${form.categoryId === c.id ? 'bg-slate-100 border-slate-400' : ''}`}><span className="text-xl"><Icon name={c.icon} /></span><span className="text-xs">{c.name}</span></button>))}</div>)}
                        <div className="flex gap-2">
                            <div className="flex-1"><label className="text-xs text-slate-500">{form.type === 'transfer' ? '轉出' : '帳戶'}</label><select value={form.accountId} onChange={e => setForm({...form, accountId: e.target.value})} className="w-full p-2 border rounded">{accounts.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}</select></div>
                            {form.type === 'transfer' && (<div className="flex-1"><label className="text-xs text-slate-500">轉入</label><select value={form.toAccountId} onChange={e => setForm({...form, toAccountId: e.target.value})} className="w-full p-2 border rounded">{accounts.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}</select></div>)}
                        </div>
                        <input type="datetime-local" value={form.date} onChange={e => setForm({...form, date: e.target.value})} className="w-full p-2 border rounded" />
                        <div className="flex gap-2">
                             {!editingTransaction && form.type === 'expense' && accounts.find(a=>a.id===form.accountId)?.type === 'credit' && (<div className="w-1/3"><label className="text-xs text-slate-500">分期(月)</label><input type="number" min="1" value={form.installments} onChange={e => setForm({...form, installments: e.target.value})} className="w-full p-2 border rounded" /></div>)}
                             <div className="flex-1 flex items-center p-2 bg-slate-50 rounded border"><input type="checkbox" checked={form.excludeFromBudget} onChange={e => setForm({...form, excludeFromBudget: e.target.checked})} className="mr-2 h-5 w-5" /><span className="text-sm">不列入月預算</span></div>
                        </div>
                        <input type="text" value={form.note} onChange={e => setForm({...form, note: e.target.value})} className="w-full p-2 border rounded" placeholder="備註..." />
                        <button onClick={handleSubmit} className="w-full bg-slate-900 text-white py-3 rounded-xl font-bold mt-4">儲存</button>
                    </div>
                 </div>
            );
        };

        const StatsView = ({ statsPeriod, setStatsPeriod, customRange, setCustomRange, transactions, categories, setDrillDownData, setView, setEditingTransaction, accounts, handleToggleVerified }) => {
            const now = new Date();
            let start = new Date();
            let end = new Date();
            if (statsPeriod === 'day') { start = new Date(now.getFullYear(), now.getMonth(), now.getDate()); end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59); } 
            else if (statsPeriod === 'week') { const day = now.getDay(); const diff = now.getDate() - day + (day === 0 ? -6 : 1); start = new Date(now.setDate(diff)); start.setHours(0,0,0,0); end = new Date(start); end.setDate(start.getDate() + 6); end.setHours(23,59,59,999); } 
            else if (statsPeriod === 'month') { start = new Date(now.getFullYear(), now.getMonth(), 1); end = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59); } 
            else if (statsPeriod === 'year') { start = new Date(now.getFullYear(), 0, 1); end = new Date(now.getFullYear(), 11, 31, 23, 59, 59); } 
            else if (statsPeriod === 'custom') { start = safeDate(customRange.start); end = safeDate(customRange.end); end.setHours(23,59,59,999); }
            const filteredTx = transactions.filter(t => { const d = safeDate(t.date); return d >= start && d <= end && t.type === 'expense'; });
            const totalExpense = filteredTx.reduce((sum, t) => sum + t.amount, 0);
            const catStats = categories.filter(c => c.type === 'expense').map(c => { const txs = filteredTx.filter(t => t.categoryId === c.id); const sum = txs.reduce((s, t) => s + t.amount, 0); return { ...c, sum, txs }; }).filter(c => c.sum > 0).sort((a, b) => b.sum - a.sum);
            return (
                <div className="pb-24"><h2 className="text-xl font-bold mb-4">統計分析</h2><div className="flex bg-slate-200 p-1 rounded-lg mb-4 overflow-x-auto">{['day', 'week', 'month', 'year', 'custom'].map(p => (<button key={p} onClick={() => setStatsPeriod(p)} className={`flex-1 min-w-[50px] text-xs py-2 rounded-md capitalize whitespace-nowrap transition-all ${statsPeriod === p ? 'bg-white shadow-sm font-bold text-slate-800' : 'text-slate-500'}`}>{p === 'day' ? '今日' : p === 'week' ? '本週' : p === 'month' ? '本月' : p === 'year' ? '今年' : '自訂'}</button>))}</div>{statsPeriod === 'custom' && (<div className="bg-white p-3 rounded-xl mb-4 flex items-center gap-2 shadow-sm border border-slate-100"><input type="date" value={customRange.start} onChange={e => setCustomRange({...customRange, start: e.target.value})} className="flex-1 bg-slate-50 border-none rounded p-1 text-sm" /><span className="text-slate-400">to</span><input type="date" value={customRange.end} onChange={e => setCustomRange({...customRange, end: e.target.value})} className="flex-1 bg-slate-50 border-none rounded p-1 text-sm" /></div>)}<div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 text-center mb-6"><div className="text-slate-500 mb-1">總支出</div><div className="text-3xl font-bold text-slate-800">{formatCurrency(totalExpense)}</div><div className="text-xs text-slate-400 mt-2">{formatDateTime(start.toISOString())} ~ {formatDateTime(end.toISOString())}</div></div><div className="space-y-3">{catStats.map(c => (<div key={c.id} onClick={() => { setDrillDownData({ title: `${c.name} - 明細`, txList: c.txs }); setView('drill_down'); }} className="flex items-center gap-3 active:bg-slate-50 p-2 -mx-2 rounded-lg cursor-pointer"><div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm ${c.color}`}>{c.icon ? <Icon name={c.icon}/> : '🏷️'}</div><div className="flex-1"><div className="flex justify-between mb-1"><span className="text-sm font-medium">{c.name}</span><span className="text-sm font-bold flex items-center gap-1">{formatCurrency(c.sum)}<Icon name="ChevronRight" size={14} className="text-slate-300"/></span></div><div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden"><div className="h-full bg-slate-800 rounded-full" style={{ width: `${(c.sum / totalExpense) * 100}%` }}></div></div></div></div>))}{catStats.length === 0 && <div className="text-center text-slate-400 py-10">此區間無支出資料</div>}</div></div>
            );
        };

        const CategoryManager = ({ categories, setCategories, setView, showConfirm }) => {
            const [editingId, setEditingId] = useState(null);
            const [newCatName, setNewCatName] = useState('');
            const [newCatType, setNewCatType] = useState('expense');
            const [newCatIcon, setNewCatIcon] = useState('Tag');
            const [activeTab, setActiveTab] = useState('expense');

            useEffect(() => {
                if (editingId) {
                    const cat = categories.find(c => c.id === editingId);
                    if (cat) { setNewCatName(cat.name); setNewCatType(cat.type); setNewCatIcon(cat.icon); setActiveTab(cat.type); }
                } else { setNewCatName(''); setNewCatIcon('Tag'); }
            }, [editingId, categories]);

            const handleSave = () => {
                if(!newCatName) return;
                if (editingId) {
                    setCategories(prev => prev.map(c => c.id === editingId ? { ...c, name: newCatName, type: newCatType, icon: newCatIcon } : c));
                    setEditingId(null);
                } else {
                    setCategories(prev => [...prev, { id: generateId(), name: newCatName, type: newCatType, icon: newCatIcon, color: 'bg-slate-100 text-slate-600' }]);
                }
                setNewCatName('');
            };

            const handleDelete = (id) => { showConfirm('刪除類別', '確定刪除嗎？', () => { setCategories(prev => prev.filter(c => c.id !== id)); }); };
            const moveCategory = (id, direction) => {
                const currentTypeCats = categories.filter(c => c.type === activeTab);
                const currentIndexInType = currentTypeCats.findIndex(c => c.id === id);
                if (currentIndexInType === -1) return;
                let targetCat = null;
                if (direction === 'up' && currentIndexInType > 0) targetCat = currentTypeCats[currentIndexInType - 1];
                else if (direction === 'down' && currentIndexInType < currentTypeCats.length - 1) targetCat = currentTypeCats[currentIndexInType + 1];
                if (targetCat) {
                    const idx1 = categories.findIndex(c => c.id === id);
                    const idx2 = categories.findIndex(c => c.id === targetCat.id);
                    const newCategories = [...categories];
                    [newCategories[idx1], newCategories[idx2]] = [newCategories[idx2], newCategories[idx1]];
                    setCategories(newCategories);
                }
            };
            const displayCategories = categories.filter(c => c.type === activeTab);
            return (
                <div className="fixed inset-0 bg-white z-50 overflow-y-auto">
                    <div className="flex items-center p-4 border-b bg-white sticky top-0"><button onClick={() => setView('settings')}><Icon name="ChevronLeft"/></button><h2 className="flex-1 text-center font-bold">類別管理</h2></div>
                    <div className="p-4 space-y-4 pb-safe">
                        <div className="bg-slate-50 p-4 rounded-xl space-y-3 sticky top-16 z-10 shadow-sm border border-slate-200">
                            <h3 className="font-bold text-sm flex justify-between items-center">{editingId ? '編輯類別' : '新增類別'}{editingId && <button onClick={() => setEditingId(null)} className="text-xs text-blue-500">取消編輯</button>}</h3>
                            <div className="flex gap-2"><button onClick={() => { setNewCatType('expense'); setActiveTab('expense'); }} className={`flex-1 py-2 text-xs rounded-lg border transition-colors ${newCatType==='expense'?'bg-slate-900 text-white font-bold':'bg-white text-slate-500 border-slate-300'}`}>支出</button><button onClick={() => { setNewCatType('income'); setActiveTab('income'); }} className={`flex-1 py-2 text-xs rounded-lg border transition-colors ${newCatType==='income'?'bg-slate-900 text-white font-bold':'bg-white text-slate-500 border-slate-300'}`}>收入</button></div>
                            <div className="flex gap-2"><input value={newCatIcon} onChange={e => setNewCatIcon(e.target.value)} className="w-12 text-center p-2 rounded-lg border" placeholder="圖" /><input value={newCatName} onChange={e => setNewCatName(e.target.value)} className="flex-1 p-2 rounded-lg border" placeholder="類別名稱" /><button onClick={handleSave} className="bg-slate-900 text-white px-4 rounded-lg text-sm whitespace-nowrap">{editingId ? '更新' : '新增'}</button></div>
                        </div>
                        <div className="flex border-b border-slate-200"><button onClick={() => setActiveTab('expense')} className={`flex-1 py-3 text-sm font-bold border-b-2 ${activeTab === 'expense' ? 'border-slate-900 text-slate-900' : 'border-transparent text-slate-400'}`}>支出類別</button><button onClick={() => setActiveTab('income')} className={`flex-1 py-3 text-sm font-bold border-b-2 ${activeTab === 'income' ? 'border-slate-900 text-slate-900' : 'border-transparent text-slate-400'}`}>收入類別</button></div>
                        <div className="space-y-2">{displayCategories.map((c, index) => (<div key={c.id} className={`flex items-center justify-between p-3 border rounded-lg ${editingId === c.id ? 'bg-blue-50 border-blue-200' : 'bg-white border-slate-100'}`}><div className="flex items-center gap-3"><div className={`w-8 h-8 rounded-full flex items-center justify-center ${c.color}`}>{c.icon ? <Icon name={c.icon} size={16}/> : '🏷️'}</div><div><div className="text-sm font-medium">{c.name}</div></div></div><div className="flex items-center gap-1"><div className="flex flex-col mr-2"><button onClick={() => moveCategory(c.id, 'up')} className="text-slate-300 hover:text-slate-600 disabled:opacity-30" disabled={index === 0}><Icon name="ArrowUp" size={14}/></button><button onClick={() => moveCategory(c.id, 'down')} className="text-slate-300 hover:text-slate-600 disabled:opacity-30" disabled={index === displayCategories.length - 1}><Icon name="ArrowDown" size={14}/></button></div><button onClick={() => setEditingId(c.id)} className="text-slate-400 hover:text-blue-500 p-2"><Icon name="Pencil" size={16}/></button><button onClick={() => handleDelete(c.id)} className="text-slate-400 hover:text-red-500 p-2"><Icon name="Trash2" size={16}/></button></div></div>))}</div>
                    </div>
                </div>
            );
        };

        const RecurringManager = ({ recurringRules, setRecurringRules, setView, setEditingRecurring, handleToggleRecurring, handleDeleteRecurring }) => {
            const totalMonthly = (recurringRules || []).filter(r => r.active).reduce((sum, r) => sum + parseFloat(r.amount), 0);
            return (
                <div className="fixed inset-0 bg-white z-50 overflow-y-auto">
                    <div className="flex items-center p-4 border-b bg-white sticky top-0"><button onClick={() => setView('settings')}><Icon name="ChevronLeft"/></button><h2 className="flex-1 text-center font-bold">週期性帳務管理</h2><button onClick={() => { setEditingRecurring(null); setView('add_recurring'); }}><Icon name="Plus" className="text-blue-600"/></button></div>
                    <div className="p-4 pb-24">
                        <div className="bg-indigo-50 p-4 rounded-xl mb-6 flex justify-between items-center text-indigo-900"><span className="font-bold flex items-center gap-2"><Icon name="Repeat" size={16}/> 每月固定支出總和</span><span className="text-xl font-bold">{formatCurrency(totalMonthly)}</span></div>
                        <div className="space-y-3">{recurringRules.map(rule => (<div key={rule.id} onClick={() => { setEditingRecurring(rule); setView('add_recurring'); }} className={`p-4 rounded-xl border ${rule.active ? 'bg-white border-slate-200' : 'bg-slate-50 border-slate-100 opacity-70'} cursor-pointer active:bg-slate-50`}><div className="flex justify-between items-start mb-2"><div><div className="font-bold text-lg">{rule.note}</div><div className="text-xs text-slate-500">下次執行: {toInputDate(rule.nextDueDate)} | 剩餘: {rule.remainingCount === null ? '無限' : rule.remainingCount}</div></div><div className="font-bold text-slate-800">{formatCurrency(rule.amount)}</div></div><div className="flex justify-end gap-2 mt-2"><button onClick={(e) => { e.stopPropagation(); handleToggleRecurring(rule.id); }} className={`px-3 py-1 rounded-full text-xs font-bold ${rule.active ? 'bg-amber-100 text-amber-700' : 'bg-green-100 text-green-700'}`}>{rule.active ? '暫停' : '啟用'}</button><button onClick={(e) => { e.stopPropagation(); handleDeleteRecurring(rule.id); }} className="px-3 py-1 rounded-full text-xs font-bold bg-red-100 text-red-600">終止/刪除</button></div></div>))}</div>
                    </div>
                </div>
            );
        };

        const AddRecurringForm = ({ editingRecurring, handleUpdateRecurring, accounts, categories, setView }) => {
            const [form, setForm] = useState(() => {
                if (editingRecurring) {
                    return { 
                        ...editingRecurring, 
                        nextDueDate: toInputDate(editingRecurring.nextDueDate), 
                        remainingCount: editingRecurring.remainingCount === null ? '' : editingRecurring.remainingCount,
                        excludeFromBudget: editingRecurring.excludeFromBudget || false 
                    };
                }
                return { amount: '', categoryId: 'c11', accountId: accounts[0]?.id, note: '', nextDueDate: toInputDate(new Date()), remainingCount: '', excludeFromBudget: false };
            });
            const save = () => { if (!form.amount || !form.note) return; handleUpdateRecurring({ ...form, id: editingRecurring ? editingRecurring.id : undefined, type: 'expense', remainingCount: form.remainingCount === '' ? null : parseInt(form.remainingCount), nextDueDate: new Date(form.nextDueDate).toISOString() }); };
            return (
                <div className="fixed inset-0 bg-white z-[60] overflow-y-auto">
                    <div className="flex items-center p-4 border-b"><button onClick={() => setView('recurring_manager')}><Icon name="X"/></button><h2 className="flex-1 text-center font-bold">{editingRecurring ? '編輯週期性帳務' : '新增週期性帳務'}</h2><button onClick={save} className="text-blue-600 font-bold">儲存</button></div>
                    <div className="p-4 space-y-4">
                             <div><label className="text-xs text-slate-500">金額</label><input type="number" className="w-full p-3 bg-slate-50 rounded-lg mt-1" value={form.amount} onChange={e => setForm({...form, amount: e.target.value})} autoFocus /></div>
                             <div><label className="text-xs text-slate-500">名稱</label><input className="w-full p-3 bg-slate-50 rounded-lg mt-1" value={form.note} onChange={e => setForm({...form, note: e.target.value})} /></div>
                             <div><label className="text-xs text-slate-500">首次扣款日期</label><input type="date" className="w-full p-3 bg-slate-50 rounded-lg mt-1" value={form.nextDueDate} onChange={e => setForm({...form, nextDueDate: e.target.value})} /></div>
                             <div><label className="text-xs text-slate-500">循環次數 (留空為無限)</label><input type="number" className="w-full p-3 bg-slate-50 rounded-lg mt-1" placeholder="∞" value={form.remainingCount} onChange={e => setForm({...form, remainingCount: e.target.value})} /></div>
                             <div><label className="text-xs text-slate-500">扣款帳戶</label><select className="w-full p-3 bg-slate-50 rounded-lg mt-1" value={form.accountId} onChange={e => setForm({...form, accountId: e.target.value})}>{accounts.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}</select></div>
                             <div><label className="text-xs text-slate-500">類別</label><select className="w-full p-3 bg-slate-50 rounded-lg mt-1" value={form.categoryId} onChange={e => setForm({...form, categoryId: e.target.value})}>{categories.filter(c => c.type === 'expense').map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
                             <div className="flex items-center p-3 bg-slate-50 rounded-lg mt-1"><input type="checkbox" id="recurExclude" checked={form.excludeFromBudget} onChange={e => setForm({...form, excludeFromBudget: e.target.checked})} className="w-5 h-5 accent-slate-800 mr-3" /><label htmlFor="recurExclude" className="text-sm text-slate-700">不列入月預算</label></div>
                    </div>
                </div>
            );
        };

        const BudgetSettings = ({ budget, setBudget, setView }) => (
            <div className="fixed inset-0 bg-white z-50 overflow-y-auto">
                <div className="flex items-center p-4 border-b"><button onClick={() => setView('main')}><Icon name="X"/></button><h2 className="flex-1 text-center font-bold">預算設定</h2><button onClick={() => setView('main')} className="text-blue-600 font-bold">完成</button></div>
                <div className="p-4 space-y-6 pb-safe">
                    <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg"><span>啟用預算功能</span><input type="checkbox" checked={budget.enabled} onChange={e => setBudget({...budget, enabled: e.target.checked})} className="w-6 h-6 accent-blue-600"/></div>
                    {budget.enabled && (<><div className="flex flex-col gap-1"><label className="text-sm font-bold text-slate-700">每月預算金額</label><input type="number" value={budget.amount} onChange={e => setBudget({...budget, amount: parseFloat(e.target.value)})} className="w-full p-4 bg-slate-50 rounded-xl text-xl font-bold border border-slate-200"/></div><div className="flex flex-col gap-1"><label className="text-sm font-bold text-slate-700">預算起始日 (每月幾號)</label><input type="number" min="1" max="31" value={budget.resetDay} onChange={e => setBudget({...budget, resetDay: parseInt(e.target.value)})} className="w-full p-4 bg-slate-50 rounded-xl text-xl font-bold border border-slate-200"/></div></>)}
                </div>
            </div>
        );

        function MinimalistTracker() {
            const [activeTab, setActiveTab] = useState('home');
            const [view, setView] = useState('main');
            const [transactions, setTransactions] = useState([]);
            const [accounts, setAccounts] = useState(INITIAL_ACCOUNTS);
            const [categories, setCategories] = useState(INITIAL_CATEGORIES);
            const [budget, setBudget] = useState(INITIAL_BUDGET);
            const [recurringRules, setRecurringRules] = useState(INITIAL_RECURRING);
            const [selectedAccount, setSelectedAccount] = useState(null);
            const [editingTransaction, setEditingTransaction] = useState(null);
            const [drillDownData, setDrillDownData] = useState(null);
            const [currentViewDate, setCurrentViewDate] = useState(new Date());
            const [editingRecurring, setEditingRecurring] = useState(null);
            const [statsPeriod, setStatsPeriod] = useState('month'); 
            
            // 初始化時設定為當前月份的完整範圍
            const [customRange, setCustomRange] = useState({ start: toInputDate(), end: toInputDate() });
            const [exportRange, setExportRange] = useState(() => {
                const now = new Date();
                const start = new Date(now.getFullYear(), now.getMonth(), 1);
                const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                return { start: toInputDate(start), end: toInputDate(end) };
            });

            const [dialogConfig, setDialogConfig] = useState({ isOpen: false, type: 'confirm', title: '', message: '', onConfirm: () => {}, onCancel: () => {} });
            const showConfirm = (title, message, onConfirm) => { setDialogConfig({ isOpen: true, type: 'confirm', title, message, onConfirm: () => { setDialogConfig(prev => ({...prev, isOpen: false})); onConfirm(); }, onCancel: () => setDialogConfig(prev => ({...prev, isOpen: false})) }); };
            const showAlert = (title, message) => { setDialogConfig({ isOpen: true, type: 'alert', title, message, onConfirm: () => setDialogConfig(prev => ({...prev, isOpen: false})), onCancel: () => {} }); };
            const showPrompt = (title, message, defaultValue, onConfirm) => { setDialogConfig({ isOpen: true, type: 'prompt', title, message, defaultValue, onConfirm: (val) => { setDialogConfig(prev => ({...prev, isOpen: false})); onConfirm(val); }, onCancel: () => setDialogConfig(prev => ({...prev, isOpen: false})) }); };

            useEffect(() => {
                const savedTx = localStorage.getItem('minTrack_transactions');
                if (!savedTx) {
                    setTransactions(INITIAL_TRANSACTIONS);
                } else {
                    setTransactions(JSON.parse(savedTx));
                    setAccounts(JSON.parse(localStorage.getItem('minTrack_accounts')) || INITIAL_ACCOUNTS);
                    setCategories(JSON.parse(localStorage.getItem('minTrack_categories')) || INITIAL_CATEGORIES);
                    setBudget(JSON.parse(localStorage.getItem('minTrack_budget')) || INITIAL_BUDGET);
                    const savedRules = JSON.parse(localStorage.getItem('minTrack_recurring')) || INITIAL_RECURRING;
                    const savedTxs = JSON.parse(savedTx);
                    const { rules, txs, hasUpdates } = processRules(savedRules, savedTxs);
                    if (hasUpdates) {
                        setRecurringRules(rules);
                        setTransactions(txs);
                    } else {
                        setRecurringRules(savedRules);
                    }
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('minTrack_transactions', JSON.stringify(transactions));
                localStorage.setItem('minTrack_accounts', JSON.stringify(accounts));
                localStorage.setItem('minTrack_categories', JSON.stringify(categories));
                localStorage.setItem('minTrack_recurring', JSON.stringify(recurringRules));
            }, [transactions, accounts, categories, recurringRules]);

            useEffect(() => {
                 localStorage.setItem('minTrack_budget', JSON.stringify(budget));
            }, [budget]);

            const handleAddTransaction = (data, ruleId) => {
                 setTransactions(prev => {
                     let newTxs = [...prev];
                     // 處理 pending 轉正：如果 id 是 pending- 開頭的，就代表是新的一筆
                     // 我們已經在 Form 裡面處理了 id 的生成，所以這裡只要判斷 id 是否存在即可
                     if (data.id && prev.find(t=>t.id===data.id)) {
                         newTxs = newTxs.map(t => t.id === data.id ? data : t);
                     } else {
                         newTxs.push(data);
                         if(data.installments > 1 && data.type === 'expense') {
                             const base = Math.floor(data.amount / data.installments);
                             const start = new Date(data.date);
                             for(let i=1; i<data.installments; i++) {
                                 const d = new Date(start); d.setMonth(d.getMonth() + i);
                                 newTxs.push({...data, id: generateId(), amount: base, date: d.toISOString(), note: `${data.note} (${i+1}/${data.installments})`, installments: 1});
                             }
                             data.amount = base + (data.amount % data.installments);
                             data.note = `${data.note} (1/${data.installments})`;
                         }
                     }
                     return newTxs;
                 });

                 // 如果是確認週期性交易 (ruleId 存在)，更新規則的下次執行日
                 if (ruleId) {
                     setRecurringRules(prev => prev.map(rule => {
                         if (rule.id === ruleId) {
                             const nextDate = new Date(rule.nextDueDate);
                             nextDate.setMonth(nextDate.getMonth() + 1); // 往後推一個月
                             
                             let newCount = rule.remainingCount;
                             if (newCount !== null) newCount = Math.max(0, newCount - 1);
                             
                             return {
                                 ...rule,
                                 nextDueDate: nextDate.toISOString(),
                                 remainingCount: newCount
                             };
                         }
                         return rule;
                     }));
                 }

                 setView('main');
                 setEditingTransaction(null);
            };

            const handleDeleteTransaction = (id) => {
                showConfirm('刪除交易', '確定刪除？', () => {
                    setTransactions(prev => prev.filter(t => t.id !== id && t.relatedTxId !== id));
                    setView('main');
                });
            };
            
            const handleUpdateAccount = (acc) => {
                if(acc.isNew) { const {isNew, ...rest} = acc; setAccounts(prev => [...prev, {...rest, id: generateId()}]); }
                else { setAccounts(prev => prev.map(a => a.id === acc.id ? acc : a)); }
            };

            const handleDeleteAccount = (id) => {
                if(Math.abs(calculateAccountBalance(accounts.find(a=>a.id===id), transactions)) > 0) return showAlert('錯誤', '帳戶仍有餘額');
                showConfirm('刪除', '確定刪除帳戶？', () => { setAccounts(prev => prev.filter(a=>a.id!==id)); setView('main'); });
            };

            const handleToggleVerified = (id) => setTransactions(prev => prev.map(t => t.id === id ? { ...t, verified: !t.verified } : t));

            const handleUpdateRecurring = (rule) => {
                 setRecurringRules(prev => {
                     let newRules;
                     if (rule.id) newRules = prev.map(r => r.id === rule.id ? rule : r);
                     else newRules = [...prev, {...rule, id: generateId(), active: true}];
                     
                     const updatedRule = rule.id ? rule : newRules[newRules.length - 1];
                     const { txs: processedTx } = processRules([updatedRule], transactions);
                     if (processedTx.length > transactions.length) {
                         setTransactions(processedTx);
                     }
                     return newRules;
                 });
                 setView('recurring_manager');
            };

            const handleToggleRecurring = (id) => {
                setRecurringRules(prev => {
                    const newRules = prev.map(r => r.id === id ? { ...r, active: !r.active } : r);
                    const rule = newRules.find(r => r.id === id);
                    if (rule && rule.active) {
                         const { txs: processedTx } = processRules([rule], transactions);
                         if (processedTx.length > transactions.length) {
                             setTransactions(processedTx);
                         }
                    }
                    return newRules;
                });
            };
            
            const handleDeleteRecurring = (id) => showConfirm('刪除', '確定刪除？', () => setRecurringRules(prev => prev.filter(r => r.id !== id)));

            const handleExportJSON = () => {
                const data = { transactions, accounts, categories, budget, recurringRules };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `backup_${new Date().toISOString().split('T')[0]}.json`; a.click();
            };

            const handleImportJSON = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if(data.transactions) setTransactions(data.transactions);
                        if(data.accounts) setAccounts(data.accounts);
                        if(data.categories) setCategories(data.categories);
                        if(data.budget) setBudget(data.budget);
                        if(data.recurringRules) setRecurringRules(data.recurringRules);
                        showAlert('成功', '資料已還原');
                    } catch (err) { showAlert('錯誤', '檔案格式不正確'); }
                };
                reader.readAsText(file);
            };

            const exportCSV = () => {
                 const typeMap = { 'expense': '支出', 'income': '收入', 'transfer': '轉帳' };
                 
                 // 1. 既有交易 (需過濾日期)
                 const start = safeDate(exportRange.start);
                 const end = safeDate(exportRange.end);
                 end.setHours(23, 59, 59, 999); 

                 const realRows = transactions
                    .filter(t => {
                        const d = safeDate(t.date);
                        return d >= start && d <= end;
                    })
                    .map(t => {
                     const catName = categories.find(c => c.id === t.categoryId)?.name || '未分類';
                     const accName = accounts.find(a => a.id === t.accountId)?.name || '未知';
                     const typeName = typeMap[t.type] || t.type;
                     const verifiedStr = t.verified ? '是' : '否';
                     const includedInBudgetStr = t.excludeFromBudget ? '否' : '是';
                     const cleanNote = (t.note || '').replace(/,/g, ' ').replace(/\n/g, ' ');
                     return `${t.id},${t.date},${typeName},${t.amount},${catName},${accName},${cleanNote},${verifiedStr},${includedInBudgetStr}`;
                 });

                 // 2. 範圍內的預估固定支出
                 const pendingRows = [];
                 recurringRules.forEach(rule => {
                    if (!rule.active) return;
                    let nextDate = safeDate(rule.nextDueDate);
                    let safety = 0;
                    while(nextDate <= end && safety < 1000) {
                        if (nextDate >= start) {
                            const catName = categories.find(c => c.id === rule.categoryId)?.name || '未分類';
                            const accName = accounts.find(a => a.id === rule.accountId)?.name || '未知';
                            const typeName = typeMap[rule.type] || rule.type;
                            const cleanNote = `[預估] ${rule.note}`.replace(/,/g, ' ');
                            const includedInBudgetStr = rule.excludeFromBudget ? '否' : '是';
                            const tempId = `pending_${rule.id}_${toInputDate(nextDate)}`;
                            pendingRows.push(`${tempId},${toInputDate(nextDate)},${typeName},${rule.amount},${catName},${accName},${cleanNote},否,${includedInBudgetStr}`);
                        }
                        nextDate = new Date(nextDate); 
                        nextDate.setMonth(nextDate.getMonth() + 1);
                        safety++;
                    }
                 });
                 
                 const header = "ID,日期,類型,金額,類別,帳戶,備註,已確認,納入預算";
                 const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + [header, ...realRows, ...pendingRows].join('\n');
                 const link = document.createElement("a"); link.href = encodeURI(csvContent); link.download = `記帳資料_${new Date().toISOString().split('T')[0]}.csv`; document.body.appendChild(link); link.click();
            };

            const handleImportCSV = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n');
                        const newTxs = [];
                        let updatedCount = 0;
                        let createdCount = 0;
                        
                        const typeMapRev = { '支出': 'expense', '收入': 'income', '轉帳': 'transfer' };

                        for(let i=1; i<lines.length; i++) {
                            const line = lines[i].trim();
                            if(!line) continue;
                            const cols = line.split(',');
                            if(cols.length < 8) continue; 
                            
                            const [id, date, typeName, amount, catName, accName, note, verifiedStr, includedInBudgetStr] = cols;
                            
                            const type = typeMapRev[typeName] || 'expense'; 
                            const cat = categories.find(c => c.name === catName);
                            const acc = accounts.find(a => a.name === accName);
                            const isExcluded = includedInBudgetStr ? (includedInBudgetStr.trim() === '否') : false;

                            if(acc) {
                                newTxs.push({
                                    // 修正 ID 判斷：只要 id 有值就使用，不再限制長度，確保短 ID (如 t1) 能正確覆蓋
                                    id: id && id.trim() ? id.trim() : generateId(),
                                    date: date,
                                    type: type,
                                    amount: parseFloat(amount),
                                    categoryId: cat ? cat.id : (categories[0]?.id || ''),
                                    accountId: acc.id,
                                    note: note,
                                    verified: verifiedStr === '是',
                                    installments: 1, 
                                    excludeFromBudget: isExcluded
                                });
                            }
                        }

                        if(newTxs.length === 0) return showAlert('錯誤', '找不到有效資料或格式不符');

                        setTransactions(prev => {
                            const merged = [...prev];
                            newTxs.forEach(newTx => {
                                const idx = merged.findIndex(t => t.id === newTx.id);
                                if(idx >= 0) {
                                    merged[idx] = newTx; 
                                    updatedCount++;
                                } else {
                                    merged.push(newTx); 
                                    createdCount++;
                                }
                            });
                            return merged;
                        });
                        showAlert('匯入成功', `更新: ${updatedCount} 筆\n新增: ${createdCount} 筆`);
                    } catch (err) { showAlert('錯誤', 'CSV 格式不正確'); console.error(err); }
                };
                reader.readAsText(file);
            };

            return (
                <div className="max-w-md mx-auto bg-slate-50 min-h-screen relative font-sans text-slate-800">
                    <div className="p-4 flex items-center justify-center bg-white border-b sticky top-0 z-20"><h1 className="font-bold text-lg">極簡記帳 (專業版)</h1></div>
                    <div className="p-4 min-h-[80vh]">
                        {activeTab === 'home' && <DashboardView currentViewDate={currentViewDate} setCurrentViewDate={setCurrentViewDate} transactions={transactions} accounts={accounts} budget={budget} recurringRules={recurringRules} setActiveTab={setActiveTab} setDrillDownData={setDrillDownData} setView={setView} setEditingTransaction={setEditingTransaction} categories={categories} handleToggleVerified={handleToggleVerified} />}
                        {activeTab === 'accounts' && <AccountsList accounts={accounts} setAccounts={setAccounts} transactions={transactions} setView={setView} setSelectedAccount={setSelectedAccount} />}
                        {activeTab === 'stats' && <StatsView statsPeriod={statsPeriod} setStatsPeriod={setStatsPeriod} customRange={customRange} setCustomRange={setCustomRange} transactions={transactions} categories={categories} setDrillDownData={setDrillDownData} setView={setView} setEditingTransaction={setEditingTransaction} accounts={accounts} handleToggleVerified={handleToggleVerified} />}
                        {activeTab === 'settings' && <SettingsView setView={setView} exportRange={exportRange} setExportRange={setExportRange} exportCSV={exportCSV} handleImportCSV={handleImportCSV} handleExportJSON={handleExportJSON} handleImportJSON={handleImportJSON} />}
                    </div>
                    <div className="fixed bottom-0 left-0 w-full bg-white border-t flex justify-around items-center p-2 pb-safe z-30">
                        <button onClick={() => setActiveTab('home')} className={`p-2 flex flex-col items-center ${activeTab==='home'?'text-slate-900':'text-slate-400'}`}><Icon name="Home"/><span className="text-[10px]">總覽</span></button>
                        <button onClick={() => setActiveTab('accounts')} className={`p-2 flex flex-col items-center ${activeTab==='accounts'?'text-slate-900':'text-slate-400'}`}><Icon name="CreditCard"/><span className="text-[10px]">帳戶</span></button>
                        <button onClick={() => { setEditingTransaction(null); setView('add_transaction'); }} className="bg-slate-900 text-white rounded-full w-12 h-12 flex items-center justify-center -mt-6 shadow-lg"><Icon name="Plus" size={24}/></button>
                        <button onClick={() => setActiveTab('stats')} className={`p-2 flex flex-col items-center ${activeTab==='stats'?'text-slate-900':'text-slate-400'}`}><Icon name="PieChart"/><span className="text-[10px]">統計</span></button>
                        <button onClick={() => setActiveTab('settings')} className={`p-2 flex flex-col items-center ${activeTab==='settings'?'text-slate-900':'text-slate-400'}`}><Icon name="Settings"/><span className="text-[10px]">設定</span></button>
                    </div>

                    <CustomDialog isOpen={dialogConfig.isOpen} type={dialogConfig.type} title={dialogConfig.title} message={dialogConfig.message} onConfirm={dialogConfig.onConfirm} onCancel={dialogConfig.onCancel} defaultValue={dialogConfig.defaultValue} />

                    {view === 'add_transaction' && <div className="fixed inset-0 z-40 bg-white"><AddTransactionForm editingTransaction={editingTransaction} setEditingTransaction={setEditingTransaction} accounts={accounts} categories={categories} handleAddTransaction={handleAddTransaction} handleDeleteTransaction={handleDeleteTransaction} setView={setView} /></div>}
                    {view === 'add_recurring' && <div className="fixed inset-0 z-40 bg-white"><AddRecurringForm editingRecurring={editingRecurring} handleUpdateRecurring={handleUpdateRecurring} accounts={accounts} categories={categories} setView={setView} /></div>}
                    {view === 'account_detail' && <div className="fixed inset-0 z-40 bg-white"><AccountDetail selectedAccount={selectedAccount} accounts={accounts} transactions={transactions} setView={setView} setEditingTransaction={setEditingTransaction} showPrompt={showPrompt} showAlert={showAlert} showConfirm={showConfirm} handleAddTransaction={handleAddTransaction} categories={categories} handleToggleVerified={handleToggleVerified} calculateAccountBalance={calculateAccountBalance} /></div>}
                    {view === 'edit_account' && <div className="fixed inset-0 z-40 bg-white"><AccountEditForm initialData={selectedAccount} onClose={() => setView('main')} handleUpdateAccount={handleUpdateAccount} handleDeleteAccount={handleDeleteAccount} /></div>}
                    {view === 'drill_down' && <div className="fixed inset-0 z-40 bg-white"><DrillDownView title={drillDownData?.title} txList={drillDownData?.txList || []} setView={setView} setEditingTransaction={setEditingTransaction} categories={categories} accounts={accounts} handleToggleVerified={handleToggleVerified} /></div>}
                    {view === 'category_manager' && <div className="fixed inset-0 z-40 bg-white"><CategoryManager categories={categories} setCategories={setCategories} setView={setView} showConfirm={showConfirm} /></div>}
                    {view === 'recurring_manager' && <div className="fixed inset-0 z-40 bg-white"><RecurringManager recurringRules={recurringRules} setRecurringRules={setRecurringRules} setView={setView} setEditingRecurring={setEditingRecurring} handleToggleRecurring={handleToggleRecurring} handleDeleteRecurring={handleDeleteRecurring} /></div>}
                    {view === 'budget_settings' && <div className="fixed inset-0 z-40 bg-white"><BudgetSettings budget={budget} setBudget={setBudget} setView={setView} /></div>}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MinimalistTracker />);
    </script>
</body>
</html>


