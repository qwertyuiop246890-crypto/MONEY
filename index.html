import React, { useState, useEffect, useRef } from 'react';
import { 
  Plus, Home, PieChart, CreditCard, Settings, 
  ChevronLeft, ChevronRight, Save, Trash2, 
  ArrowRightLeft, Upload, Download, CheckCircle,
  Calendar, DollarSign, ListFilter, Edit2, X, 
  AlertCircle, Target, Filter, Clock, Repeat, Ban,
  Layers, Tag, CheckSquare, Square, Pencil, AlertTriangle
} from 'lucide-react';

// --- å·¥å…·å‡½æ•¸ ---

const generateId = () => Math.random().toString(36).substr(2, 9);

const formatDateTime = (isoString) => {
  if (!isoString) return '';
  const d = new Date(isoString);
  if (isNaN(d.getTime())) return '';
  const datePart = d.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
  const timePart = d.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });
  return `${datePart} ${timePart}`;
};

const formatMonth = (date) => {
    return date.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long' });
};

const toInputDate = (isoString) => {
    if (!isoString) return new Date().toISOString().split('T')[0];
    return new Date(isoString).toISOString().split('T')[0];
};

const toInputDateTime = (isoString) => {
    const d = isoString ? new Date(isoString) : new Date();
    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
    return d.toISOString().slice(0, 16);
};

const formatCurrency = (amount) => {
  return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(amount);
};

const getMonthRange = (date) => {
  const y = date.getFullYear();
  const m = date.getMonth();
  const firstDay = new Date(y, m, 1);
  const lastDay = new Date(y, m + 1, 0, 23, 59, 59, 999);
  return { firstDay, lastDay };
};

const getAccountCycleRange = (viewDate, startDay = 1) => {
    const y = viewDate.getFullYear();
    const m = viewDate.getMonth();
    
    if (startDay === 1) {
        const start = new Date(y, m, 1);
        const end = new Date(y, m + 1, 0, 23, 59, 59, 999);
        return { start, end, label: formatMonth(viewDate) };
    }

    const start = new Date(y, m, startDay);
    const end = new Date(y, m + 1, startDay - 1, 23, 59, 59, 999);
    const label = `${start.getMonth()+1}/${start.getDate()} - ${end.getMonth()+1}/${end.getDate()}`;
    return { start, end, label };
};

const getBudgetRange = (currentViewDate, resetDay = 1) => {
    return getAccountCycleRange(currentViewDate, resetDay);
};

// --- åˆå§‹è³‡æ–™ ---

const INITIAL_CATEGORIES = [
  { id: 'c1', name: 'é¤é£²', type: 'expense', icon: 'ğŸ”', color: 'bg-orange-100 text-orange-600' },
  { id: 'c2', name: 'äº¤é€š', type: 'expense', icon: 'ğŸšŒ', color: 'bg-blue-100 text-blue-600' },
  { id: 'c3', name: 'è³¼ç‰©', type: 'expense', icon: 'ğŸ›ï¸', color: 'bg-pink-100 text-pink-600' },
  { id: 'c4', name: 'å¨›æ¨‚', type: 'expense', icon: 'ğŸ®', color: 'bg-purple-100 text-purple-600' },
  { id: 'c5', name: 'å±…ä½', type: 'expense', icon: 'ğŸ ', color: 'bg-green-100 text-green-600' },
  { id: 'c9', name: 'å¸³å‹™èª¿æ•´', type: 'expense', icon: 'ğŸ”§', color: 'bg-gray-100 text-gray-600' },
  { id: 'c11', name: 'è¨‚é–±/é€±æœŸ', type: 'expense', icon: 'ğŸ”„', color: 'bg-indigo-100 text-indigo-600' },
  { id: 'c6', name: 'è–ªè³‡', type: 'income', icon: 'ğŸ’°', color: 'bg-yellow-100 text-yellow-600' },
  { id: 'c7', name: 'çé‡‘', type: 'income', icon: 'ğŸ’', color: 'bg-teal-100 text-teal-600' },
  { id: 'c8', name: 'æŠ•è³‡', type: 'income', icon: 'ğŸ“ˆ', color: 'bg-red-100 text-red-600' },
  { id: 'c10', name: 'å¸³å‹™èª¿æ•´', type: 'income', icon: 'ğŸ”§', color: 'bg-gray-100 text-gray-600' },
];

const INITIAL_ACCOUNTS = [
  { id: 'a1', name: 'éŒ¢åŒ…ç¾é‡‘', type: 'cash', balance: 0, initialBalance: 0 },
  { id: 'a2', name: 'è–ªè³‡å¸³æˆ¶', type: 'bank', balance: 0, initialBalance: 0 },
];

const INITIAL_BUDGET = { amount: 0, resetDay: 1, enabled: false };

// --- å…±ç”¨å°è©±æ¡†çµ„ä»¶ ---
const CustomDialog = ({ isOpen, type, title, message, onConfirm, onCancel, defaultValue = '' }) => {
    const [inputValue, setInputValue] = useState(defaultValue);
    
    useEffect(() => {
        if (isOpen) setInputValue(defaultValue);
    }, [isOpen, defaultValue]);

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
            <div className="bg-white rounded-2xl shadow-xl w-full max-w-xs overflow-hidden animate-in fade-in zoom-in duration-200">
                <div className="p-5 text-center">
                    {type === 'alert' && <AlertCircle className="mx-auto text-red-500 mb-3" size={40} />}
                    {type === 'confirm' && <AlertTriangle className="mx-auto text-amber-500 mb-3" size={40} />}
                    {type === 'prompt' && <Edit2 className="mx-auto text-blue-500 mb-3" size={40} />}
                    
                    <h3 className="font-bold text-lg text-slate-800 mb-2">{title}</h3>
                    <p className="text-sm text-slate-500 mb-4">{message}</p>
                    
                    {type === 'prompt' && (
                        <input 
                            type="number" 
                            className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl mb-4 text-center font-bold text-lg"
                            value={inputValue}
                            onChange={(e) => setInputValue(e.target.value)}
                            autoFocus
                        />
                    )}

                    <div className="flex gap-2 justify-center">
                        {type !== 'alert' && (
                            <button 
                                onClick={onCancel}
                                className="flex-1 py-3 px-4 rounded-xl bg-slate-100 text-slate-600 font-bold active:bg-slate-200 transition-colors"
                            >
                                å–æ¶ˆ
                            </button>
                        )}
                        <button 
                            onClick={() => onConfirm(type === 'prompt' ? inputValue : undefined)}
                            className={`flex-1 py-3 px-4 rounded-xl font-bold text-white shadow-lg active:scale-95 transition-transform ${type === 'alert' ? 'bg-red-500' : 'bg-slate-900'}`}
                        >
                            ç¢ºå®š
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
};

// --- ä¸»ç¨‹å¼ ---

export default function MinimalistTracker() {
  const [activeTab, setActiveTab] = useState('home');
  const [transactions, setTransactions] = useState([]);
  const [accounts, setAccounts] = useState(INITIAL_ACCOUNTS);
  const [categories, setCategories] = useState(INITIAL_CATEGORIES);
  const [budget, setBudget] = useState(INITIAL_BUDGET);
  const [recurringRules, setRecurringRules] = useState([]);

  // View Routing
  const [view, setView] = useState('main'); 
  const [selectedAccount, setSelectedAccount] = useState(null);
  const [editingTransaction, setEditingTransaction] = useState(null);
  const [drillDownData, setDrillDownData] = useState(null);
  const [editingRecurring, setEditingRecurring] = useState(null); 
  const [currentViewDate, setCurrentViewDate] = useState(new Date());
  const [statsPeriod, setStatsPeriod] = useState('month'); 
  const [customRange, setCustomRange] = useState({ start: toInputDate(), end: toInputDate() });

  // Dialog State
  const [dialogConfig, setDialogConfig] = useState({
      isOpen: false,
      type: 'confirm', // confirm, alert, prompt
      title: '',
      message: '',
      onConfirm: () => {},
      onCancel: () => {},
      defaultValue: ''
  });

  // Dialog Helpers
  const showConfirm = (title, message, onConfirm) => {
      setDialogConfig({
          isOpen: true,
          type: 'confirm',
          title,
          message,
          onConfirm: () => { setDialogConfig(prev => ({...prev, isOpen: false})); onConfirm(); },
          onCancel: () => setDialogConfig(prev => ({...prev, isOpen: false}))
      });
  };

  const showAlert = (title, message) => {
      setDialogConfig({
          isOpen: true,
          type: 'alert',
          title,
          message,
          onConfirm: () => setDialogConfig(prev => ({...prev, isOpen: false})),
          onCancel: () => {}
      });
  };

  const showPrompt = (title, message, defaultValue, onConfirm) => {
      setDialogConfig({
          isOpen: true,
          type: 'prompt',
          title,
          message,
          defaultValue,
          onConfirm: (val) => { setDialogConfig(prev => ({...prev, isOpen: false})); onConfirm(val); },
          onCancel: () => setDialogConfig(prev => ({...prev, isOpen: false}))
      });
  };

  // Load Data
  useEffect(() => {
    const savedTx = localStorage.getItem('minTrack_transactions');
    const savedAcc = localStorage.getItem('minTrack_accounts');
    const savedCat = localStorage.getItem('minTrack_categories');
    const savedBudget = localStorage.getItem('minTrack_budget');
    const savedRecurring = localStorage.getItem('minTrack_recurring');
    
    let loadedTx = savedTx ? JSON.parse(savedTx) : [];
    let loadedRecurring = savedRecurring ? JSON.parse(savedRecurring) : [];

    if (savedAcc) setAccounts(JSON.parse(savedAcc));
    if (savedCat) setCategories(JSON.parse(savedCat));
    if (savedBudget) setBudget(JSON.parse(savedBudget));
    
    const now = new Date();
    let newTxList = [...loadedTx];
    let hasUpdates = false;

    const updatedRules = loadedRecurring.map(rule => {
        if (!rule.active) return rule;
        let ruleUpdated = false;
        let nextDate = new Date(rule.nextDueDate);
        let count = rule.remainingCount;

        while (nextDate <= now && (count === null || count > 0)) {
            const newTx = {
                id: generateId(),
                type: rule.type,
                amount: parseFloat(rule.amount),
                date: nextDate.toISOString(),
                categoryId: rule.categoryId,
                accountId: rule.accountId,
                note: `[é€±æœŸ] ${rule.note}`,
                installments: 1,
                excludeFromBudget: false
            };
            newTxList.push(newTx);
            nextDate.setMonth(nextDate.getMonth() + 1);
            if (count !== null) count--;
            hasUpdates = true;
            ruleUpdated = true;
        }

        if (ruleUpdated) {
            if (count === 0) return { ...rule, nextDueDate: nextDate.toISOString(), remainingCount: 0, active: false };
            return { ...rule, nextDueDate: nextDate.toISOString(), remainingCount: count };
        }
        return rule;
    });

    if (hasUpdates || !savedTx) {
        setTransactions(newTxList);
        setRecurringRules(updatedRules);
    } else {
        setTransactions(loadedTx);
        setRecurringRules(loadedRecurring);
    }
  }, []);

  useEffect(() => {
    localStorage.setItem('minTrack_transactions', JSON.stringify(transactions));
    localStorage.setItem('minTrack_accounts', JSON.stringify(accounts));
    localStorage.setItem('minTrack_categories', JSON.stringify(categories));
    localStorage.setItem('minTrack_budget', JSON.stringify(budget));
    localStorage.setItem('minTrack_recurring', JSON.stringify(recurringRules));
  }, [transactions, accounts, categories, budget, recurringRules]);

  // Logic Functions
  const getAccountBalance = (accountId) => {
    const account = accounts.find(a => a.id === accountId);
    if (!account) return 0;
    
    let balance = parseFloat(account.initialBalance || 0);

    transactions.forEach(t => {
      const amount = parseFloat(t.amount);
      if (t.accountId === accountId) {
        if (t.type === 'expense') balance -= amount;
        if (t.type === 'income') balance += amount;
        if (t.type === 'transfer_out') balance -= amount;
      }
      if (t.toAccountId === accountId && t.type === 'transfer_in') {
        balance += amount;
      }
    });
    return balance;
  };

  const handleAddTransaction = (data) => {
    const newTxList = [...transactions];
    const isEdit = !!data.id;
    const account = accounts.find(a => a.id === data.accountId);
    const isCredit = account?.type === 'credit';

    if (!isEdit && data.installments > 1 && data.type === 'expense' && isCredit) {
        const total = parseFloat(data.amount);
        const count = parseInt(data.installments);
        const baseAmount = Math.floor(total / count);
        const remainder = total % count;
        const startDate = new Date(data.date); 

        for (let i = 0; i < count; i++) {
            const amount = i === 0 ? baseAmount + remainder : baseAmount;
            const txDate = new Date(startDate);
            txDate.setMonth(startDate.getMonth() + i);
            
            newTxList.push({
                ...data,
                id: generateId(),
                amount: amount,
                date: txDate.toISOString(),
                note: `${data.note} (åˆ†æœŸ ${i+1}/${count})`,
                isInstallmentChild: true,
                installments: 1
            });
        }
    } else {
        if (isEdit) {
            const index = newTxList.findIndex(t => t.id === data.id);
            if (index !== -1) newTxList[index] = data;
            if (data.relatedTxId) {
                const relatedIndex = newTxList.findIndex(t => t.id === data.relatedTxId);
                if (relatedIndex !== -1) {
                    newTxList[relatedIndex] = {
                        ...newTxList[relatedIndex],
                        amount: data.amount,
                        date: data.date,
                        note: data.note
                    };
                }
            }
        } else {
            const mainId = generateId();
            if (data.type === 'transfer') {
                const outTx = { ...data, id: mainId, type: 'transfer_out', relatedTxId: mainId + '_in' };
                const inTx = { 
                    ...data, 
                    id: mainId + '_in', 
                    type: 'transfer_in', 
                    accountId: data.toAccountId, 
                    toAccountId: null, 
                    relatedTxId: mainId 
                };
                newTxList.push(outTx, inTx);
            } else {
                newTxList.push({ ...data, id: mainId });
            }
        }
    }

    setTransactions(newTxList);
    setView('main');
    setEditingTransaction(null);
  };

  const handleToggleVerified = (txId) => {
      setTransactions(transactions.map(t => 
          t.id === txId ? { ...t, verified: !t.verified } : t
      ));
  };

  const handleUpdateRecurring = (rule) => {
      let newRules = [...recurringRules];
      if (rule.id) {
          newRules = newRules.map(r => r.id === rule.id ? rule : r);
      } else {
          newRules.push({ ...rule, id: generateId(), active: true });
      }
      setRecurringRules(newRules);
      setView('recurring_manager');
  };

  const handleToggleRecurring = (id) => setRecurringRules(recurringRules.map(r => r.id === id ? { ...r, active: !r.active } : r));
  const handleDeleteRecurring = (id) => { 
      showConfirm('åˆªé™¤é€±æœŸæ€§è¨­å®š', 'ç¢ºå®šè¦åˆªé™¤æ­¤è¨­å®šå—ï¼Ÿå·²ç”¢ç”Ÿçš„äº¤æ˜“ä¸æœƒæ¶ˆå¤±ã€‚', () => {
          setRecurringRules(recurringRules.filter(r => r.id !== id)); 
      });
  };

  const handleDeleteTransaction = (id) => {
    showConfirm('åˆªé™¤äº¤æ˜“', 'ç¢ºå®šè¦åˆªé™¤æ­¤ç­†äº¤æ˜“å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚', () => {
        const tx = transactions.find(t => t.id === id);
        if (!tx) return;
        let newTxList = transactions.filter(t => t.id !== id);
        if (tx.relatedTxId) newTxList = newTxList.filter(t => t.id !== tx.relatedTxId);
        setTransactions(newTxList);
        setView('main');
    });
  };

  const handleUpdateAccount = (updatedAccount) => {
    if (updatedAccount.isNew) {
        const { isNew, ...rest } = updatedAccount;
        setAccounts([...accounts, { ...rest, id: generateId() }]);
    } else {
        setAccounts(accounts.map(a => a.id === updatedAccount.id ? updatedAccount : a));
    }
  };

  const handleDeleteAccount = (id) => {
      if (Math.abs(getAccountBalance(id)) > 0) return showAlert('ç„¡æ³•åˆªé™¤', 'è©²å¸³æˆ¶ä»æœ‰é¤˜é¡ï¼Œè«‹å…ˆæ¸…ç©ºæˆ–è½‰ç§»é¤˜é¡å¾Œå†åˆªé™¤ã€‚');
      showConfirm('åˆªé™¤å¸³æˆ¶', 'ç¢ºå®šè¦åˆªé™¤æ­¤å¸³æˆ¶å—ï¼Ÿæ­·å²äº¤æ˜“ç´€éŒ„å°‡æœƒä¿ç•™ï¼Œä½†ç„¡æ³•å†é¸æ“‡æ­¤å¸³æˆ¶ã€‚', () => {
        setAccounts(accounts.filter(a => a.id !== id));
        if (selectedAccount?.id === id) setSelectedAccount(null);
        setView('main');
      });
  };

  const handleAddCategory = (newCat) => {
      setCategories([...categories, { ...newCat, id: generateId() }]);
  };

  const handleEditCategory = (updatedCat) => {
      setCategories(categories.map(c => c.id === updatedCat.id ? updatedCat : c));
  };
  
  const handleDeleteCategory = (id) => {
      showConfirm('åˆªé™¤é¡åˆ¥', 'åˆªé™¤é¡åˆ¥å¾Œï¼Œä½¿ç”¨æ­¤é¡åˆ¥çš„èˆŠäº¤æ˜“å°‡é¡¯ç¤ºç‚ºæœªåˆ†é¡ï¼Œç¢ºå®šå—ï¼Ÿ', () => {
          setCategories(categories.filter(c => c.id !== id));
      });
  };

  // --- CSV Import/Export ---

  const exportCSV = () => {
    const headers = ['ID,æ—¥æœŸæ™‚é–“,é¡å‹,é‡‘é¡,å¸³æˆ¶ID,é¡åˆ¥,å‚™è¨»,æ’é™¤é ç®—,å°å¸³ç¢ºèª'];
    const rows = transactions.map(t => 
      `${t.id},${t.date},${t.type},${t.amount},${t.accountId},${categories.find(c=>c.id===t.categoryId)?.name || ''},${t.note || ''},${t.excludeFromBudget?'Yes':'No'},${t.verified?'Yes':'No'}`
    );
    const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + [headers, ...rows].join('\n');
    const link = document.createElement("a");
    link.setAttribute("href", encodeURI(csvContent));
    link.setAttribute("download", `tracker_${new Date().toISOString().slice(0,10)}.csv`);
    document.body.appendChild(link);
    link.click();
  };

  const handleImportCSV = (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
          const text = e.target.result;
          const rows = text.split('\n').slice(1); // Skip header
          
          let newTransactions = [];
          let newCategories = [];
          let existingCatNames = categories.map(c => c.name);
          
          // ID map for categories to reuse created ones in the same batch
          let batchCategoryMap = {};

          rows.forEach(row => {
              const cols = row.split(',');
              if (cols.length < 4) return; // Skip empty rows

              const [id, date, type, amountStr, accountId, catName, note, excludeStr, verifiedStr] = cols;
              
              // Handle Category
              let categoryId = 'unknown';
              
              // 1. Try to find in existing categories
              const existCat = categories.find(c => c.name === catName);
              if (existCat) {
                  categoryId = existCat.id;
              } else {
                  // 2. Try to find in batch created categories
                  if (batchCategoryMap[catName]) {
                      categoryId = batchCategoryMap[catName];
                  } else if (catName) {
                      // 3. Create new category
                      const newCatId = generateId();
                      const newCat = {
                          id: newCatId,
                          name: catName,
                          type: type || 'expense',
                          icon: 'ğŸ·ï¸',
                          color: 'bg-slate-100 text-slate-600'
                      };
                      newCategories.push(newCat);
                      batchCategoryMap[catName] = newCatId;
                      categoryId = newCatId;
                  }
              }

              newTransactions.push({
                  id: id || generateId(),
                  date: date,
                  type: type,
                  amount: parseFloat(amountStr),
                  accountId: accountId, // We assume account IDs match or we keep as is (will show unknown if missing)
                  categoryId: categoryId,
                  note: note,
                  excludeFromBudget: excludeStr === 'Yes',
                  verified: verifiedStr === 'Yes'
              });
          });

          showConfirm('ç¢ºèªåŒ¯å…¥', `å³å°‡åŒ¯å…¥ ${newTransactions.length} ç­†äº¤æ˜“ï¼Œä¸¦æ–°å¢ ${newCategories.length} å€‹æ–°é¡åˆ¥ã€‚ç¢ºå®šå—ï¼Ÿ`, () => {
              if (newCategories.length > 0) {
                  setCategories(prev => [...prev, ...newCategories]);
              }
              
              // Merge transactions: Update if ID exists, Add if new
              setTransactions(prev => {
                  const prevMap = new Map(prev.map(t => [t.id, t]));
                  newTransactions.forEach(t => prevMap.set(t.id, t));
                  return Array.from(prevMap.values());
              });
              
              showAlert('åŒ¯å…¥æˆåŠŸ', 'è³‡æ–™å·²æ›´æ–°ã€‚');
          });
      };
      reader.readAsText(file);
      // Reset input so same file can be selected again if needed
      event.target.value = ''; 
  };

  // --- Views ---

  const SummaryCard = ({ title, amount, color, onClick, subText, icon: Icon }) => (
    <div onClick={onClick} className="bg-white p-3 rounded-xl shadow-sm flex-1 mx-1 border border-slate-100 active:bg-slate-50 cursor-pointer transition-colors relative overflow-hidden">
      <div className="text-slate-500 text-xs mb-1 font-medium z-10 relative flex items-center gap-1">
          {Icon && <Icon size={12}/>}
          {title}
      </div>
      <div className={`text-lg font-bold ${color} z-10 relative`}>{formatCurrency(amount)}</div>
      {subText && <div className="text-[10px] text-slate-400 mt-1">{subText}</div>}
    </div>
  );

  const TransactionItem = ({ tx, onClick, showCheckbox = false }) => {
    const cat = categories.find(c => c.id === tx.categoryId);
    const acc = accounts.find(a => a.id === tx.accountId);
    const isTransfer = tx.type.includes('transfer');
    let amountColor = 'text-slate-800';
    if (tx.type === 'expense' || tx.type === 'transfer_out') amountColor = 'text-red-600';
    if (tx.type === 'income' || tx.type === 'transfer_in') amountColor = 'text-green-600';
    const dateObj = new Date(tx.date);
    const timeStr = isNaN(dateObj.getTime()) ? '' : dateObj.toLocaleTimeString('zh-TW', {hour: '2-digit', minute:'2-digit', hour12: false});
    const dateStr = isNaN(dateObj.getTime()) ? '' : dateObj.toLocaleDateString('zh-TW', {month:'2-digit', day:'2-digit'});

    return (
      <div className="flex items-center justify-between p-3 bg-white mb-2 rounded-lg shadow-sm border border-slate-100 active:bg-slate-50 transition-colors cursor-pointer relative">
        <div className="flex items-center gap-3 flex-1" onClick={onClick}>
          <div className={`w-10 h-10 rounded-full flex items-center justify-center text-lg ${cat?.color || 'bg-gray-100'}`}>
            {isTransfer ? 'â‡„' : (cat?.icon || '?')}
          </div>
          <div>
            <div className="font-medium text-slate-800 flex items-center gap-2">
                {isTransfer ? 'è½‰å¸³' : (cat?.name || 'æœªåˆ†é¡')}
                {tx.installments > 1 && <span className="text-[10px] bg-blue-100 text-blue-600 px-1 rounded">åˆ†æœŸ</span>}
                {tx.excludeFromBudget && <span className="text-[10px] bg-gray-200 text-gray-500 px-1 rounded">ä¸è¨ˆé ç®—</span>}
            </div>
            <div className="text-xs text-slate-500 flex items-center gap-1">
                <span className="font-mono text-slate-600">{dateStr} {timeStr}</span>
                <span className="text-slate-300">|</span>
                <span>{acc?.name || 'æœªçŸ¥å¸³æˆ¶'}</span>
                {tx.note && <span className="ml-1 text-slate-400 max-w-[80px] truncate border-l pl-1 border-slate-300">{tx.note}</span>}
            </div>
          </div>
        </div>
        <div className="flex items-center gap-3">
            <div className={`font-bold ${amountColor}`} onClick={onClick}>
            {tx.type === 'expense' || tx.type === 'transfer_out' ? '-' : '+'}
            {formatCurrency(tx.amount)}
            </div>
            {showCheckbox && (
                <button 
                    onClick={(e) => { e.stopPropagation(); handleToggleVerified(tx.id); }}
                    className={`p-2 rounded-full transition-colors ${tx.verified ? 'text-green-500' : 'text-slate-300 hover:text-slate-400'}`}
                >
                    {tx.verified ? <CheckSquare size={20} /> : <Square size={20} />}
                </button>
            )}
        </div>
      </div>
    );
  };

  const CategoryManager = () => {
    const [editingId, setEditingId] = useState(null);
    const [newCatName, setNewCatName] = useState('');
    const [newCatType, setNewCatType] = useState('expense');
    const [newCatIcon, setNewCatIcon] = useState('ğŸ·ï¸');

    useEffect(() => {
        if (editingId) {
            const cat = categories.find(c => c.id === editingId);
            if (cat) {
                setNewCatName(cat.name);
                setNewCatType(cat.type);
                setNewCatIcon(cat.icon);
            }
        } else {
            setNewCatName('');
            setNewCatType('expense');
            setNewCatIcon('ğŸ·ï¸');
        }
    }, [editingId, categories]);

    const handleSave = () => {
        if(!newCatName) return;
        if (editingId) {
            handleEditCategory({ id: editingId, name: newCatName, type: newCatType, icon: newCatIcon, color: categories.find(c => c.id === editingId)?.color });
            setEditingId(null);
        } else {
            handleAddCategory({ name: newCatName, type: newCatType, icon: newCatIcon, color: 'bg-slate-100 text-slate-600' });
        }
        setNewCatName('');
        setNewCatIcon('ğŸ·ï¸');
    };

    return (
        <div className="fixed inset-0 bg-white z-50 overflow-y-auto">
            <div className="flex items-center p-4 border-b bg-white sticky top-0">
                <button onClick={() => setView('settings')}><ChevronLeft /></button>
                <h2 className="flex-1 text-center font-bold">é¡åˆ¥ç®¡ç†</h2>
            </div>
            <div className="p-4 space-y-4 pb-safe">
                <div className="bg-slate-50 p-4 rounded-xl space-y-3 sticky top-16 z-10 shadow-sm border border-slate-200">
                    <h3 className="font-bold text-sm flex justify-between items-center">
                        {editingId ? 'ç·¨è¼¯é¡åˆ¥' : 'æ–°å¢é¡åˆ¥'}
                        {editingId && <button onClick={() => setEditingId(null)} className="text-xs text-blue-500">å–æ¶ˆç·¨è¼¯</button>}
                    </h3>
                    <div className="flex gap-2">
                         <button onClick={() => setNewCatType('expense')} className={`flex-1 py-2 text-xs rounded-lg border ${newCatType==='expense'?'bg-white border-slate-300 font-bold':'border-transparent'}`}>æ”¯å‡º</button>
                         <button onClick={() => setNewCatType('income')} className={`flex-1 py-2 text-xs rounded-lg border ${newCatType==='income'?'bg-white border-slate-300 font-bold':'border-transparent'}`}>æ”¶å…¥</button>
                    </div>
                    <div className="flex gap-2">
                        <input value={newCatIcon} onChange={e => setNewCatIcon(e.target.value)} className="w-12 text-center p-2 rounded-lg border" placeholder="åœ–" />
                        <input value={newCatName} onChange={e => setNewCatName(e.target.value)} className="flex-1 p-2 rounded-lg border" placeholder="é¡åˆ¥åç¨±" />
                        <button onClick={handleSave} className="bg-slate-900 text-white px-4 rounded-lg text-sm whitespace-nowrap">{editingId ? 'æ›´æ–°' : 'æ–°å¢'}</button>
                    </div>
                </div>
                <div className="space-y-2">
                    {categories.map(c => (
                        <div key={c.id} className={`flex items-center justify-between p-3 border rounded-lg ${editingId === c.id ? 'bg-blue-50 border-blue-200' : 'bg-white border-slate-100'}`}>
                            <div className="flex items-center gap-3">
                                <div className={`w-8 h-8 rounded-full flex items-center justify-center ${c.color}`}>{c.icon}</div>
                                <div><div className="text-sm font-medium">{c.name}</div><div className="text-[10px] text-slate-400 uppercase">{c.type === 'expense' ? 'æ”¯å‡º' : 'æ”¶å…¥'}</div></div>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={() => setEditingId(c.id)} className="text-slate-400 hover:text-blue-500 p-2"><Pencil size={16}/></button>
                                <button onClick={() => handleDeleteCategory(c.id)} className="text-slate-400 hover:text-red-500 p-2"><Trash2 size={16}/></button>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
  };

  const DrillDownView = () => {
      if (!drillDownData) return null;
      const { title, txList } = drillDownData;
      const sortedTx = [...txList].sort((a, b) => new Date(b.date) - new Date(a.date));
      const total = sortedTx.reduce((sum, t) => (t.type === 'expense' || t.type === 'transfer_out') ? sum - t.amount : sum + t.amount, 0);
      return (
          <div className="bg-slate-50 min-h-screen pb-safe">
              <div className="bg-white p-4 sticky top-0 border-b flex items-center z-10 shadow-sm"><button onClick={() => setView('main')} className="p-2 -ml-2"><ChevronLeft /></button><div className="flex-1 text-center font-bold text-lg">{title}</div><div className="w-8"></div></div>
              <div className="p-4">
                  <div className="bg-slate-800 text-white p-4 rounded-xl mb-4 flex justify-between items-center shadow-lg"><span className="text-slate-300">åˆè¨ˆ</span><span className="text-xl font-bold">{formatCurrency(Math.abs(total))}</span></div>
                  {sortedTx.map(tx => (<TransactionItem key={tx.id} tx={tx} onClick={() => { setEditingTransaction(tx); setView('add_transaction'); }} />))}
              </div>
          </div>
      );
  };

  const AddTransactionForm = () => {
    const isEdit = !!editingTransaction;
    const [type, setType] = useState(editingTransaction?.type?.includes('transfer') ? 'transfer' : (editingTransaction?.type || 'expense'));
    const [amount, setAmount] = useState(editingTransaction?.amount || '');
    const [date, setDate] = useState(editingTransaction ? toInputDateTime(editingTransaction.date) : toInputDateTime(new Date()));
    const [catId, setCatId] = useState(editingTransaction?.categoryId || (type === 'income' ? 'c6' : 'c1'));
    const [accId, setAccId] = useState(editingTransaction?.accountId || accounts[0]?.id);
    const [toAccId, setToAccId] = useState(editingTransaction?.toAccountId || accounts[1]?.id);
    const [note, setNote] = useState(editingTransaction?.note || '');
    const [installments, setInstallments] = useState(1);
    const [excludeFromBudget, setExcludeFromBudget] = useState(editingTransaction?.excludeFromBudget || false);
    const selectedAcc = accounts.find(a => a.id === accId);
    const isCreditCard = selectedAcc?.type === 'credit';

    const handleSubmit = () => {
        if (!amount || !accId) return;
        handleAddTransaction({
            id: editingTransaction?.id,
            type,
            amount: parseFloat(amount),
            date: new Date(date).toISOString(),
            categoryId: type === 'transfer' ? null : catId,
            accountId: accId,
            toAccountId: type === 'transfer' ? toAccId : null,
            note,
            installments: parseInt(installments),
            relatedTxId: editingTransaction?.relatedTxId,
            excludeFromBudget
        });
    };

    return (
        <div className="bg-white min-h-screen pb-safe z-50 fixed inset-0 overflow-y-auto">
            <div className="flex items-center p-4 border-b bg-white sticky top-0"><button onClick={() => { setView('main'); setEditingTransaction(null); }}><X /></button><h2 className="flex-1 text-center font-bold">{isEdit ? 'ç·¨è¼¯äº¤æ˜“' : 'æ–°å¢äº¤æ˜“'}</h2>{isEdit && <button onClick={() => handleDeleteTransaction(editingTransaction.id)} className="text-red-500 p-2"><Trash2 size={20}/></button>}</div>
            <div className="flex p-4 gap-2">{['expense', 'income', 'transfer'].map(t => (<button key={t} onClick={() => { setType(t); setCatId(t === 'income' ? 'c6' : 'c1'); }} className={`flex-1 py-2 rounded-lg font-medium transition-colors ${type === t ? (t==='expense'?'bg-red-100 text-red-600':t==='income'?'bg-green-100 text-green-600':'bg-blue-100 text-blue-600') : 'bg-slate-50 text-slate-400'}`}>{t === 'expense' ? 'æ”¯å‡º' : t === 'income' ? 'æ”¶å…¥' : 'è½‰å¸³'}</button>))}</div>
            <div className="px-4 space-y-6 pb-24">
                <div><label className="block text-xs text-slate-500 mb-1">é‡‘é¡</label><input type="number" value={amount} onChange={(e) => setAmount(e.target.value)} className="w-full text-4xl font-bold placeholder-slate-200 outline-none border-b border-slate-100 pb-2" placeholder="0" autoFocus /></div>
                {type !== 'transfer' && (<div><label className="block text-xs text-slate-500 mb-2">é¡åˆ¥</label><div className="flex flex-wrap gap-3 max-h-40 overflow-y-auto">{categories.filter(c => c.type === type).map(c => (<button key={c.id} onClick={() => setCatId(c.id)} className={`flex flex-col items-center gap-1 min-w-[60px] p-2 rounded-xl border ${catId === c.id ? 'border-slate-800 bg-slate-50' : 'border-transparent'}`}><span className={`w-10 h-10 rounded-full flex items-center justify-center ${c.color}`}>{c.icon}</span><span className="text-xs text-slate-600">{c.name}</span></button>))}</div></div>)}
                <div className="flex gap-4"><div className="flex-1"><label className="block text-xs text-slate-500 mb-1">{type === 'transfer' ? 'è½‰å‡ºå¸³æˆ¶' : 'å¸³æˆ¶'}</label><select value={accId} onChange={e => setAccId(e.target.value)} className="w-full p-3 bg-slate-50 rounded-lg">{accounts.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}</select></div>{type === 'transfer' && (<div className="flex items-center pt-5 text-slate-400"><ArrowRightLeft size={16}/></div>)}{type === 'transfer' && (<div className="flex-1"><label className="block text-xs text-slate-500 mb-1">è½‰å…¥å¸³æˆ¶</label><select value={toAccId} onChange={e => setToAccId(e.target.value)} className="w-full p-3 bg-slate-50 rounded-lg">{accounts.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}</select></div>)}</div>
                <div><label className="block text-xs text-slate-500 mb-1">æ—¥æœŸæ™‚é–“</label><input type="datetime-local" value={date} onChange={e => setDate(e.target.value)} className="w-full p-3 bg-slate-50 rounded-lg" /></div>
                <div className="flex gap-4">{!isEdit && type === 'expense' && isCreditCard && (<div className="w-32"><label className="block text-xs text-slate-500 mb-1">åˆ†æœŸ(æœˆ)</label><input type="number" min="1" max="36" value={installments} onChange={e => setInstallments(e.target.value)} className="w-full p-3 bg-slate-50 rounded-lg border border-blue-200" /></div>)}<div className="flex-1 flex items-center p-3 bg-slate-50 rounded-lg mt-5"><input type="checkbox" id="excludeBudget" checked={excludeFromBudget} onChange={e => setExcludeFromBudget(e.target.checked)} className="w-5 h-5 accent-slate-800 mr-3" /><label htmlFor="excludeBudget" className="text-sm text-slate-700">ä¸åˆ—å…¥æœˆé ç®—</label></div></div>
                <div><label className="block text-xs text-slate-500 mb-1">å‚™è¨»</label><input type="text" value={note} onChange={e => setNote(e.target.value)} className="w-full p-3 bg-slate-50 rounded-lg" placeholder="é¸å¡«..." /></div>
            </div>
            <div className="fixed bottom-0 left-0 w-full p-4 bg-white border-t"><button onClick={handleSubmit} className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold text-lg shadow-lg active:scale-95 transition-transform">å„²å­˜äº¤æ˜“</button></div>
        </div>
    );
  };

  const RecurringManager = () => {
    const totalMonthly = recurringRules.filter(r => r.active).reduce((sum, r) => sum + parseFloat(r.amount), 0);
    return (
        <div className="fixed inset-0 bg-white z-50 overflow-y-auto">
            <div className="flex items-center p-4 border-b bg-white sticky top-0"><button onClick={() => setView('settings')}><ChevronLeft /></button><h2 className="flex-1 text-center font-bold">é€±æœŸæ€§å¸³å‹™ç®¡ç†</h2><button onClick={() => { setEditingRecurring(null); setView('add_recurring'); }}><Plus className="text-blue-600" /></button></div>
            <div className="p-4 pb-24">
                <div className="bg-indigo-50 p-4 rounded-xl mb-6 flex justify-between items-center text-indigo-900"><span className="font-bold flex items-center gap-2"><Repeat size={16}/> æ¯æœˆå›ºå®šæ”¯å‡ºç¸½å’Œ</span><span className="text-xl font-bold">{formatCurrency(totalMonthly)}</span></div>
                <div className="space-y-3">{recurringRules.map(rule => (<div key={rule.id} onClick={() => { setEditingRecurring(rule); setView('add_recurring'); }} className={`p-4 rounded-xl border ${rule.active ? 'bg-white border-slate-200' : 'bg-slate-50 border-slate-100 opacity-70'} cursor-pointer active:bg-slate-50`}><div className="flex justify-between items-start mb-2"><div><div className="font-bold text-lg">{rule.note}</div><div className="text-xs text-slate-500">ä¸‹æ¬¡åŸ·è¡Œ: {toInputDate(rule.nextDueDate)} | å‰©é¤˜: {rule.remainingCount === null ? 'ç„¡é™' : rule.remainingCount}</div></div><div className="font-bold text-slate-800">{formatCurrency(rule.amount)}</div></div><div className="flex justify-end gap-2 mt-2"><button onClick={(e) => { e.stopPropagation(); handleToggleRecurring(rule.id); }} className={`px-3 py-1 rounded-full text-xs font-bold ${rule.active ? 'bg-amber-100 text-amber-700' : 'bg-green-100 text-green-700'}`}>{rule.active ? 'æš«åœ' : 'å•Ÿç”¨'}</button><button onClick={(e) => { e.stopPropagation(); handleDeleteRecurring(rule.id); }} className="px-3 py-1 rounded-full text-xs font-bold bg-red-100 text-red-600">çµ‚æ­¢/åˆªé™¤</button></div></div>))}{recurringRules.length === 0 && <div className="text-center text-slate-400 mt-10">å°šç„¡é€±æœŸæ€§è¨­å®š</div>}</div></div>
        </div>
    );
  };

  const AddRecurringForm = () => {
    const [form, setForm] = useState(() => {
        if (editingRecurring) {
            return { ...editingRecurring, nextDueDate: toInputDate(editingRecurring.nextDueDate), remainingCount: editingRecurring.remainingCount === null ? '' : editingRecurring.remainingCount };
        }
        return { amount: '', categoryId: 'c11', accountId: accounts[0]?.id, note: '', nextDueDate: toInputDate(), remainingCount: '' };
    });
    const save = () => { if (!form.amount || !form.note) return; handleUpdateRecurring({ ...form, id: editingRecurring ? editingRecurring.id : undefined, type: 'expense', remainingCount: form.remainingCount === '' ? null : parseInt(form.remainingCount), nextDueDate: new Date(form.nextDueDate).toISOString() }); };
    return (
        <div className="fixed inset-0 bg-white z-[60] overflow-y-auto">
            <div className="flex items-center p-4 border-b"><button onClick={() => setView('recurring_manager')}><X /></button><h2 className="flex-1 text-center font-bold">{editingRecurring ? 'ç·¨è¼¯é€±æœŸæ€§å¸³å‹™' : 'æ–°å¢é€±æœŸæ€§å¸³å‹™'}</h2><button onClick={save} className="text-blue-600 font-bold">å„²å­˜</button></div>
            <div className="p-4 space-y-4">
                 <div><label className="text-xs text-slate-500">é‡‘é¡</label><input type="number" className="w-full p-3 bg-slate-50 rounded-lg mt-1" value={form.amount} onChange={e => setForm({...form, amount: e.target.value})} autoFocus /></div>
                 <div><label className="text-xs text-slate-500">åç¨±</label><input className="w-full p-3 bg-slate-50 rounded-lg mt-1" value={form.note} onChange={e => setForm({...form, note: e.target.value})} /></div>
                 <div><label className="text-xs text-slate-500">é¦–æ¬¡æ‰£æ¬¾æ—¥æœŸ</label><input type="date" className="w-full p-3 bg-slate-50 rounded-lg mt-1" value={form.nextDueDate} onChange={e => setForm({...form, nextDueDate: e.target.value})} /></div>
                 <div><label className="text-xs text-slate-500">å¾ªç’°æ¬¡æ•¸ (ç•™ç©ºç‚ºç„¡é™)</label><input type="number" className="w-full p-3 bg-slate-50 rounded-lg mt-1" placeholder="âˆ" value={form.remainingCount} onChange={e => setForm({...form, remainingCount: e.target.value})} /></div>
                 <div><label className="text-xs text-slate-500">æ‰£æ¬¾å¸³æˆ¶</label><select className="w-full p-3 bg-slate-50 rounded-lg mt-1" value={form.accountId} onChange={e => setForm({...form, accountId: e.target.value})}>{accounts.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}</select></div>
                 <div><label className="text-xs text-slate-500">é¡åˆ¥</label><select className="w-full p-3 bg-slate-50 rounded-lg mt-1" value={form.categoryId} onChange={e => setForm({...form, categoryId: e.target.value})}>{categories.filter(c => c.type === 'expense').map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
            </div>
        </div>
    );
  };

  const AccountEditForm = ({ initialData, onClose }) => {
      const [formData, setFormData] = useState(initialData || { name: '', type: 'cash', initialBalance: 0, creditLimit: 0, statementDay: 1, dueDay: 15 });
      const save = () => { if (!formData.name) return; handleUpdateAccount({ ...formData, isNew: !initialData }); onClose(); };
      return (
        <div className="fixed inset-0 bg-white z-50 overflow-y-auto">
            <div className="flex items-center p-4 border-b"><button onClick={onClose}><X /></button><h2 className="flex-1 text-center font-bold">{initialData ? 'ç·¨è¼¯å¸³æˆ¶' : 'æ–°å¢å¸³æˆ¶'}</h2><button onClick={save} className="text-blue-600 font-bold">å„²å­˜</button></div>
            <div className="p-4 space-y-4">
                <div><label className="text-xs text-slate-500">å¸³æˆ¶åç¨±</label><input className="w-full p-3 bg-slate-50 rounded-lg mt-1" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} /></div>
                <div><label className="text-xs text-slate-500">é¡å‹</label><div className="flex gap-2 mt-1">{['cash', 'bank', 'credit'].map(t => (<button key={t} onClick={() => setFormData({...formData, type: t})} className={`flex-1 py-2 rounded-lg border ${formData.type === t ? 'border-slate-800 bg-slate-100 font-bold' : 'border-slate-200'}`}>{t === 'cash' ? 'ç¾é‡‘' : t === 'bank' ? 'éŠ€è¡Œ' : 'ä¿¡ç”¨å¡'}</button>))}</div></div>
                <div><label className="text-xs text-slate-500">åˆå§‹é¤˜é¡</label><input type="number" className="w-full p-3 bg-slate-50 rounded-lg mt-1" value={formData.initialBalance} onChange={e => setFormData({...formData, initialBalance: parseFloat(e.target.value)})} /></div>
                {formData.type === 'credit' && (<div className="bg-slate-50 p-4 rounded-lg space-y-3"><h4 className="font-bold text-sm">ä¿¡ç”¨å¡è¨­å®š</h4><div><label className="text-xs text-slate-500">ä¿¡ç”¨é¡åº¦</label><input type="number" className="w-full p-2 bg-white border rounded mt-1" value={formData.creditLimit} onChange={e => setFormData({...formData, creditLimit: parseFloat(e.target.value)})} /></div><div className="flex gap-3"><div className="flex-1"><label className="text-xs text-slate-500">çµå¸³æ—¥</label><input type="number" className="w-full p-2 bg-white border rounded mt-1" value={formData.statementDay} onChange={e => setFormData({...formData, statementDay: parseInt(e.target.value)})} /></div><div className="flex-1"><label className="text-xs text-slate-500">ç¹³æ¬¾æˆªæ­¢</label><input type="number" className="w-full p-2 bg-white border rounded mt-1" value={formData.dueDay} onChange={e => setFormData({...formData, dueDay: parseInt(e.target.value)})} /></div></div></div>)}
                {initialData && (<button onClick={() => handleDeleteAccount(initialData.id)} className="w-full py-3 text-red-500 border border-red-100 rounded-lg mt-8 flex items-center justify-center gap-2"><Trash2 size={18}/> åˆªé™¤æ­¤å¸³æˆ¶</button>)}
            </div>
        </div>
      );
  };

  const AccountDetail = () => {
      const [viewDate, setViewDate] = useState(new Date());
      if (!selectedAccount) return null;
      const balance = getAccountBalance(selectedAccount.id);
      const statementDay = selectedAccount.type === 'credit' ? (selectedAccount.statementDay || 1) : 1;
      const { start, end, label } = getAccountCycleRange(viewDate, statementDay);

      const accTx = transactions
        .filter(t => t.accountId === selectedAccount.id || t.toAccountId === selectedAccount.id)
        .filter(t => {
            const d = new Date(t.date);
            return d >= start && d <= end;
        })
        .sort((a, b) => new Date(b.date) - new Date(a.date));

      const verifiedBalance = accTx.filter(t => t.verified).reduce((sum, t) => {
            if (t.type === 'expense' || t.type === 'transfer_out') return sum - t.amount;
            if (t.type === 'income' || t.type === 'transfer_in') return sum + t.amount;
            return sum;
        }, 0);

      const currentPeriodNet = accTx.reduce((sum, t) => {
          if (t.type === 'expense') return sum - t.amount;
          if (t.type === 'income') return sum + t.amount;
          if (t.accountId === selectedAccount.id && t.type === 'transfer_out') return sum - t.amount;
          if (t.toAccountId === selectedAccount.id && t.type === 'transfer_in') return sum + t.amount;
          return sum;
      }, 0);

      const handleReconcile = () => {
          showPrompt('å°å¸³', `ç›®å‰ç¸½é¤˜é¡ ${formatCurrency(balance)}\nè«‹è¼¸å…¥å¯¦éš›é¤˜é¡ï¼š`, balance, (actualStr) => {
              const actual = parseFloat(actualStr);
              if (isNaN(actual)) return;
              const diff = actual - balance;
              if (Math.abs(diff) < 1) return showAlert('å°å¸³æˆåŠŸ', 'é‡‘é¡ç›¸ç¬¦');
              showConfirm('å»ºç«‹èª¿æ•´äº¤æ˜“', `è¨ˆç®—å·®ç•°ç‚º ${formatCurrency(diff)}ï¼Œæ˜¯å¦è‡ªå‹•å»ºç«‹èª¿æ•´äº¤æ˜“ï¼Ÿ`, () => {
                  handleAddTransaction({ type: diff > 0 ? 'income' : 'expense', amount: Math.abs(diff), date: new Date().toISOString(), categoryId: diff > 0 ? 'c10' : 'c9', accountId: selectedAccount.id, note: 'å°å¸³èª¿æ•´', installments: 1 });
              });
          });
      };

      const handlePayCard = () => {
          const amountToPay = currentPeriodNet < 0 ? Math.abs(currentPeriodNet) : 0;
          setEditingTransaction({ type: 'transfer', amount: amountToPay, date: new Date().toISOString(), toAccountId: selectedAccount.id, accountId: accounts.find(a => a.type === 'bank')?.id || '', note: `ç¹³äº¤ ${selectedAccount.name} (${label}) å¡è²»` });
          setView('add_transaction');
      };

      const prevMonth = () => setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth() - 1, 1));
      const nextMonth = () => setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 1));

      return (
          <div className="bg-slate-50 min-h-screen pb-safe">
              <div className="bg-slate-900 text-white p-6 pb-12 sticky top-0 z-10">
                  <div className="flex items-center mb-4"><button onClick={() => setView('main')}><ChevronLeft /></button><h2 className="flex-1 text-center font-bold">{selectedAccount.name}</h2><button onClick={() => setView('edit_account')}><Edit2 size={18} /></button></div>
                  <div className="text-center"><div className="text-slate-400 text-sm">ç•¶å‰ç¸½é¤˜é¡</div><div className="text-3xl font-bold my-1">{formatCurrency(balance)}</div>{selectedAccount.type === 'credit' && (<div className="text-xs text-slate-500">å¯ç”¨é¡åº¦: {formatCurrency((selectedAccount.creditLimit || 0) + balance)}</div>)}</div>
                  <div className="flex justify-center gap-3 mt-6">
                      <button onClick={handleReconcile} className="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-full text-sm flex items-center gap-2"><CheckCircle size={14}/> å°å¸³</button>
                      {selectedAccount.type === 'credit' && currentPeriodNet < 0 && (<button onClick={handlePayCard} className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-full text-sm flex items-center gap-2"><CreditCard size={14}/> ç¹³æœ¬æœŸå¸³å–®</button>)}
                  </div>
              </div>
              <div className="px-4 -mt-6">
                  <div className="bg-white rounded-xl shadow-sm min-h-[500px] p-2">
                       <div className="flex items-center justify-between p-2 mb-2 border-b border-slate-100 pb-3"><button onClick={prevMonth} className="p-1 hover:bg-slate-100 rounded"><ChevronLeft size={20} className="text-slate-400"/></button><div className="text-center"><div className="font-bold text-slate-800">{formatMonth(viewDate)}</div><div className="text-[10px] text-slate-400">é€±æœŸ: {label}</div></div><button onClick={nextMonth} className="p-1 hover:bg-slate-100 rounded"><ChevronRight size={20} className="text-slate-400"/></button></div>
                       <div className="text-center text-xs text-slate-500 mb-3 bg-slate-50 p-2 rounded-lg mx-2 border border-slate-100">å·²ç¢ºèªé‡‘é¡: <span className={`font-bold ${verifiedBalance < 0 ? 'text-red-500' : 'text-slate-700'}`}>{formatCurrency(verifiedBalance)}</span></div>
                      {accTx.map(tx => (<TransactionItem key={tx.id} tx={tx} onClick={() => { setEditingTransaction(tx); setView('add_transaction'); }} showCheckbox={true} />))}{accTx.length === 0 && <div className="text-center text-slate-400 py-10">æ­¤å€é–“ç„¡äº¤æ˜“ç´€éŒ„</div>}
                  </div>
              </div>
          </div>
      );
  };

  const BudgetSettings = () => (
      <div className="fixed inset-0 bg-white z-50 overflow-y-auto">
          <div className="flex items-center p-4 border-b"><button onClick={() => setView('main')}><X /></button><h2 className="flex-1 text-center font-bold">é ç®—è¨­å®š</h2><button onClick={() => setView('main')} className="text-blue-600 font-bold">å®Œæˆ</button></div>
          <div className="p-4 space-y-6 pb-safe">
             <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg"><span>å•Ÿç”¨é ç®—åŠŸèƒ½</span><input type="checkbox" checked={budget.enabled} onChange={e => setBudget({...budget, enabled: e.target.checked})} className="w-6 h-6 accent-blue-600"/></div>
             {budget.enabled && (<><div className="flex flex-col gap-1"><label className="text-sm font-bold text-slate-700">æ¯æœˆé ç®—é‡‘é¡</label><input type="number" value={budget.amount} onChange={e => setBudget({...budget, amount: parseFloat(e.target.value)})} className="w-full p-4 bg-slate-50 rounded-xl text-xl font-bold border border-slate-200"/></div><div className="flex flex-col gap-1"><label className="text-sm font-bold text-slate-700">é ç®—èµ·å§‹æ—¥ (æ¯æœˆå¹¾è™Ÿ)</label><input type="number" min="1" max="31" value={budget.resetDay} onChange={e => setBudget({...budget, resetDay: parseInt(e.target.value)})} className="w-full p-4 bg-slate-50 rounded-xl text-xl font-bold border border-slate-200"/></div></>)}
          </div>
      </div>
  );

  const SettingsView = () => (
      <div className="p-4 space-y-6 pb-24">
          <h2 className="text-xl font-bold">è¨­å®š</h2>
          <div className="bg-white rounded-xl p-4 shadow-sm border border-slate-100">
              <h3 className="font-bold mb-4 text-sm text-slate-500 uppercase">åŠŸèƒ½è¨­å®š</h3>
              <button onClick={() => setView('category_manager')} className="w-full flex items-center justify-between p-3 hover:bg-slate-50 rounded-lg"><div className="flex items-center gap-3"><Tag className="text-orange-500" /><span>é¡åˆ¥ç®¡ç†</span></div><ChevronRight size={16} className="text-slate-300" /></button>
              <button onClick={() => setView('budget_settings')} className="w-full flex items-center justify-between p-3 hover:bg-slate-50 rounded-lg"><div className="flex items-center gap-3"><Target className="text-purple-500" /><span>é ç®—è¨­å®š</span></div><ChevronRight size={16} className="text-slate-300" /></button>
              <button onClick={() => setView('recurring_manager')} className="w-full flex items-center justify-between p-3 hover:bg-slate-50 rounded-lg"><div className="flex items-center gap-3"><Repeat className="text-indigo-500" /><span>é€±æœŸæ€§å¸³å‹™ç®¡ç†</span></div><ChevronRight size={16} className="text-slate-300" /></button>
          </div>
          <div className="bg-white rounded-xl p-4 shadow-sm border border-slate-100">
              <h3 className="font-bold mb-4 text-sm text-slate-500 uppercase">è³‡æ–™ç®¡ç†</h3>
              <button onClick={exportCSV} className="w-full flex items-center justify-between p-3 hover:bg-slate-50 rounded-lg"><div className="flex items-center gap-3"><Download className="text-blue-500" /><span>åŒ¯å‡ºè³‡æ–™ (CSV)</span></div><ChevronRight size={16} className="text-slate-300" /></button>
              <div className="relative w-full">
                  <button className="w-full flex items-center justify-between p-3 hover:bg-slate-50 rounded-lg">
                      <div className="flex items-center gap-3"><Upload className="text-green-500" /><span>åŒ¯å…¥è³‡æ–™ (CSV)</span></div>
                      <ChevronRight size={16} className="text-slate-300" />
                  </button>
                  <input 
                      type="file" 
                      accept=".csv" 
                      onChange={handleImportCSV} 
                      className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                  />
              </div>
          </div>
          <div className="text-center text-xs text-slate-300 pt-4">Minimalist Tracker v1.1</div>
      </div>
  );

  const renderDashboard = () => {
    const { firstDay, lastDay } = getMonthRange(currentViewDate);
    const monthTx = transactions.filter(t => { const d = new Date(t.date); return d >= firstDay && d <= lastDay; });
    const income = monthTx.filter(t => t.type === 'income').reduce((acc, cur) => acc + cur.amount, 0);
    const expense = monthTx.filter(t => t.type === 'expense').reduce((acc, cur) => acc + cur.amount, 0);
    const totalAssets = accounts.reduce((acc, cur) => acc + getAccountBalance(cur.id), 0);
    const creditAccIds = accounts.filter(a => a.type === 'credit').map(a => a.id);
    const creditCardMonthExpense = monthTx.filter(t => creditAccIds.includes(t.accountId) && t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
    const creditCardMonthTx = monthTx.filter(t => creditAccIds.includes(t.accountId) && t.type === 'expense');
    const futureInstallments = transactions.filter(t => { const d = new Date(t.date); return creditAccIds.includes(t.accountId) && t.type === 'expense' && d > lastDay; }).reduce((sum, t) => sum + t.amount, 0);
    const futureInstallmentsTx = transactions.filter(t => { const d = new Date(t.date); return creditAccIds.includes(t.accountId) && t.type === 'expense' && d > lastDay; });
    const totalRecurring = recurringRules.filter(r => r.active).reduce((sum, r) => sum + parseFloat(r.amount), 0);
    const budgetRange = getBudgetRange(currentViewDate, budget.resetDay);
    const budgetTx = transactions.filter(t => { const d = new Date(t.date); return t.type === 'expense' && d >= budgetRange.start && d <= budgetRange.end && !t.excludeFromBudget; });
    const currentBudgetExpense = budgetTx.reduce((sum, t) => sum + t.amount, 0);
    const budgetPercent = budget.amount > 0 ? Math.min((currentBudgetExpense / budget.amount) * 100, 100) : 0;
    const prevMonth = () => { setCurrentViewDate(new Date(currentViewDate.setMonth(currentViewDate.getMonth() - 1))); };
    const nextMonth = () => { setCurrentViewDate(new Date(currentViewDate.setMonth(currentViewDate.getMonth() + 1))); };

    return (
      <div className="space-y-6 pb-24">
        <div className="flex items-center justify-between px-2"><button onClick={prevMonth} className="p-2 bg-white rounded-lg shadow-sm text-slate-600"><ChevronLeft size={20}/></button><div className="font-bold text-lg flex items-center gap-2 text-slate-800"><Calendar size={18} className="text-slate-500"/>{formatMonth(currentViewDate)}</div><button onClick={nextMonth} className="p-2 bg-white rounded-lg shadow-sm text-slate-600"><ChevronRight size={20}/></button></div>
        <div onClick={() => setActiveTab('accounts')} className="bg-gradient-to-r from-slate-800 to-slate-900 text-white p-6 rounded-2xl shadow-lg active:scale-95 transition-transform cursor-pointer"><div className="text-slate-400 text-sm mb-1 flex items-center justify-between">æ·¨è³‡ç”¢ç¸½é¡ <ChevronRight size={16} /></div><div className="text-3xl font-bold">{formatCurrency(totalAssets)}</div></div>
        {budget.enabled && (<div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 relative overflow-hidden"><div className="flex justify-between items-end mb-2 relative z-10"><div><div className="text-xs text-slate-500 font-bold mb-1 flex items-center gap-1"><Target size={12}/> æœ¬æœˆé ç®— (å·²éæ¿¾ä¸è¨ˆå…¥)</div><div className="font-bold text-lg">{formatCurrency(currentBudgetExpense)} <span className="text-sm text-slate-400 font-normal">/ {formatCurrency(budget.amount)}</span></div></div><div className="text-right"><div className={`font-bold ${budget.amount - currentBudgetExpense < 0 ? 'text-red-500' : 'text-green-600'}`}>{formatCurrency(budget.amount - currentBudgetExpense)}</div><div className="text-[10px] text-slate-400">å‰©é¤˜é¡åº¦</div></div></div><div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden relative z-10"><div className={`h-full rounded-full transition-all duration-500 ${budgetPercent > 90 ? 'bg-red-500' : budgetPercent > 70 ? 'bg-orange-400' : 'bg-blue-500'}`} style={{ width: `${budgetPercent}%` }}></div></div></div>)}
        <div className="grid grid-cols-3 gap-2">
             <div onClick={() => { setDrillDownData({ title: 'æœ¬æœˆä¿¡ç”¨å¡æ¶ˆè²»æ˜ç´°', txList: creditCardMonthTx }); setView('drill_down'); }} className="bg-white p-2 rounded-xl shadow-sm border border-slate-100 cursor-pointer active:bg-slate-50 flex flex-col justify-between h-20"><div className="text-slate-500 text-[10px] font-bold flex items-center gap-1"><CreditCard size={10}/> ä¿¡ç”¨å¡æœ¬æœˆ</div><div className="text-base font-bold text-slate-800 leading-tight">{formatCurrency(creditCardMonthExpense)}</div></div>
             <div onClick={() => { setDrillDownData({ title: 'åˆ†æœŸæœªåˆ°æœŸé¤˜é¡æ˜ç´°', txList: futureInstallmentsTx }); setView('drill_down'); }} className="bg-white p-2 rounded-xl shadow-sm border border-slate-100 cursor-pointer active:bg-slate-50 flex flex-col justify-between h-20"><div className="text-slate-500 text-[10px] font-bold flex items-center gap-1"><Layers size={10}/> åˆ†æœŸæœªåˆ°æœŸ</div><div className="text-base font-bold text-blue-600 leading-tight">{formatCurrency(futureInstallments)}</div></div>
             <div onClick={() => setView('recurring_manager')} className="bg-white p-2 rounded-xl shadow-sm border border-slate-100 cursor-pointer active:bg-slate-50 flex flex-col justify-between h-20"><div className="text-slate-500 text-[10px] font-bold flex items-center gap-1"><Repeat size={10}/> æ¯æœˆå›ºå®šæ”¯å‡º</div><div className="text-base font-bold text-indigo-600 leading-tight">{formatCurrency(totalRecurring)}</div></div>
        </div>
        <div className="flex justify-between -mx-1"><SummaryCard title="æœ¬æœˆæ”¶å…¥" amount={income} color="text-green-600" onClick={() => { setDrillDownData({ title: `${formatMonth(currentViewDate)} æ”¶å…¥æ˜ç´°`, txList: monthTx.filter(t => t.type === 'income') }); setView('drill_down'); }} /><SummaryCard title="æœ¬æœˆæ”¯å‡º" amount={expense} color="text-red-600" onClick={() => { setDrillDownData({ title: `${formatMonth(currentViewDate)} æ”¯å‡ºæ˜ç´°`, txList: monthTx.filter(t => t.type === 'expense') }); setView('drill_down'); }} /></div>
        <div><div className="flex justify-between items-center px-1 mb-3"><h3 className="font-bold text-slate-700">ç•¶æœˆæ´»å‹•æ˜ç´°</h3><span className="text-xs text-slate-400">{formatMonth(currentViewDate)}</span></div>{monthTx.sort((a, b) => new Date(b.date) - new Date(a.date)).map(tx => (<TransactionItem key={tx.id} tx={tx} onClick={() => { setEditingTransaction(tx); setView('add_transaction'); }} />))}{monthTx.length === 0 && <div className="text-center text-slate-400 py-8 bg-white rounded-xl border border-dashed border-slate-200">æœ¬æœˆå°šç„¡äº¤æ˜“ç´€éŒ„</div>}</div>
      </div>
    );
  };

  const renderStats = () => {
    const now = new Date();
    let start = new Date();
    let end = new Date();
    if (statsPeriod === 'day') { start = new Date(now.getFullYear(), now.getMonth(), now.getDate()); end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59); } 
    else if (statsPeriod === 'week') { const day = now.getDay(); const diff = now.getDate() - day + (day === 0 ? -6 : 1); start = new Date(now.setDate(diff)); start.setHours(0,0,0,0); end = new Date(start); end.setDate(start.getDate() + 6); end.setHours(23,59,59,999); } 
    else if (statsPeriod === 'month') { start = new Date(now.getFullYear(), now.getMonth(), 1); end = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59); } 
    else if (statsPeriod === 'year') { start = new Date(now.getFullYear(), 0, 1); end = new Date(now.getFullYear(), 11, 31, 23, 59, 59); } 
    else if (statsPeriod === 'custom') { start = new Date(customRange.start); end = new Date(customRange.end); end.setHours(23,59,59,999); }
    const filteredTx = transactions.filter(t => { const d = new Date(t.date); return d >= start && d <= end && t.type === 'expense'; });
    const totalExpense = filteredTx.reduce((sum, t) => sum + t.amount, 0);
    const catStats = categories.filter(c => c.type === 'expense').map(c => { const txs = filteredTx.filter(t => t.categoryId === c.id); const sum = txs.reduce((s, t) => s + t.amount, 0); return { ...c, sum, txs }; }).filter(c => c.sum > 0).sort((a, b) => b.sum - a.sum);
    return (
        <div className="pb-24"><h2 className="text-xl font-bold mb-4">çµ±è¨ˆåˆ†æ</h2><div className="flex bg-slate-200 p-1 rounded-lg mb-4 overflow-x-auto">{['day', 'week', 'month', 'year', 'custom'].map(p => (<button key={p} onClick={() => setStatsPeriod(p)} className={`flex-1 min-w-[50px] text-xs py-2 rounded-md capitalize whitespace-nowrap transition-all ${statsPeriod === p ? 'bg-white shadow-sm font-bold text-slate-800' : 'text-slate-500'}`}>{p === 'day' ? 'ä»Šæ—¥' : p === 'week' ? 'æœ¬é€±' : p === 'month' ? 'æœ¬æœˆ' : p === 'year' ? 'ä»Šå¹´' : 'è‡ªè¨‚'}</button>))}</div>{statsPeriod === 'custom' && (<div className="bg-white p-3 rounded-xl mb-4 flex items-center gap-2 shadow-sm border border-slate-100"><input type="date" value={customRange.start} onChange={e => setCustomRange({...customRange, start: e.target.value})} className="flex-1 bg-slate-50 border-none rounded p-1 text-sm" /><span className="text-slate-400">to</span><input type="date" value={customRange.end} onChange={e => setCustomRange({...customRange, end: e.target.value})} className="flex-1 bg-slate-50 border-none rounded p-1 text-sm" /></div>)}<div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 text-center mb-6"><div className="text-slate-500 mb-1">ç¸½æ”¯å‡º</div><div className="text-3xl font-bold text-slate-800">{formatCurrency(totalExpense)}</div><div className="text-xs text-slate-400 mt-2">{formatDateTime(start.toISOString())} ~ {formatDateTime(end.toISOString())}</div></div><div className="space-y-3">{catStats.map(c => (<div key={c.id} onClick={() => { setDrillDownData({ title: `${c.name} - æ˜ç´°`, txList: c.txs }); setView('drill_down'); }} className="flex items-center gap-3 active:bg-slate-50 p-2 -mx-2 rounded-lg cursor-pointer"><div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm ${c.color}`}>{c.icon}</div><div className="flex-1"><div className="flex justify-between mb-1"><span className="text-sm font-medium">{c.name}</span><span className="text-sm font-bold flex items-center gap-1">{formatCurrency(c.sum)}<ChevronRight size={14} className="text-slate-300"/></span></div><div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden"><div className="h-full bg-slate-800 rounded-full" style={{ width: `${(c.sum / totalExpense) * 100}%` }}></div></div></div></div>))}{catStats.length === 0 && <div className="text-center text-slate-400 py-10">æ­¤å€é–“ç„¡æ”¯å‡ºè³‡æ–™</div>}</div></div>
    );
  };

  return (
    <div className="max-w-md mx-auto bg-slate-50 min-h-screen relative font-sans text-slate-800">
      <div className="p-4 flex items-center justify-center bg-white border-b sticky top-0 z-20"><h1 className="font-bold text-lg">{activeTab === 'home' && 'ç¸½è¦½'}{activeTab === 'accounts' && 'å¸³æˆ¶ç®¡ç†'}{activeTab === 'stats' && 'çµ±è¨ˆåˆ†æ'}{activeTab === 'settings' && 'è¨­å®š'}</h1></div>
      <div className="p-4 min-h-[80vh]">
        {activeTab === 'home' && renderDashboard()}
        {activeTab === 'accounts' && (<div className="space-y-3 pb-24">{accounts.map(acc => (<div key={acc.id} onClick={() => { setSelectedAccount(acc); setView('account_detail'); }} className="bg-white p-4 rounded-xl shadow-sm flex items-center justify-between border border-slate-100 cursor-pointer active:scale-95 transition-transform"><div className="flex items-center gap-3"><div className={`w-10 h-10 rounded-full flex items-center justify-center bg-slate-100`}>{acc.type === 'cash' ? <DollarSign size={18}/> : acc.type === 'credit' ? <CreditCard size={18}/> : <Home size={18}/>}</div><div><div className="font-bold">{acc.name}</div><div className="text-xs text-slate-400 capitalize">{acc.type === 'credit' ? 'ä¿¡ç”¨å¡' : acc.type === 'bank' ? 'éŠ€è¡Œ' : 'ç¾é‡‘'}</div></div></div><div className={`font-bold ${getAccountBalance(acc.id) < 0 ? 'text-red-500' : 'text-slate-800'}`}>{formatCurrency(getAccountBalance(acc.id))}</div></div>))}<button onClick={() => { setSelectedAccount(null); setView('edit_account'); }} className="w-full py-3 border-2 border-dashed border-slate-300 rounded-xl text-slate-400 font-bold flex items-center justify-center gap-2 hover:bg-slate-100 transition-colors"><Plus /> æ–°å¢å¸³æˆ¶</button></div>)}
        {activeTab === 'stats' && renderStats()}
        {activeTab === 'settings' && <SettingsView />}
      </div>
      <div className="fixed bottom-0 left-0 w-full bg-white border-t border-slate-200 flex justify-around items-center p-2 pb-safe z-30">
        <button onClick={() => setActiveTab('home')} className={`p-2 rounded-xl flex flex-col items-center gap-1 ${activeTab === 'home' ? 'text-slate-900' : 'text-slate-400'}`}><Home size={24} strokeWidth={activeTab === 'home' ? 2.5 : 2} /><span className="text-[10px] font-bold">ç¸½è¦½</span></button>
        <button onClick={() => setActiveTab('stats')} className={`p-2 rounded-xl flex flex-col items-center gap-1 ${activeTab === 'stats' ? 'text-slate-900' : 'text-slate-400'}`}><PieChart size={24} strokeWidth={activeTab === 'stats' ? 2.5 : 2} /><span className="text-[10px] font-bold">çµ±è¨ˆ</span></button>
        <button onClick={() => { setEditingTransaction(null); setView('add_transaction'); }} className="w-14 h-14 bg-slate-900 rounded-full text-white shadow-lg flex items-center justify-center -mt-8 active:scale-95 transition-transform"><Plus size={32} /></button>
        <button onClick={() => setActiveTab('accounts')} className={`p-2 rounded-xl flex flex-col items-center gap-1 ${activeTab === 'accounts' ? 'text-slate-900' : 'text-slate-400'}`}><CreditCard size={24} strokeWidth={activeTab === 'accounts' ? 2.5 : 2} /><span className="text-[10px] font-bold">å¸³æˆ¶</span></button>
        <button onClick={() => setActiveTab('settings')} className={`p-2 rounded-xl flex flex-col items-center gap-1 ${activeTab === 'settings' ? 'text-slate-900' : 'text-slate-400'}`}><Settings size={24} strokeWidth={activeTab === 'settings' ? 2.5 : 2} /><span className="text-[10px] font-bold">è¨­å®š</span></button>
      </div>
      
      {/* å…¨åŸŸå°è©±æ¡† */}
      <CustomDialog 
          isOpen={dialogConfig.isOpen}
          type={dialogConfig.type}
          title={dialogConfig.title}
          message={dialogConfig.message}
          onConfirm={dialogConfig.onConfirm}
          onCancel={dialogConfig.onCancel}
          defaultValue={dialogConfig.defaultValue}
      />

      {/* è¦–åœ–å±¤ç´šæ¸²æŸ“ */}
      {view === 'add_transaction' && <div className="fixed inset-0 z-40 bg-white"><AddTransactionForm /></div>}
      {view === 'account_detail' && <div className="fixed inset-0 z-40 bg-white"><AccountDetail /></div>}
      {view === 'edit_account' && <div className="fixed inset-0 z-40 bg-white"><AccountEditForm initialData={selectedAccount} onClose={() => setView(selectedAccount ? 'account_detail' : 'main')} /></div>}
      {view === 'budget_settings' && <div className="fixed inset-0 z-40 bg-white"><BudgetSettings /></div>}
      {view === 'drill_down' && <div className="fixed inset-0 z-40 bg-white"><DrillDownView /></div>}
      {view === 'recurring_manager' && <div className="fixed inset-0 z-40 bg-white"><RecurringManager /></div>}
      {view === 'add_recurring' && <div className="fixed inset-0 z-40 bg-white"><AddRecurringForm /></div>}
      {view === 'category_manager' && <div className="fixed inset-0 z-40 bg-white"><CategoryManager /></div>}
    </div>
  );
}
