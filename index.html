<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¥µç°¡è¨˜å¸³ (Minimalist Tracker)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        input, select, textarea { font-size: 16px !important; }
    </style>
</head>
<body class="bg-slate-100 text-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Plus, Home, PieChart, CreditCard, Settings, 
            ChevronLeft, ChevronRight, Save, Trash2, 
            ArrowRightLeft, Upload, Download, CheckCircle,
            Calendar, DollarSign, ListFilter, Edit2, X, 
            AlertCircle, Target, Filter, Clock, Repeat, Ban,
            Layers, Tag, CheckSquare, Square, Pencil, AlertTriangle,
            ArrowUp, ArrowDown, Utensils, Bus, ShoppingBag, Gamepad2, Banknote, Gem
        } from 'https://esm.sh/lucide-react@0.263.1';

        // --- Icon Map (è§£æ±º React èˆ‡ DOM æ“ä½œè¡çªçš„é—œéµ) ---
        const ICON_MAP = {
            Plus, Home, PieChart, CreditCard, Settings, 
            ChevronLeft, ChevronRight, Save, Trash2, 
            ArrowRightLeft, Upload, Download, CheckCircle,
            Calendar, DollarSign, ListFilter, Edit2, X, 
            AlertCircle, Target, Filter, Clock, Repeat, Ban,
            Layers, Tag, CheckSquare, Square, Pencil, AlertTriangle,
            ArrowUp, ArrowDown, Utensils, Bus, ShoppingBag, Gamepad2, Banknote, Gem
        };

        const Icon = ({ name, size = 20, className = "" }) => {
            const LucideIcon = ICON_MAP[name] || ICON_MAP['Tag']; // é è¨­åœ–ç¤º
            return <LucideIcon size={size} className={className} />;
        };

        // --- å·¥å…·å‡½æ•¸ ---
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const formatCurrency = (amount) => {
            if (amount === undefined || amount === null || isNaN(amount)) return "$0";
            return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(amount);
        };
        const formatMonth = (date) => {
             try { return date.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long' }); } catch(e) { return ''; }
        };
        const safeDate = (iso) => {
            if (!iso) return new Date();
            const d = new Date(iso);
            return isNaN(d.getTime()) ? new Date() : d;
        };
        const formatDateTime = (iso) => safeDate(iso).toLocaleString('zh-TW', {month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'});
        const toInputDate = (iso) => safeDate(iso).toISOString().split('T')[0];
        const toInputDateTime = (iso) => {
            const d = safeDate(iso);
            d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
            return d.toISOString().slice(0, 16);
        };
        const getRelativeDate = (days) => { 
            const d = new Date(); 
            d.setDate(d.getDate() + days); 
            return d.toISOString(); 
        };
        const getMonthRange = (date) => {
            const d = safeDate(date);
            const y = d.getFullYear();
            const m = d.getMonth();
            return { firstDay: new Date(y, m, 1), lastDay: new Date(y, m + 1, 0, 23, 59, 59, 999) };
        };
        const getAccountCycleRange = (viewDate, startDay = 1) => {
            const d = safeDate(viewDate);
            const y = d.getFullYear();
            const m = d.getMonth();
            if (startDay === 1) return { start: new Date(y, m, 1), end: new Date(y, m + 1, 0, 23, 59, 59, 999), label: formatMonth(d) };
            const start = new Date(y, m, startDay);
            const end = new Date(y, m + 1, startDay - 1, 23, 59, 59, 999);
            return { start, end, label: `${start.getMonth()+1}/${start.getDate()} - ${end.getMonth()+1}/${end.getDate()}` };
        };
        const getBudgetRange = (currentViewDate, resetDay = 1) => getAccountCycleRange(currentViewDate, resetDay);
        const toLocalInputDate = (date) => {
            const d = safeDate(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const calculateAccountBalance = (account, transactions) => {
            if (!account || !transactions) return 0;
            let balance = parseFloat(account.initialBalance || 0);
            transactions.forEach(t => {
                const amount = parseFloat(t.amount);
                if (t.accountId === account.id) {
                    if (t.type === 'expense') balance -= amount;
                    if (t.type === 'income') balance += amount;
                    if (t.type === 'transfer_out') balance -= amount;
                }
                if (t.toAccountId === account.id && t.type === 'transfer_in') balance += amount;
            });
            return balance;
        };

        // --- ç¯„ä¾‹è³‡æ–™ ---
        const INITIAL_ACCOUNTS = [
            { id: 'a1', name: 'éŒ¢åŒ…ç¾é‡‘', type: 'cash', balance: 0, initialBalance: 3000 },
            { id: 'a2', name: 'è–ªè³‡å¸³æˆ¶', type: 'bank', balance: 0, initialBalance: 52000 },
            { id: 'a3', name: 'å°æ–°é»‘ç‹—å¡', type: 'credit', balance: 0, initialBalance: 0, creditLimit: 150000, statementDay: 1, dueDay: 15 },
        ];
        // æ›´æ–°ï¼šä½¿ç”¨ Component Name å­—ä¸²
        const INITIAL_CATEGORIES = [
            { id: 'c1', name: 'é¤é£²', type: 'expense', icon: 'Utensils', color: 'bg-orange-100 text-orange-600' },
            { id: 'c2', name: 'äº¤é€š', type: 'expense', icon: 'Bus', color: 'bg-blue-100 text-blue-600' },
            { id: 'c3', name: 'è³¼ç‰©', type: 'expense', icon: 'ShoppingBag', color: 'bg-pink-100 text-pink-600' },
            { id: 'c4', name: 'å¨›æ¨‚', type: 'expense', icon: 'Gamepad2', color: 'bg-purple-100 text-purple-600' },
            { id: 'c5', name: 'å±…ä½', type: 'expense', icon: 'Home', color: 'bg-green-100 text-green-600' },
            { id: 'c6', name: 'è–ªè³‡', type: 'income', icon: 'Banknote', color: 'bg-yellow-100 text-yellow-600' },
            { id: 'c7', name: 'çé‡‘', type: 'income', icon: 'Gem', color: 'bg-teal-100 text-teal-600' },
            { id: 'c11', name: 'è¨‚é–±', type: 'expense', icon: 'Repeat', color: 'bg-indigo-100 text-indigo-600' },
        ];
        const INITIAL_BUDGET = { amount: 25000, resetDay: 1, enabled: true };
        const INITIAL_RECURRING = [
             { id: 'r1', type: 'expense', amount: 390, categoryId: 'c11', accountId: 'a3', note: 'Netflix', nextDueDate: getRelativeDate(20), remainingCount: null, active: true, excludeFromBudget: false }
        ];
        const INITIAL_TRANSACTIONS = [
            { id: 't1', date: getRelativeDate(-5), type: 'income', amount: 60000, accountId: 'a2', categoryId: 'c6', note: 'åæœˆè–ªè³‡', verified: true, excludeFromBudget: false },
            { id: 't2', date: getRelativeDate(-2), type: 'expense', amount: 150, accountId: 'a1', categoryId: 'c1', note: 'ç‰›è‚‰éºµ', verified: true, excludeFromBudget: false },
            { id: 't3', date: getRelativeDate(-1), type: 'expense', amount: 1200, accountId: 'a3', categoryId: 'c2', note: 'åŠ æ²¹', verified: false, excludeFromBudget: false },
            { id: 't4', date: getRelativeDate(0), type: 'expense', amount: 450, accountId: 'a1', categoryId: 'c1', note: 'èšé¤', verified: false, excludeFromBudget: false },
            { id: 't5', date: getRelativeDate(0), type: 'expense', amount: 8000, accountId: 'a2', categoryId: 'c5', note: 'æˆ¿ç§Ÿ(ä¸è¨ˆé ç®—)', excludeFromBudget: true, verified: false },
        ];

        // --- å­å…ƒä»¶ ---

        const CustomDialog = ({ isOpen, type, title, message, onConfirm, onCancel, defaultValue = '' }) => {
            const [inputValue, setInputValue] = useState(defaultValue);
            useEffect(() => { if (isOpen) setInputValue(defaultValue); }, [isOpen, defaultValue]);
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                    <div className="bg-white rounded-2xl shadow-xl w-full max-w-xs overflow-hidden animate-in fade-in zoom-in duration-200">
                        <div className="p-5 text-center">
                            <div className="mx-auto mb-3 flex justify-center">
                                {type === 'alert' && <Icon name="AlertCircle" className="text-red-500" size={40} />}
                                {type === 'confirm' && <Icon name="AlertTriangle" className="text-amber-500" size={40} />}
                                {type === 'prompt' && <Icon name="Edit2" className="text-blue-500" size={40} />}
                            </div>
                            <h3 className="font-bold text-lg text-slate-800 mb-2">{title}</h3>
                            <p className="text-sm text-slate-500 mb-4">{message}</p>
                            {type === 'prompt' && <input type="number" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl mb-4 text-center font-bold text-lg" value={inputValue} onChange={(e) => setInputValue(e.target.value)} autoFocus />}
                            <div className="flex gap-2 justify-center">
                                {type !== 'alert' && <button onClick={onCancel} className="flex-1 py-3 px-4 rounded-xl bg-slate-100 text-slate-600 font-bold active:bg-slate-200 transition-colors">å–æ¶ˆ</button>}
                                <button onClick={() => onConfirm(type === 'prompt' ? inputValue : undefined)} className={`flex-1 py-3 px-4 rounded-xl font-bold text-white shadow-lg active:scale-95 transition-transform ${type === 'alert' ? 'bg-red-500' : 'bg-slate-900'}`}>ç¢ºå®š</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const SummaryCard = ({ title, amount, color, onClick }) => (
            <div onClick={onClick} className="bg-white p-3 rounded-xl shadow-sm flex-1 mx-1 border border-slate-100 cursor-pointer active:bg-slate-50">
                <div className="text-slate-500 text-xs mb-1 font-bold">{title}</div>
                <div className={`text-lg font-bold ${color}`}>{formatCurrency(amount)}</div>
            </div>
        );

        const TransactionItem = ({ tx, onClick, categories, accounts, handleToggleVerified, showCheckbox }) => {
            const cat = categories.find(c => c.id === tx.categoryId) || {};
            const acc = accounts.find(a => a.id === tx.accountId) || {};
            const isTransfer = tx.type.includes('transfer');
            const color = tx.type === 'income' || tx.type === 'transfer_in' ? 'text-green-600' : 'text-red-600';
            const sign = tx.type === 'income' || tx.type === 'transfer_in' ? '+' : '-';
            
            return (
                <div className="flex items-center justify-between p-3 bg-white mb-2 rounded-lg shadow-sm border border-slate-100" onClick={onClick}>
                    <div className="flex items-center gap-3 flex-1">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl bg-gray-100`}>
                            <Icon name={isTransfer ? "ArrowRightLeft" : (cat.icon || 'Tag')} size={18} />
                        </div>
                        <div>
                            <div className="font-bold text-slate-800 flex items-center gap-2">
                                {isTransfer ? 'è½‰å¸³' : (cat.name || 'æœªåˆ†é¡')}
                                {tx.installments > 1 && <span className="text-[10px] bg-blue-100 text-blue-600 px-1 rounded">åˆ†æœŸ</span>}
                                {tx.excludeFromBudget && <span className="text-[10px] bg-gray-200 text-gray-500 px-1 rounded">ä¸è¨ˆé ç®—</span>}
                            </div>
                            <div className="text-xs text-slate-500">
                                {safeDate(tx.date).toLocaleDateString()} â€¢ {acc.name}
                                {tx.note && <span className="ml-1 text-slate-400">({tx.note})</span>}
                            </div>
                        </div>
                    </div>
                    <div className="flex items-center gap-3">
                        <div className={`font-bold ${color}`}>{sign}{formatCurrency(tx.amount)}</div>
                        {showCheckbox && <button onClick={(e) => { e.stopPropagation(); handleToggleVerified(tx.id); }} className="text-slate-300">
                            {tx.verified ? <Icon name="CheckSquare" className="text-green-500" /> : <Icon name="Square" />}
                        </button>}
                    </div>
                </div>
            );
        };

        const DashboardView = ({ transactions, accounts, budget, categories, setView, setDrillDownData, setEditingTransaction, handleToggleVerified, currentViewDate, setCurrentViewDate, setActiveTab, recurringRules }) => {
            const { firstDay, lastDay } = getMonthRange(currentViewDate);
            const monthTx = transactions.filter(t => { const d = safeDate(t.date); return d >= firstDay && d <= lastDay; });
            const income = monthTx.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            const expense = monthTx.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
            const totalAssets = accounts.reduce((acc, cur) => acc + calculateAccountBalance(cur, transactions), 0);
            
            const budgetTx = monthTx.filter(t => t.type === 'expense' && !t.excludeFromBudget);
            const budgetUsed = budgetTx.reduce((s, t) => s + t.amount, 0);
            const budgetPct = budget.amount > 0 ? Math.min((budgetUsed / budget.amount) * 100, 100) : 0;

            const creditIds = accounts.filter(a => a.type === 'credit').map(a => a.id);
            const creditUsed = monthTx.filter(t => t.type === 'expense' && creditIds.includes(t.accountId)).reduce((s, t) => s + t.amount, 0);
            const creditTx = monthTx.filter(t => t.type === 'expense' && creditIds.includes(t.accountId));
            const futureInstallments = transactions.filter(t => t.type === 'expense' && creditIds.includes(t.accountId) && safeDate(t.date) > lastDay).reduce((s, t) => s + t.amount, 0);
            const futureTx = transactions.filter(t => t.type === 'expense' && creditIds.includes(t.accountId) && safeDate(t.date) > lastDay);
            const recurringSum = (recurringRules || []).filter(r => r.active).reduce((s, r) => s + parseFloat(r.amount), 0);

            return (
                <div className="space-y-4 pb-24">
                    <div className="flex items-center justify-between px-2">
                        <button onClick={() => setCurrentViewDate(new Date(currentViewDate.setMonth(currentViewDate.getMonth() - 1)))} className="p-2 bg-white rounded shadow-sm"><Icon name="ChevronLeft"/></button>
                        <div className="font-bold text-lg flex items-center gap-2"><Icon name="Calendar"/> {formatMonth(currentViewDate)}</div>
                        <button onClick={() => setCurrentViewDate(new Date(currentViewDate.setMonth(currentViewDate.getMonth() + 1)))} className="p-2 bg-white rounded shadow-sm"><Icon name="ChevronRight"/></button>
                    </div>

                    <div className="bg-slate-900 text-white p-6 rounded-2xl shadow-lg" onClick={() => setActiveTab('accounts')}>
                        <div className="text-sm opacity-70">æ·¨è³‡ç”¢ç¸½é¡</div>
                        <div className="text-3xl font-bold">{formatCurrency(totalAssets)}</div>
                    </div>

                    {budget.enabled && (
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200" onClick={() => { setDrillDownData({title: 'æœ¬æœˆé ç®—æ˜ç´°', txList: budgetTx}); setView('drill_down'); }}>
                            <div className="flex justify-between mb-2">
                                <span className="font-bold text-slate-700">æœ¬æœˆé ç®—</span>
                                <span className={budget.amount - budgetUsed < 0 ? 'text-red-500 font-bold' : 'text-green-600 font-bold'}>å‰©é¤˜ {formatCurrency(budget.amount - budgetUsed)}</span>
                            </div>
                            <div className="h-2 bg-slate-100 rounded-full overflow-hidden">
                                <div className={`h-full ${budgetPct > 90 ? 'bg-red-500' : 'bg-blue-500'}`} style={{width: `${budgetPct}%`}}></div>
                            </div>
                            <div className="text-xs text-right mt-1 text-slate-400">{formatCurrency(budgetUsed)} / {formatCurrency(budget.amount)}</div>
                        </div>
                    )}

                    <div className="grid grid-cols-3 gap-2">
                         <div className="bg-white p-2 rounded-xl border border-slate-200 text-center" onClick={() => { setDrillDownData({title:'æœ¬æœˆä¿¡ç”¨å¡æ¶ˆè²»', txList: creditTx}); setView('drill_down'); }}>
                            <div className="text-[10px] text-slate-500">ä¿¡ç”¨å¡æœ¬æœˆ</div>
                            <div className="font-bold text-slate-800">{formatCurrency(creditUsed)}</div>
                         </div>
                         <div className="bg-white p-2 rounded-xl border border-slate-200 text-center" onClick={() => { setDrillDownData({title:'æœªä¾†åˆ†æœŸé¤˜é¡', txList: futureTx}); setView('drill_down'); }}>
                            <div className="text-[10px] text-slate-500">åˆ†æœŸæœªåˆ°æœŸ</div>
                            <div className="font-bold text-blue-600">{formatCurrency(futureInstallments)}</div>
                         </div>
                         <div className="bg-white p-2 rounded-xl border border-slate-200 text-center" onClick={() => setView('recurring_manager')}>
                            <div className="text-[10px] text-slate-500">æ¯æœˆå›ºå®šæ”¯å‡º</div>
                            <div className="font-bold text-indigo-600">{formatCurrency(recurringSum)}</div>
                         </div>
                    </div>

                    <div className="flex gap-2">
                        <SummaryCard title="æœ¬æœˆæ”¶å…¥" amount={income} color="text-green-600" onClick={() => { setDrillDownData({title:'æœ¬æœˆæ”¶å…¥', txList: monthTx.filter(t=>t.type==='income')}); setView('drill_down'); }} />
                        <SummaryCard title="æœ¬æœˆæ”¯å‡º" amount={expense} color="text-red-600" onClick={() => { setDrillDownData({title:'æœ¬æœˆæ”¯å‡º', txList: monthTx.filter(t=>t.type==='expense')}); setView('drill_down'); }} />
                    </div>

                    <div>
                        <h3 className="font-bold text-slate-700 mb-2">è¿‘æœŸæ´»å‹•</h3>
                        {monthTx.sort((a,b) => safeDate(b.date) - safeDate(a.date)).slice(0, 10).map(tx => (
                            <TransactionItem key={tx.id} tx={tx} categories={categories} accounts={accounts} onClick={() => { setEditingTransaction(tx); setView('add_transaction'); }} handleToggleVerified={handleToggleVerified} />
                        ))}
                    </div>
                </div>
            );
        };

        const AccountsList = ({ accounts, setAccounts, transactions, setView, setSelectedAccount }) => {
            const moveAccount = (idx, dir) => {
                const newAcc = [...accounts];
                if (dir === 'up' && idx > 0) [newAcc[idx], newAcc[idx-1]] = [newAcc[idx-1], newAcc[idx]];
                if (dir === 'down' && idx < newAcc.length-1) [newAcc[idx], newAcc[idx+1]] = [newAcc[idx+1], newAcc[idx]];
                setAccounts(newAcc);
            };
            return (
                <div className="space-y-3 pb-24">
                    {accounts.map((acc, idx) => (
                        <div key={acc.id} className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex justify-between items-center" onClick={() => { setSelectedAccount(acc); setView('account_detail'); }}>
                            <div className="flex items-center gap-3">
                                <div className="bg-slate-100 p-2 rounded-full text-xl">{acc.type === 'credit' ? <Icon name="CreditCard"/> : acc.type === 'bank' ? <Icon name="Home"/> : <Icon name="DollarSign"/>}</div>
                                <div><div className="font-bold">{acc.name}</div><div className="text-xs text-slate-500 capitalize">{acc.type}</div></div>
                            </div>
                            <div className="flex items-center gap-2">
                                <div className="font-bold text-right">{formatCurrency(calculateAccountBalance(acc, transactions))}</div>
                                <div className="flex flex-col" onClick={e => e.stopPropagation()}>
                                    <button onClick={() => moveAccount(idx, 'up')} className="text-slate-300 hover:text-slate-600 disabled:opacity-20" disabled={idx===0}><Icon name="ArrowUp" size={14}/></button>
                                    <button onClick={() => moveAccount(idx, 'down')} className="text-slate-300 hover:text-slate-600 disabled:opacity-20" disabled={idx===accounts.length-1}><Icon name="ArrowDown" size={14}/></button>
                                </div>
                            </div>
                        </div>
                    ))}
                    <button onClick={() => { setSelectedAccount(null); setView('edit_account'); }} className="w-full py-3 border-2 border-dashed border-slate-300 rounded-xl text-slate-400 font-bold flex items-center justify-center gap-2"><Icon name="Plus"/> æ–°å¢å¸³æˆ¶</button>
                </div>
            );
        };

        const SettingsView = ({ setView, exportRange, setExportRange, exportCSV, handleImportCSV }) => (
            <div className="p-4 space-y-6 pb-24">
                <h2 className="text-xl font-bold">è¨­å®š</h2>
                <div className="bg-white rounded-xl p-4 shadow-sm border border-slate-100">
                    <h3 className="font-bold mb-4 text-sm text-slate-500 uppercase">åŠŸèƒ½è¨­å®š</h3>
                    <button onClick={() => setView('category_manager')} className="w-full flex items-center justify-between p-3 hover:bg-slate-50 rounded-lg"><div className="flex items-center gap-3"><Icon name="Tag" className="text-orange-500"/><span>é¡åˆ¥ç®¡ç†</span></div><Icon name="ChevronRight" className="text-slate-300"/></button>
                    <button onClick={() => setView('budget_settings')} className="w-full flex items-center justify-between p-3 hover:bg-slate-50 rounded-lg"><div className="flex items-center gap-3"><Icon name="Target" className="text-purple-500"/><span>é ç®—è¨­å®š</span></div><Icon name="ChevronRight" className="text-slate-300"/></button>
                    <button onClick={() => setView('recurring_manager')} className="w-full flex items-center justify-between p-3 hover:bg-slate-50 rounded-lg"><div className="flex items-center gap-3"><Icon name="Repeat" className="text-indigo-500"/><span>é€±æœŸæ€§å¸³å‹™ç®¡ç†</span></div><Icon name="ChevronRight" className="text-slate-300"/></button>
                </div>
                <div className="bg-white rounded-xl p-4 shadow-sm border border-slate-100">
                    <h3 className="font-bold mb-4 text-sm text-slate-500 uppercase">è³‡æ–™ç®¡ç†</h3>
                    <div className="flex gap-2 mb-3 px-3">
                        <div className="flex-1"><label className="text-[10px] text-slate-400 block mb-1 font-bold">åŒ¯å‡ºé–‹å§‹æ—¥æœŸ</label><input type="date" value={exportRange.start} onChange={e => setExportRange({...exportRange, start: e.target.value})} className="w-full p-2 bg-slate-50 rounded-lg text-xs border border-slate-200"/></div>
                        <div className="flex-1"><label className="text-[10px] text-slate-400 block mb-1 font-bold">åŒ¯å‡ºçµæŸæ—¥æœŸ</label><input type="date" value={exportRange.end} onChange={e => setExportRange({...exportRange, end: e.target.value})} className="w-full p-2 bg-slate-50 rounded-lg text-xs border border-slate-200"/></div>
                    </div>
                    <button onClick={exportCSV} className="w-full flex items-center justify-between p-3 hover:bg-slate-50 rounded-lg"><div className="flex items-center gap-3"><Icon name="Download" className="text-blue-500"/><span>åŒ¯å‡ºè³‡æ–™ (CSV)</span></div><Icon name="ChevronRight" className="text-slate-300"/></button>
                    <div className="relative w-full">
                        <button className="w-full flex items-center justify-between p-3 hover:bg-slate-50 rounded-lg"><div className="flex items-center gap-3"><Icon name="Upload" className="text-green-500"/><span>åŒ¯å…¥è³‡æ–™ (CSV)</span></div><Icon name="ChevronRight" className="text-slate-300"/></button>
                        <input type="file" accept=".csv" onChange={handleImportCSV} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"/>
                    </div>
                </div>
                <div className="text-center text-xs text-slate-300 pt-4">Minimalist Tracker v1.6 (Stable)</div>
            </div>
        );

        const AccountEditForm = ({ initialData, onClose, handleDeleteAccount, handleUpdateAccount }) => {
            const [form, setForm] = useState(initialData || {name: '', type: 'cash', initialBalance: 0});
            return (
                <div className="fixed inset-0 bg-white z-50 p-4">
                    <div className="flex items-center mb-4"><button onClick={onClose}><Icon name="X"/></button><h2 className="flex-1 text-center font-bold">å¸³æˆ¶è¨­å®š</h2></div>
                    <div className="space-y-4">
                        <div><label className="text-xs text-slate-500">å¸³æˆ¶åç¨±</label><input className="w-full p-3 bg-slate-50 rounded-lg mt-1" value={form.name} onChange={e=>setForm({...form, name: e.target.value})} /></div>
                        <div><label className="text-xs text-slate-500">é¡å‹</label><div className="flex gap-2 mt-1">{['cash', 'bank', 'credit'].map(t => (<button key={t} onClick={() => setForm({...form, type: t})} className={`flex-1 py-2 rounded-lg border ${form.type === t ? 'border-slate-800 bg-slate-100 font-bold' : 'border-slate-200'}`}>{t === 'cash' ? 'ç¾é‡‘' : t === 'bank' ? 'éŠ€è¡Œ' : 'ä¿¡ç”¨å¡'}</button>))}</div></div>
                        <div><label className="text-xs text-slate-500">åˆå§‹é¤˜é¡</label><input type="number" className="w-full p-3 bg-slate-50 rounded-lg mt-1" value={form.initialBalance} onChange={e=>setForm({...form, initialBalance: parseFloat(e.target.value)})} /></div>
                        {form.type === 'credit' && (<div className="bg-slate-50 p-4 rounded-lg space-y-3"><h4 className="font-bold text-sm">ä¿¡ç”¨å¡è¨­å®š</h4><div><label className="text-xs text-slate-500">ä¿¡ç”¨é¡åº¦</label><input type="number" className="w-full p-2 bg-white border rounded mt-1" value={form.creditLimit} onChange={e => setForm({...form, creditLimit: parseFloat(e.target.value)})} /></div><div className="flex gap-3"><div className="flex-1"><label className="text-xs text-slate-500">çµå¸³æ—¥</label><input type="number" className="w-full p-2 bg-white border rounded mt-1" value={form.statementDay} onChange={e => setForm({...form, statementDay: parseInt(e.target.value)})} /></div><div className="flex-1"><label className="text-xs text-slate-500">ç¹³æ¬¾æˆªæ­¢</label><input type="number" className="w-full p-2 bg-white border rounded mt-1" value={form.dueDay} onChange={e => setForm({...form, dueDay: parseInt(e.target.value)})} /></div></div></div>)}
                        <button onClick={()=>{ handleUpdateAccount({...form, isNew: !initialData}); onClose(); }} className="w-full bg-slate-900 text-white p-3 rounded-xl">å„²å­˜</button>
                        {initialData && <button onClick={()=>handleDeleteAccount(initialData.id)} className="w-full text-red-500 p-3 flex items-center justify-center gap-2"><Icon name="Trash2" size={16}/> åˆªé™¤å¸³æˆ¶</button>}
                    </div>
                </div>
            );
        };

        const AccountDetail = ({ selectedAccount, accounts, transactions, setView, setEditingTransaction, showPrompt, showAlert, showConfirm, handleAddTransaction, categories, handleToggleVerified }) => {
            const [viewDate, setViewDate] = useState(new Date());
            if (!selectedAccount) return null;
            const balance = calculateAccountBalance(selectedAccount, transactions);
            const statementDay = selectedAccount.type === 'credit' ? (selectedAccount.statementDay || 1) : 1;
            const { start, end, label } = getAccountCycleRange(viewDate, statementDay);

            const accTx = transactions
                .filter(t => t.accountId === selectedAccount.id || t.toAccountId === selectedAccount.id)
                .filter(t => { const d = safeDate(t.date); return d >= start && d <= end; })
                .sort((a, b) => safeDate(b.date) - safeDate(a.date));

            const verifiedBalance = accTx.filter(t => t.verified).reduce((sum, t) => { if (t.type === 'expense' || t.type === 'transfer_out') return sum - t.amount; if (t.type === 'income' || t.type === 'transfer_in') return sum + t.amount; return sum; }, 0);
            const currentPeriodNet = accTx.reduce((sum, t) => { if (t.type === 'expense') return sum - t.amount; if (t.type === 'income') return sum + t.amount; if (t.accountId === selectedAccount.id && t.type === 'transfer_out') return sum - t.amount; if (t.toAccountId === selectedAccount.id && t.type === 'transfer_in') return sum + t.amount; return sum; }, 0);

            const handleReconcile = () => {
                showPrompt('å°å¸³', `ç›®å‰ç¸½é¤˜é¡ ${formatCurrency(balance)}\nè«‹è¼¸å…¥å¯¦éš›é¤˜é¡ï¼š`, balance, (actualStr) => {
                    const actual = parseFloat(actualStr);
                    if (isNaN(actual)) return;
                    const diff = actual - balance;
                    if (Math.abs(diff) < 1) return showAlert('å°å¸³æˆåŠŸ', 'é‡‘é¡ç›¸ç¬¦');
                    showConfirm('å»ºç«‹èª¿æ•´äº¤æ˜“', `è¨ˆç®—å·®ç•°ç‚º ${formatCurrency(diff)}ï¼Œæ˜¯å¦è‡ªå‹•å»ºç«‹èª¿æ•´äº¤æ˜“ï¼Ÿ`, () => {
                        handleAddTransaction({ type: diff > 0 ? 'income' : 'expense', amount: Math.abs(diff), date: new Date().toISOString(), categoryId: diff > 0 ? 'c10' : 'c9', accountId: selectedAccount.id, note: 'å°å¸³èª¿æ•´', installments: 1 });
                    });
                });
            };

            const handlePayCard = () => {
                const amountToPay = currentPeriodNet < 0 ? Math.abs(currentPeriodNet) : 0;
                setEditingTransaction({ type: 'transfer', amount: amountToPay, date: new Date().toISOString(), toAccountId: selectedAccount.id, accountId: accounts.find(a => a.type === 'bank')?.id || '', note: `ç¹³äº¤ ${selectedAccount.name} (${label}) å¡è²»` });
                setView('add_transaction');
            };

            const prevMonth = () => setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth() - 1, 1));
            const nextMonth = () => setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 1));

            return (
                <div className="bg-slate-50 min-h-screen pb-safe">
                    <div className="bg-slate-900 text-white p-6 pb-12 sticky top-0 z-10">
                        <div className="flex items-center mb-4"><button onClick={() => setView('main')}><Icon name="ChevronLeft"/></button><h2 className="flex-1 text-center font-bold">{selectedAccount.name}</h2><button onClick={() => setView('edit_account')}><Icon name="Edit2" size={18} /></button></div>
                        <div className="text-center"><div className="text-slate-400 text-sm">ç•¶å‰ç¸½é¤˜é¡</div><div className="text-3xl font-bold my-1">{formatCurrency(balance)}</div>{selectedAccount.type === 'credit' && (<div className="text-xs text-slate-500">å¯ç”¨é¡åº¦: {formatCurrency((selectedAccount.creditLimit || 0) + balance)}</div>)}</div>
                        <div className="flex justify-center gap-3 mt-6">
                            <button onClick={handleReconcile} className="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-full text-sm flex items-center gap-2"><Icon name="CheckCircle" size={14}/> å°å¸³</button>
                            {selectedAccount.type === 'credit' && currentPeriodNet < 0 && (<button onClick={handlePayCard} className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-full text-sm flex items-center gap-2"><Icon name="CreditCard" size={14}/> ç¹³æœ¬æœŸå¸³å–®</button>)}
                        </div>
                    </div>
                    <div className="px-4 -mt-6">
                        <div className="bg-white rounded-xl shadow-sm min-h-[500px] p-2">
                            <div className="flex items-center justify-between p-2 mb-2 border-b border-slate-100 pb-3"><button onClick={prevMonth} className="p-1 hover:bg-slate-100 rounded"><Icon name="ChevronLeft" size={20} className="text-slate-400"/></button><div className="text-center"><div className="font-bold text-slate-800">{formatMonth(viewDate)}</div><div className="text-[10px] text-slate-400">é€±æœŸ: {label}</div></div><button onClick={nextMonth} className="p-1 hover:bg-slate-100 rounded"><Icon name="ChevronRight" size={20} className="text-slate-400"/></button></div>
                            <div className="text-center text-xs text-slate-500 mb-3 bg-slate-50 p-2 rounded-lg mx-2 border border-slate-100">å·²ç¢ºèªé‡‘é¡: <span className={`font-bold ${verifiedBalance < 0 ? 'text-red-500' : 'text-slate-700'}`}>{formatCurrency(verifiedBalance)}</span></div>
                            {accTx.map(tx => (<TransactionItem key={tx.id} tx={tx} onClick={() => { setEditingTransaction(tx); setView('add_transaction'); }} showCheckbox={true} categories={categories} accounts={accounts} handleToggleVerified={handleToggleVerified} />))}{accTx.length === 0 && <div className="text-center text-slate-400 py-10">æ­¤å€é–“ç„¡äº¤æ˜“ç´€éŒ„</div>}
                        </div>
                    </div>
                </div>
            );
        };

        const DrillDownView = ({ title, txList, setView, setEditingTransaction, categories, accounts, handleToggleVerified }) => {
            const sorted = [...txList].sort((a,b) => safeDate(b.date) - safeDate(a.date));
            const total = sorted.reduce((s, t) => s + (t.type==='income' || t.type==='transfer_in' ? t.amount : -t.amount), 0);
            const grouped = {};
            sorted.forEach(tx => {
                const d = safeDate(tx.date).toLocaleDateString('zh-TW');
                if(!grouped[d]) grouped[d] = [];
                grouped[d].push(tx);
            });
            return (
                <div className="fixed inset-0 bg-white z-40 overflow-y-auto pb-safe">
                    <div className="flex items-center p-4 border-b sticky top-0 bg-white"><button onClick={() => setView('main')}><Icon name="ChevronLeft"/></button><h2 className="flex-1 text-center font-bold">{title}</h2></div>
                    <div className="p-4 bg-slate-50 min-h-screen">
                        <div className="bg-slate-900 text-white p-4 rounded-xl mb-4 text-center"><div className="text-sm opacity-70">åˆè¨ˆ</div><div className="text-2xl font-bold">{formatCurrency(Math.abs(total))}</div></div>
                        {Object.entries(grouped).map(([date, txs]) => (
                            <div key={date} className="mb-4">
                                <div className="text-xs text-slate-500 font-bold mb-2 ml-1">{date}</div>
                                {txs.map(tx => (<TransactionItem key={tx.id} tx={tx} categories={categories} accounts={accounts} onClick={() => { setEditingTransaction(tx); setView('add_transaction'); }} handleToggleVerified={handleToggleVerified} showCheckbox={true} />))}
                            </div>
                        ))}
                        {sorted.length === 0 && <div className="text-center text-slate-400 py-10">ç„¡äº¤æ˜“ç´€éŒ„</div>}
                    </div>
                </div>
            );
        };

        const AddTransactionForm = ({ editingTransaction, setEditingTransaction, accounts, categories, handleAddTransaction, handleDeleteTransaction, setView }) => {
            const isEdit = !!editingTransaction;
            const [form, setForm] = useState(editingTransaction || {
                 id: generateId(), type: 'expense', amount: '', date: toInputDateTime(new Date()),
                 categoryId: categories[0]?.id || '', accountId: accounts[0]?.id, toAccountId: accounts[1]?.id,
                 note: '', installments: 1, excludeFromBudget: false, verified: false
            });
            const handleSubmit = () => { if (!form.amount) return; handleAddTransaction({ ...form, amount: parseFloat(form.amount), date: new Date(form.date).toISOString(), installments: parseInt(form.installments) }); };
            return (
                <div className="fixed inset-0 bg-white z-50 p-4 overflow-y-auto">
                    <div className="flex justify-between items-center mb-4">
                        <button onClick={() => { setView('main'); setEditingTransaction(null); }}><Icon name="X"/></button>
                        <h2 className="font-bold">{editingTransaction ? 'ç·¨è¼¯' : 'æ–°å¢'}äº¤æ˜“</h2>
                        {editingTransaction ? <button onClick={() => handleDeleteTransaction(editingTransaction.id)} className="text-red-500"><Icon name="Trash2"/></button> : <div className="w-5"></div>}
                    </div>
                    <div className="space-y-4">
                        <div className="flex gap-2">{['expense','income','transfer'].map(t => (<button key={t} onClick={() => setForm({...form, type: t})} className={`flex-1 py-2 rounded-lg border ${form.type === t ? 'bg-slate-900 text-white' : 'bg-white'}`}>{t==='expense'?'æ”¯å‡º':t==='income'?'æ”¶å…¥':'è½‰å¸³'}</button>))}</div>
                        <input type="number" value={form.amount} onChange={e => setForm({...form, amount: e.target.value})} className="w-full text-4xl font-bold border-b p-2" placeholder="0" autoFocus />
                        {form.type !== 'transfer' && (<div className="flex flex-wrap gap-2 max-h-40 overflow-y-auto">{categories.filter(c => c.type === (form.type==='expense'?'expense':'income')).map(c => (<button key={c.id} onClick={() => setForm({...form, categoryId: c.id})} className={`p-2 border rounded-lg flex flex-col items-center ${form.categoryId === c.id ? 'bg-slate-100 border-slate-400' : ''}`}><span className="text-xl"><Icon name={c.icon} /></span><span className="text-xs">{c.name}</span></button>))}</div>)}
                        <div className="flex gap-2">
                            <div className="flex-1"><label className="text-xs text-slate-500">{form.type === 'transfer' ? 'è½‰å‡º' : 'å¸³æˆ¶'}</label><select value={form.accountId} onChange={e => setForm({...form, accountId: e.target.value})} className="w-full p-2 border rounded">{accounts.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}</select></div>
                            {form.type === 'transfer' && (<div className="flex-1"><label className="text-xs text-slate-500">è½‰å…¥</label><select value={form.toAccountId} onChange={e => setForm({...form, toAccountId: e.target.value})} className="w-full p-2 border rounded">{accounts.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}</select></div>)}
                        </div>
                        <input type="datetime-local" value={form.date} onChange={e => setForm({...form, date: e.target.value})} className="w-full p-2 border rounded" />
                        <div className="flex gap-2">
                             {!editingTransaction && form.type === 'expense' && accounts.find(a=>a.id===form.accountId)?.type === 'credit' && (<div className="w-1/3"><label className="text-xs text-slate-500">åˆ†æœŸ(æœˆ)</label><input type="number" min="1" value={form.installments} onChange={e => setForm({...form, installments: e.target.value})} className="w-full p-2 border rounded" /></div>)}
                             <div className="flex-1 flex items-center p-2 bg-slate-50 rounded border"><input type="checkbox" checked={form.excludeFromBudget} onChange={e => setForm({...form, excludeFromBudget: e.target.checked})} className="mr-2 h-5 w-5" /><span className="text-sm">ä¸åˆ—å…¥æœˆé ç®—</span></div>
                        </div>
                        <input type="text" value={form.note} onChange={e => setForm({...form, note: e.target.value})} className="w-full p-2 border rounded" placeholder="å‚™è¨»..." />
                        <button onClick={handleSubmit} className="w-full bg-slate-900 text-white py-3 rounded-xl font-bold mt-4">å„²å­˜</button>
                    </div>
                 </div>
            );
        };

        const StatsView = ({ statsPeriod, setStatsPeriod, customRange, setCustomRange, transactions, categories, setDrillDownData, setView, setEditingTransaction, accounts, handleToggleVerified }) => {
            const now = new Date();
            let start = new Date();
            let end = new Date();
            if (statsPeriod === 'day') { start = new Date(now.getFullYear(), now.getMonth(), now.getDate()); end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59); } 
            else if (statsPeriod === 'week') { const day = now.getDay(); const diff = now.getDate() - day + (day === 0 ? -6 : 1); start = new Date(now.setDate(diff)); start.setHours(0,0,0,0); end = new Date(start); end.setDate(start.getDate() + 6); end.setHours(23,59,59,999); } 
            else if (statsPeriod === 'month') { start = new Date(now.getFullYear(), now.getMonth(), 1); end = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59); } 
            else if (statsPeriod === 'year') { start = new Date(now.getFullYear(), 0, 1); end = new Date(now.getFullYear(), 11, 31, 23, 59, 59); } 
            else if (statsPeriod === 'custom') { start = safeDate(customRange.start); end = safeDate(customRange.end); end.setHours(23,59,59,999); }
            const filteredTx = transactions.filter(t => { const d = safeDate(t.date); return d >= start && d <= end && t.type === 'expense'; });
            const totalExpense = filteredTx.reduce((sum, t) => sum + t.amount, 0);
            const catStats = categories.filter(c => c.type === 'expense').map(c => { const txs = filteredTx.filter(t => t.categoryId === c.id); const sum = txs.reduce((s, t) => s + t.amount, 0); return { ...c, sum, txs }; }).filter(c => c.sum > 0).sort((a, b) => b.sum - a.sum);
            return (
                <div className="pb-24"><h2 className="text-xl font-bold mb-4">çµ±è¨ˆåˆ†æ</h2><div className="flex bg-slate-200 p-1 rounded-lg mb-4 overflow-x-auto">{['day', 'week', 'month', 'year', 'custom'].map(p => (<button key={p} onClick={() => setStatsPeriod(p)} className={`flex-1 min-w-[50px] text-xs py-2 rounded-md capitalize whitespace-nowrap transition-all ${statsPeriod === p ? 'bg-white shadow-sm font-bold text-slate-800' : 'text-slate-500'}`}>{p === 'day' ? 'ä»Šæ—¥' : p === 'week' ? 'æœ¬é€±' : p === 'month' ? 'æœ¬æœˆ' : p === 'year' ? 'ä»Šå¹´' : 'è‡ªè¨‚'}</button>))}</div>{statsPeriod === 'custom' && (<div className="bg-white p-3 rounded-xl mb-4 flex items-center gap-2 shadow-sm border border-slate-100"><input type="date" value={customRange.start} onChange={e => setCustomRange({...customRange, start: e.target.value})} className="flex-1 bg-slate-50 border-none rounded p-1 text-sm" /><span className="text-slate-400">to</span><input type="date" value={customRange.end} onChange={e => setCustomRange({...customRange, end: e.target.value})} className="flex-1 bg-slate-50 border-none rounded p-1 text-sm" /></div>)}<div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 text-center mb-6"><div className="text-slate-500 mb-1">ç¸½æ”¯å‡º</div><div className="text-3xl font-bold text-slate-800">{formatCurrency(totalExpense)}</div><div className="text-xs text-slate-400 mt-2">{formatDateTime(start.toISOString())} ~ {formatDateTime(end.toISOString())}</div></div><div className="space-y-3">{catStats.map(c => (<div key={c.id} onClick={() => { setDrillDownData({ title: `${c.name} - æ˜ç´°`, txList: c.txs }); setView('drill_down'); }} className="flex items-center gap-3 active:bg-slate-50 p-2 -mx-2 rounded-lg cursor-pointer"><div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm ${c.color}`}>{c.icon ? <Icon name={c.icon}/> : 'ğŸ·ï¸'}</div><div className="flex-1"><div className="flex justify-between mb-1"><span className="text-sm font-medium">{c.name}</span><span className="text-sm font-bold flex items-center gap-1">{formatCurrency(c.sum)}<Icon name="ChevronRight" size={14} className="text-slate-300"/></span></div><div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden"><div className="h-full bg-slate-800 rounded-full" style={{ width: `${(c.sum / totalExpense) * 100}%` }}></div></div></div></div>))}{catStats.length === 0 && <div className="text-center text-slate-400 py-10">æ­¤å€é–“ç„¡æ”¯å‡ºè³‡æ–™</div>}</div></div>
            );
        };

        const CategoryManager = ({ categories, setCategories, setView, showConfirm }) => {
            const [editingId, setEditingId] = useState(null);
            const [newCatName, setNewCatName] = useState('');
            const [newCatType, setNewCatType] = useState('expense');
            const [newCatIcon, setNewCatIcon] = useState('Tag');
            const [activeTab, setActiveTab] = useState('expense');

            useEffect(() => {
                if (editingId) {
                    const cat = categories.find(c => c.id === editingId);
                    if (cat) { setNewCatName(cat.name); setNewCatType(cat.type); setNewCatIcon(cat.icon); setActiveTab(cat.type); }
                } else { setNewCatName(''); setNewCatIcon('Tag'); }
            }, [editingId, categories]);

            const handleSave = () => {
                if(!newCatName) return;
                if (editingId) {
                    setCategories(categories.map(c => c.id === editingId ? { ...c, name: newCatName, type: newCatType, icon: newCatIcon } : c));
                    setEditingId(null);
                } else {
                    setCategories([...categories, { id: generateId(), name: newCatName, type: newCatType, icon: newCatIcon, color: 'bg-slate-100 text-slate-600' }]);
                }
                setNewCatName('');
            };
            const handleDelete = (id) => { showConfirm('åˆªé™¤é¡åˆ¥', 'ç¢ºå®šåˆªé™¤å—ï¼Ÿ', () => { setCategories(categories.filter(c => c.id !== id)); }); };
            const moveCategory = (id, direction) => {
                const currentTypeCats = categories.filter(c => c.type === activeTab);
                const currentIndexInType = currentTypeCats.findIndex(c => c.id === id);
                if (currentIndexInType === -1) return;
                let targetCat = null;
                if (direction === 'up' && currentIndexInType > 0) targetCat = currentTypeCats[currentIndexInType - 1];
                else if (direction === 'down' && currentIndexInType < currentTypeCats.length - 1) targetCat = currentTypeCats[currentIndexInType + 1];
                if (targetCat) {
                    const idx1 = categories.findIndex(c => c.id === id);
                    const idx2 = categories.findIndex(c => c.id === targetCat.id);
                    const newCategories = [...categories];
                    [newCategories[idx1], newCategories[idx2]] = [newCategories[idx2], newCategories[idx1]];
                    setCategories(newCategories);
                }
            };
            const displayCategories = categories.filter(c => c.type === activeTab);
            return (
                <div className="fixed inset-0 bg-white z-50 overflow-y-auto">
                    <div className="flex items-center p-4 border-b bg-white sticky top-0"><button onClick={() => setView('settings')}><Icon name="ChevronLeft"/></button><h2 className="flex-1 text-center font-bold">é¡åˆ¥ç®¡ç†</h2></div>
                    <div className="p-4 space-y-4 pb-safe">
                        <div className="bg-slate-50 p-4 rounded-xl space-y-3 sticky top-16 z-10 shadow-sm border border-slate-200">
                            <h3 className="font-bold text-sm flex justify-between items-center">{editingId ? 'ç·¨è¼¯é¡åˆ¥' : 'æ–°å¢é¡åˆ¥'}{editingId && <button onClick={() => setEditingId(null)} className="text-xs text-blue-500">å–æ¶ˆç·¨è¼¯</button>}</h3>
                            <div className="flex gap-2"><button onClick={() => { setNewCatType('expense'); setActiveTab('expense'); }} className={`flex-1 py-2 text-xs rounded-lg border transition-colors ${newCatType==='expense'?'bg-slate-900 text-white font-bold':'bg-white text-slate-500 border-slate-300'}`}>æ”¯å‡º</button><button onClick={() => { setNewCatType('income'); setActiveTab('income'); }} className={`flex-1 py-2 text-xs rounded-lg border transition-colors ${newCatType==='income'?'bg-slate-900 text-white font-bold':'bg-white text-slate-500 border-slate-300'}`}>æ”¶å…¥</button></div>
                            <div className="flex gap-2"><input value={newCatIcon} onChange={e => setNewCatIcon(e.target.value)} className="w-12 text-center p-2 rounded-lg border" placeholder="åœ–" /><input value={newCatName} onChange={e => setNewCatName(e.target.value)} className="flex-1 p-2 rounded-lg border" placeholder="é¡åˆ¥åç¨±" /><button onClick={handleSave} className="bg-slate-900 text-white px-4 rounded-lg text-sm whitespace-nowrap">{editingId ? 'æ›´æ–°' : 'æ–°å¢'}</button></div>
                        </div>
                        <div className="flex border-b border-slate-200"><button onClick={() => setActiveTab('expense')} className={`flex-1 py-3 text-sm font-bold border-b-2 ${activeTab === 'expense' ? 'border-slate-900 text-slate-900' : 'border-transparent text-slate-400'}`}>æ”¯å‡ºé¡åˆ¥</button><button onClick={() => setActiveTab('income')} className={`flex-1 py-3 text-sm font-bold border-b-2 ${activeTab === 'income' ? 'border-slate-900 text-slate-900' : 'border-transparent text-slate-400'}`}>æ”¶å…¥é¡åˆ¥</button></div>
                        <div className="space-y-2">{displayCategories.map((c, index) => (<div key={c.id} className={`flex items-center justify-between p-3 border rounded-lg ${editingId === c.id ? 'bg-blue-50 border-blue-200' : 'bg-white border-slate-100'}`}><div className="flex items-center gap-3"><div className={`w-8 h-8 rounded-full flex items-center justify-center ${c.color}`}>{c.icon ? <Icon name={c.icon} size={16}/> : 'ğŸ·ï¸'}</div><div><div className="text-sm font-medium">{c.name}</div></div></div><div className="flex items-center gap-1"><div className="flex flex-col mr-2"><button onClick={() => moveCategory(c.id, 'up')} className="text-slate-300 hover:text-slate-600 disabled:opacity-30" disabled={index === 0}><Icon name="ArrowUp" size={14}/></button><button onClick={() => moveCategory(c.id, 'down')} className="text-slate-300 hover:text-slate-600 disabled:opacity-30" disabled={index === displayCategories.length - 1}><Icon name="ArrowDown" size={14}/></button></div><button onClick={() => setEditingId(c.id)} className="text-slate-400 hover:text-blue-500 p-2"><Icon name="Pencil" size={16}/></button><button onClick={() => handleDelete(c.id)} className="text-slate-400 hover:text-red-500 p-2"><Icon name="Trash2" size={16}/></button></div></div>))}</div>
                    </div>
                </div>
            );
        };

        const RecurringManager = ({ recurringRules, setRecurringRules, setView, setEditingRecurring, handleToggleRecurring, handleDeleteRecurring }) => {
            const totalMonthly = (recurringRules || []).filter(r => r.active).reduce((sum, r) => sum + parseFloat(r.amount), 0);
            return (
                <div className="fixed inset-0 bg-white z-50 overflow-y-auto">
                    <div className="flex items-center p-4 border-b bg-white sticky top-0"><button onClick={() => setView('settings')}><Icon name="ChevronLeft"/></button><h2 className="flex-1 text-center font-bold">é€±æœŸæ€§å¸³å‹™ç®¡ç†</h2><button onClick={() => { setEditingRecurring(null); setView('add_recurring'); }}><Icon name="Plus" className="text-blue-600"/></button></div>
                    <div className="p-4 pb-24">
                        <div className="bg-indigo-50 p-4 rounded-xl mb-6 flex justify-between items-center text-indigo-900"><span className="font-bold flex items-center gap-2"><Icon name="Repeat" size={16}/> æ¯æœˆå›ºå®šæ”¯å‡ºç¸½å’Œ</span><span className="text-xl font-bold">{formatCurrency(totalMonthly)}</span></div>
                        <div className="space-y-3">{recurringRules.map(rule => (<div key={rule.id} onClick={() => { setEditingRecurring(rule); setView('add_recurring'); }} className={`p-4 rounded-xl border ${rule.active ? 'bg-white border-slate-200' : 'bg-slate-50 border-slate-100 opacity-70'} cursor-pointer active:bg-slate-50`}><div className="flex justify-between items-start mb-2"><div><div className="font-bold text-lg">{rule.note}</div><div className="text-xs text-slate-500">ä¸‹æ¬¡åŸ·è¡Œ: {toInputDate(rule.nextDueDate)} | å‰©é¤˜: {rule.remainingCount === null ? 'ç„¡é™' : rule.remainingCount}</div></div><div className="font-bold text-slate-800">{formatCurrency(rule.amount)}</div></div><div className="flex justify-end gap-2 mt-2"><button onClick={(e) => { e.stopPropagation(); handleToggleRecurring(rule.id); }} className={`px-3 py-1 rounded-full text-xs font-bold ${rule.active ? 'bg-amber-100 text-amber-700' : 'bg-green-100 text-green-700'}`}>{rule.active ? 'æš«åœ' : 'å•Ÿç”¨'}</button><button onClick={(e) => { e.stopPropagation(); handleDeleteRecurring(rule.id); }} className="px-3 py-1 rounded-full text-xs font-bold bg-red-100 text-red-600">çµ‚æ­¢/åˆªé™¤</button></div></div>))}</div>
                    </div>
                </div>
            );
        };

        const AddRecurringForm = ({ editingRecurring, handleUpdateRecurring, accounts, categories, setView }) => {
            const [form, setForm] = useState(() => {
                if (editingRecurring) { return { ...editingRecurring, nextDueDate: toInputDate(editingRecurring.nextDueDate), remainingCount: editingRecurring.remainingCount === null ? '' : editingRecurring.remainingCount, excludeFromBudget: editingRecurring.excludeFromBudget || false }; }
                return { amount: '', categoryId: 'c11', accountId: accounts[0]?.id, note: '', nextDueDate: toInputDate(new Date()), remainingCount: '', excludeFromBudget: false };
            });
            const save = () => { if (!form.amount || !form.note) return; handleUpdateRecurring({ ...form, id: editingRecurring ? editingRecurring.id : undefined, type: 'expense', remainingCount: form.remainingCount === '' ? null : parseInt(form.remainingCount), nextDueDate: new Date(form.nextDueDate).toISOString() }); };
            return (
                <div className="fixed inset-0 bg-white z-[60] overflow-y-auto">
                    <div className="flex items-center p-4 border-b"><button onClick={() => setView('recurring_manager')}><Icon name="X"/></button><h2 className="flex-1 text-center font-bold">{editingRecurring ? 'ç·¨è¼¯é€±æœŸæ€§å¸³å‹™' : 'æ–°å¢é€±æœŸæ€§å¸³å‹™'}</h2><button onClick={save} className="text-blue-600 font-bold">å„²å­˜</button></div>
                    <div className="p-4 space-y-4">
                             <div><label className="text-xs text-slate-500">é‡‘é¡</label><input type="number" className="w-full p-3 bg-slate-50 rounded-lg mt-1" value={form.amount} onChange={e => setForm({...form, amount: e.target.value})} autoFocus /></div>
                             <div><label className="text-xs text-slate-500">åç¨±</label><input className="w-full p-3 bg-slate-50 rounded-lg mt-1" value={form.note} onChange={e => setForm({...form, note: e.target.value})} /></div>
                             <div><label className="text-xs text-slate-500">é¦–æ¬¡æ‰£æ¬¾æ—¥æœŸ</label><input type="date" className="w-full p-3 bg-slate-50 rounded-lg mt-1" value={form.nextDueDate} onChange={e => setForm({...form, nextDueDate: e.target.value})} /></div>
                             <div><label className="text-xs text-slate-500">å¾ªç’°æ¬¡æ•¸ (ç•™ç©ºç‚ºç„¡é™)</label><input type="number" className="w-full p-3 bg-slate-50 rounded-lg mt-1" placeholder="âˆ" value={form.remainingCount} onChange={e => setForm({...form, remainingCount: e.target.value})} /></div>
                             <div><label className="text-xs text-slate-500">æ‰£æ¬¾å¸³æˆ¶</label><select className="w-full p-3 bg-slate-50 rounded-lg mt-1" value={form.accountId} onChange={e => setForm({...form, accountId: e.target.value})}>{accounts.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}</select></div>
                             <div><label className="text-xs text-slate-500">é¡åˆ¥</label><select className="w-full p-3 bg-slate-50 rounded-lg mt-1" value={form.categoryId} onChange={e => setForm({...form, categoryId: e.target.value})}>{categories.filter(c => c.type === 'expense').map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
                             <div className="flex items-center p-3 bg-slate-50 rounded-lg mt-1"><input type="checkbox" id="recurExclude" checked={form.excludeFromBudget} onChange={e => setForm({...form, excludeFromBudget: e.target.checked})} className="w-5 h-5 accent-slate-800 mr-3" /><label htmlFor="recurExclude" className="text-sm text-slate-700">ä¸åˆ—å…¥æœˆé ç®—</label></div>
                    </div>
                </div>
            );
        };

        const BudgetSettings = ({ budget, setBudget, setView }) => (
            <div className="fixed inset-0 bg-white z-50 overflow-y-auto">
                <div className="flex items-center p-4 border-b"><button onClick={() => setView('main')}><Icon name="X"/></button><h2 className="flex-1 text-center font-bold">é ç®—è¨­å®š</h2><button onClick={() => setView('main')} className="text-blue-600 font-bold">å®Œæˆ</button></div>
                <div className="p-4 space-y-6 pb-safe">
                    <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg"><span>å•Ÿç”¨é ç®—åŠŸèƒ½</span><input type="checkbox" checked={budget.enabled} onChange={e => setBudget({...budget, enabled: e.target.checked})} className="w-6 h-6 accent-blue-600"/></div>
                    {budget.enabled && (<><div className="flex flex-col gap-1"><label className="text-sm font-bold text-slate-700">æ¯æœˆé ç®—é‡‘é¡</label><input type="number" value={budget.amount} onChange={e => setBudget({...budget, amount: parseFloat(e.target.value)})} className="w-full p-4 bg-slate-50 rounded-xl text-xl font-bold border border-slate-200"/></div><div className="flex flex-col gap-1"><label className="text-sm font-bold text-slate-700">é ç®—èµ·å§‹æ—¥ (æ¯æœˆå¹¾è™Ÿ)</label><input type="number" min="1" max="31" value={budget.resetDay} onChange={e => setBudget({...budget, resetDay: parseInt(e.target.value)})} className="w-full p-4 bg-slate-50 rounded-xl text-xl font-bold border border-slate-200"/></div></>)}
                </div>
            </div>
        );

        function MinimalistTracker() {
            const [activeTab, setActiveTab] = useState('home');
            const [view, setView] = useState('main');
            const [transactions, setTransactions] = useState([]);
            const [accounts, setAccounts] = useState(INITIAL_ACCOUNTS);
            const [categories, setCategories] = useState(INITIAL_CATEGORIES);
            const [budget, setBudget] = useState(INITIAL_BUDGET);
            const [recurringRules, setRecurringRules] = useState(INITIAL_RECURRING);
            const [selectedAccount, setSelectedAccount] = useState(null);
            const [editingTransaction, setEditingTransaction] = useState(null);
            const [drillDownData, setDrillDownData] = useState(null);
            const [currentViewDate, setCurrentViewDate] = useState(new Date());
            const [editingRecurring, setEditingRecurring] = useState(null);
            const [statsPeriod, setStatsPeriod] = useState('month'); 
            const [customRange, setCustomRange] = useState({ start: toInputDate(), end: toInputDate() });
            const [exportRange, setExportRange] = useState({ start: toInputDate(new Date()), end: toInputDate(new Date()) });

            const [dialogConfig, setDialogConfig] = useState({ isOpen: false, type: 'confirm', title: '', message: '', onConfirm: () => {}, onCancel: () => {} });
            const showConfirm = (title, message, onConfirm) => { setDialogConfig({ isOpen: true, type: 'confirm', title, message, onConfirm: () => { setDialogConfig(prev => ({...prev, isOpen: false})); onConfirm(); }, onCancel: () => setDialogConfig(prev => ({...prev, isOpen: false})) }); };
            const showAlert = (title, message) => { setDialogConfig({ isOpen: true, type: 'alert', title, message, onConfirm: () => setDialogConfig(prev => ({...prev, isOpen: false})), onCancel: () => {} }); };
            const showPrompt = (title, message, defaultValue, onConfirm) => { setDialogConfig({ isOpen: true, type: 'prompt', title, message, defaultValue, onConfirm: (val) => { setDialogConfig(prev => ({...prev, isOpen: false})); onConfirm(val); }, onCancel: () => setDialogConfig(prev => ({...prev, isOpen: false})) }); };

            useEffect(() => {
                const savedTx = localStorage.getItem('minTrack_transactions');
                if (!savedTx) {
                    setTransactions(INITIAL_TRANSACTIONS);
                } else {
                    setTransactions(JSON.parse(savedTx));
                    setAccounts(JSON.parse(localStorage.getItem('minTrack_accounts')) || INITIAL_ACCOUNTS);
                    setCategories(JSON.parse(localStorage.getItem('minTrack_categories')) || INITIAL_CATEGORIES);
                    setBudget(JSON.parse(localStorage.getItem('minTrack_budget')) || INITIAL_BUDGET);
                    setRecurringRules(JSON.parse(localStorage.getItem('minTrack_recurring')) || INITIAL_RECURRING);
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('minTrack_transactions', JSON.stringify(transactions));
                localStorage.setItem('minTrack_accounts', JSON.stringify(accounts));
                localStorage.setItem('minTrack_categories', JSON.stringify(categories));
                localStorage.setItem('minTrack_budget', JSON.stringify(budget));
                localStorage.setItem('minTrack_recurring', JSON.stringify(recurringRules));
            }, [transactions, accounts, categories, budget, recurringRules]);

            const handleAddTransaction = (data) => {
                 setTransactions(prev => {
                     let newTxs = [...prev];
                     if (data.id && prev.find(t=>t.id===data.id)) {
                         newTxs = newTxs.map(t => t.id === data.id ? data : t);
                     } else {
                         newTxs.push(data);
                         if(data.installments > 1 && data.type === 'expense') {
                             const base = Math.floor(data.amount / data.installments);
                             const start = new Date(data.date);
                             for(let i=1; i<data.installments; i++) {
                                 const d = new Date(start); d.setMonth(d.getMonth() + i);
                                 newTxs.push({...data, id: generateId(), amount: base, date: d.toISOString(), note: `${data.note} (${i+1}/${data.installments})`, installments: 1});
                             }
                             data.amount = base + (data.amount % data.installments);
                             data.note = `${data.note} (1/${data.installments})`;
                         }
                     }
                     return newTxs;
                 });
                 setView('main');
                 setEditingTransaction(null);
            };

            const handleDeleteTransaction = (id) => {
                showConfirm('åˆªé™¤äº¤æ˜“', 'ç¢ºå®šåˆªé™¤ï¼Ÿ', () => {
                    setTransactions(prev => prev.filter(t => t.id !== id && t.relatedTxId !== id));
                    setView('main');
                });
            };
            
            const handleUpdateAccount = (acc) => {
                if(acc.isNew) { const {isNew, ...rest} = acc; setAccounts(prev => [...prev, {...rest, id: generateId()}]); }
                else { setAccounts(prev => prev.map(a => a.id === acc.id ? acc : a)); }
            };

            const handleDeleteAccount = (id) => {
                if(Math.abs(calculateAccountBalance(accounts.find(a=>a.id===id), transactions)) > 0) return showAlert('éŒ¯èª¤', 'å¸³æˆ¶ä»æœ‰é¤˜é¡');
                showConfirm('åˆªé™¤', 'ç¢ºå®šåˆªé™¤å¸³æˆ¶ï¼Ÿ', () => { setAccounts(prev => prev.filter(a=>a.id!==id)); setView('main'); });
            };

            const handleToggleVerified = (id) => setTransactions(prev => prev.map(t => t.id === id ? { ...t, verified: !t.verified } : t));

            const handleUpdateRecurring = (rule) => {
                 setRecurringRules(prev => {
                     if (rule.id) return prev.map(r => r.id === rule.id ? rule : r);
                     return [...prev, {...rule, id: generateId(), active: true}];
                 });
                 setView('recurring_manager');
            };

            const handleToggleRecurring = (id) => setRecurringRules(prev => prev.map(r => r.id === id ? { ...r, active: !r.active } : r));
            const handleDeleteRecurring = (id) => showConfirm('åˆªé™¤', 'ç¢ºå®šåˆªé™¤ï¼Ÿ', () => setRecurringRules(prev => prev.filter(r => r.id !== id)));

            const exportCSV = () => {
                 const rows = transactions.map(t => `${t.date},${t.type},${t.amount},${t.note || ''}`);
                 const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + ["Date,Type,Amount,Note", ...rows].join('\n');
                 const link = document.createElement("a"); link.href = encodeURI(csvContent); link.download = "data.csv"; document.body.appendChild(link); link.click();
            };
            const handleImportCSV = () => { showAlert('æç¤º', 'åŒ¯å…¥åŠŸèƒ½åœ¨ç²¾ç°¡ç‰ˆä¸­æš«æ™‚éš±è—ä»¥ç¢ºä¿ç©©å®š'); };

            return (
                <div className="max-w-md mx-auto bg-slate-50 min-h-screen relative font-sans text-slate-800">
                    <div className="p-4 flex items-center justify-center bg-white border-b sticky top-0 z-20"><h1 className="font-bold text-lg">æ¥µç°¡è¨˜å¸³ (ç¯„ä¾‹ç‰ˆ)</h1></div>
                    <div className="p-4 min-h-[80vh]">
                        {activeTab === 'home' && <DashboardView currentViewDate={currentViewDate} setCurrentViewDate={setCurrentViewDate} transactions={transactions} accounts={accounts} budget={budget} recurringRules={recurringRules} setActiveTab={setActiveTab} setDrillDownData={setDrillDownData} setView={setView} setEditingTransaction={setEditingTransaction} categories={categories} handleToggleVerified={handleToggleVerified} />}
                        {activeTab === 'accounts' && <AccountsList accounts={accounts} setAccounts={setAccounts} transactions={transactions} setView={setView} setSelectedAccount={setSelectedAccount} />}
                        {activeTab === 'stats' && <StatsView statsPeriod={statsPeriod} setStatsPeriod={setStatsPeriod} customRange={customRange} setCustomRange={setCustomRange} transactions={transactions} categories={categories} setDrillDownData={setDrillDownData} setView={setView} setEditingTransaction={setEditingTransaction} accounts={accounts} handleToggleVerified={handleToggleVerified} />}
                        {activeTab === 'settings' && <SettingsView setView={setView} exportRange={exportRange} setExportRange={setExportRange} exportCSV={exportCSV} handleImportCSV={handleImportCSV} />}
                    </div>
                    <div className="fixed bottom-0 left-0 w-full bg-white border-t flex justify-around items-center p-2 pb-safe z-30">
                        <button onClick={() => setActiveTab('home')} className={`p-2 flex flex-col items-center ${activeTab==='home'?'text-slate-900':'text-slate-400'}`}><Icon name="Home"/><span className="text-[10px]">ç¸½è¦½</span></button>
                        <button onClick={() => setActiveTab('accounts')} className={`p-2 flex flex-col items-center ${activeTab==='accounts'?'text-slate-900':'text-slate-400'}`}><Icon name="CreditCard"/><span className="text-[10px]">å¸³æˆ¶</span></button>
                        <button onClick={() => { setEditingTransaction(null); setView('add_transaction'); }} className="bg-slate-900 text-white rounded-full w-12 h-12 flex items-center justify-center -mt-6 shadow-lg"><Icon name="Plus" size={24}/></button>
                        <button onClick={() => setActiveTab('stats')} className={`p-2 flex flex-col items-center ${activeTab==='stats'?'text-slate-900':'text-slate-400'}`}><Icon name="PieChart"/><span className="text-[10px]">çµ±è¨ˆ</span></button>
                        <button onClick={() => setActiveTab('settings')} className={`p-2 flex flex-col items-center ${activeTab==='settings'?'text-slate-900':'text-slate-400'}`}><Icon name="Settings"/><span className="text-[10px]">è¨­å®š</span></button>
                    </div>

                    <CustomDialog isOpen={dialogConfig.isOpen} type={dialogConfig.type} title={dialogConfig.title} message={dialogConfig.message} onConfirm={dialogConfig.onConfirm} onCancel={dialogConfig.onCancel} defaultValue={dialogConfig.defaultValue} />

                    {view === 'add_transaction' && <div className="fixed inset-0 z-40 bg-white"><AddTransactionForm editingTransaction={editingTransaction} setEditingTransaction={setEditingTransaction} accounts={accounts} categories={categories} handleAddTransaction={handleAddTransaction} handleDeleteTransaction={handleDeleteTransaction} setView={setView} /></div>}
                    {view === 'account_detail' && <div className="fixed inset-0 z-40 bg-white"><AccountDetail selectedAccount={selectedAccount} accounts={accounts} transactions={transactions} setView={setView} setEditingTransaction={setEditingTransaction} showPrompt={showPrompt} showAlert={showAlert} showConfirm={showConfirm} handleAddTransaction={handleAddTransaction} categories={categories} handleToggleVerified={handleToggleVerified} calculateAccountBalance={calculateAccountBalance} /></div>}
                    {view === 'edit_account' && <div className="fixed inset-0 z-40 bg-white"><AccountEditForm initialData={selectedAccount} onClose={() => setView('main')} handleUpdateAccount={handleUpdateAccount} handleDeleteAccount={handleDeleteAccount} /></div>}
                    {view === 'drill_down' && <div className="fixed inset-0 z-40 bg-white"><DrillDownView title={drillDownData?.title} txList={drillDownData?.txList || []} setView={setView} setEditingTransaction={setEditingTransaction} categories={categories} accounts={accounts} handleToggleVerified={handleToggleVerified} /></div>}
                    {view === 'category_manager' && <div className="fixed inset-0 z-40 bg-white"><CategoryManager categories={categories} setCategories={setCategories} setView={setView} showConfirm={showConfirm} /></div>}
                    {view === 'recurring_manager' && <div className="fixed inset-0 z-40 bg-white"><RecurringManager recurringRules={recurringRules} setRecurringRules={setRecurringRules} setView={setView} setEditingRecurring={setEditingRecurring} handleToggleRecurring={handleToggleRecurring} handleDeleteRecurring={handleDeleteRecurring} /></div>}
                    {view === 'add_recurring' && <div className="fixed inset-0 z-40 bg-white"><AddRecurringForm editingRecurring={editingRecurring} handleUpdateRecurring={handleUpdateRecurring} accounts={accounts} categories={categories} setView={setView} /></div>}
                    {view === 'budget_settings' && <div className="fixed inset-0 z-40 bg-white"><BudgetSettings budget={budget} setBudget={setBudget} setView={setView} /></div>}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(MinimalistTracker));
    </script>
</body>
</html>
