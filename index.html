<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>個人財務管家 (MyMoney) - 雲端同步完整版</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>.no-scrollbar::-webkit-scrollbar{display:none}.no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}select{background-image:url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");background-repeat:no-repeat;background-position:right 0.5rem center;background-size:1em;appearance:none}</style>
</head>
<body class="bg-gray-50 text-gray-800"><div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useMemo, useRef } = React;
// 圖示集
const Icons={LayoutDashboard:p=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>,Wallet:p=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/><path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4"/></svg>,ArrowRightLeft:p=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m16 3 4 4-4 4"/><path d="M20 7H4"/><path d="m8 21-4-4 4-4"/><path d="M4 17h16"/></svg>,PieChart:p=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>,Settings:p=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.35a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,CreditCard:p=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>,Plus:p=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,Trash2:p=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,Edit2:p=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,CheckCircle:p=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,TrendingUp:p=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,TrendingDown:p=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg>,Calendar:p=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,Save:p=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,X:p=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,Landmark:p=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" x2="21" y1="22" y2="22"/><line x1="6" x2="6" y1="18" y2="11"/><line x1="10" x2="10" y1="18" y2="11"/><line x1="14" x2="14" y1="18" y2="11"/><line x1="18" x2="18" y1="18" y2="11"/><polygon points="12 2 20 7 4 7"/></svg>,Banknote:p=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="12" x="2" y="6" rx="2"/><circle cx="12" cy="12" r="2"/><path d="M6 12h.01M18 12h.01"/></svg>,Search:p=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4-4.3"/></svg>,Filter:p=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>,Calculator:p=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>,CheckSquare:p=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>,Square:p=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/></svg>,ChevronLeft:p=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>,ChevronRight:p=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>,RefreshCw:p=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>,AlertTriangle:p=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>,Tag:p=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94 .94-2.48 0-3.42L12 2Z"/><circle cx="7" cy="7" r=".5"/></svg>,Cloud:p=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><path d="M12 13.5v-10"/><path d="m9 6 3-3 3 3"/><path d="M17.5 19c2.485 0 4.5-2.015 4.5-4.5S19.985 10 17.5 10c-.552 0-1.085.102-1.577.291C15.352 6.472 11.977 4 8 4 3.582 4 0 7.582 0 12c0 3.866 3.134 7 7 7"/></svg>,UploadCloud:p=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>,DownloadCloud:p=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m8 17 4 4 4-4"/></svg>,Repeat:p=><svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m17 2 4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="m7 22-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></svg>};
const SafeIcon=({icon:I,fallback:f,className:c})=>I?<I className={c}/>:f===null?null:<span className="text-sm font-bold inline-block w-4 text-center">{f||"?"}</span>;
const useLocalStorage=(k,i)=>{const[v,s]=useState(()=>{try{const t=window.localStorage.getItem(k);return t?JSON.parse(t):i}catch{return i}});const set=n=>{try{const t=n instanceof Function?n(v):n;s(t);window.localStorage.setItem(k,JSON.stringify(t))}catch{}};return[v,set]};
const formatDate=d=>{const D=new Date(d);return `${D.getFullYear()}-${String(D.getMonth()+1).padStart(2,'0')}-${String(D.getDate()).padStart(2,'0')}`};
const getCycleRange=(d,ref)=>{const R=new Date(ref);const Y=R.getFullYear(),M=R.getMonth(),D=R.getDate();let sY=Y,sM=M;if(D<d)sM=M-1;const start=new Date(sY,sM,d),end=new Date(sY,sM+1,d);end.setDate(end.getDate()-1);return{start:formatDate(start),end:formatDate(end)}};

// UI & Components
const Card=({children,className="",onClick})=><div onClick={onClick} className={`bg-white rounded-xl shadow-sm border border-gray-100 p-6 ${className} ${onClick?'cursor-pointer hover:shadow-md transition-all active:scale-[0.99]':''}`}>{children}</div>;
const Button=({children,onClick,variant='primary',className="",type="button",disabled=false})=>{const b="px-4 py-2 rounded-lg font-medium transition-colors flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed";const v={primary:"bg-blue-600 text-white hover:bg-blue-700",secondary:"bg-gray-100 text-gray-700 hover:bg-gray-200",danger:"bg-red-50 text-red-600 hover:bg-red-100",outline:"border border-gray-300 text-gray-700 hover:bg-gray-50",ghost:"text-gray-500 hover:bg-gray-100"};return(<button type={type} onClick={onClick} disabled={disabled} className={`${b} ${v[variant]} ${className}`}>{children}</button>)};
const Badge=({type})=>{const s={income:"bg-green-100 text-green-700",expense:"bg-red-100 text-red-700",transfer:"bg-blue-100 text-blue-700",cash:"bg-emerald-100 text-emerald-700",bank:"bg-blue-100 text-blue-700",credit:"bg-purple-100 text-purple-700",active:"bg-green-100 text-green-700",inactive:"bg-gray-100 text-gray-500"};return(<span className={`px-2 py-1 rounded text-xs font-medium ${s[type]||'bg-gray-100'}`}>{type==='transfer'?'轉帳':type==='expense'?'支出':type==='income'?'收入':type}</span>)};
const ConfirmModal=({isOpen,onClose,onConfirm,message})=>!isOpen?null:(<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[999] px-4 animate-fade-in"><div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl scale-100 transform transition-all"><div className="flex items-center gap-3 mb-3 text-red-600"><SafeIcon icon={Icons.AlertTriangle} fallback="!" className="w-6 h-6"/><h3 className="font-bold text-lg text-gray-800">確認操作</h3></div><p className="text-gray-600 mb-6 leading-relaxed whitespace-pre-line">{message}</p><div className="flex gap-3"><Button onClick={onClose} variant="secondary" className="flex-1">取消</Button><Button onClick={onConfirm} variant="danger" className="flex-1">確定</Button></div></div></div>);
const NavItem=({id,label,icon:I,activeTab,setActiveTab})=>(<button onClick={()=>setActiveTab(id)} className={`flex items-center gap-3 px-4 py-3 w-full rounded-xl transition-all ${activeTab===id?'bg-blue-600 text-white shadow-md':'text-gray-500 hover:bg-gray-100 hover:text-gray-900'}`}><SafeIcon icon={I} fallback="•" className="w-5 h-5"/><span className="font-medium">{label}</span></button>);
const CalculatorKeypad=({onConfirm,initialValue=""})=>{const[e,setE]=useState(initialValue?String(initialValue):"");const h=(k)=>{if(k==='C')setE("");else if(k==='='){try{setE(String(new Function('return '+e)()))}catch{setE("Error")}}else if(k==='OK'){let v=e;try{v=String(new Function('return '+e)())}catch{}onConfirm(v)}else if(k==='Back')setE(p=>p.slice(0,-1));else setE(p=>p+k)};const ks=['7','8','9','/','4','5','6','*','1','2','3','-','C','0','.','+'];return(<div className="bg-gray-100 p-4 rounded-xl"><div className="bg-white p-3 rounded-lg mb-4 text-right text-2xl font-mono border border-gray-300 h-14 flex items-center justify-end overflow-hidden">{e||"0"}</div><div className="grid grid-cols-4 gap-2">{ks.map(k=><button key={k} type="button" onClick={()=>h(k)} className={`p-3 rounded-lg font-bold text-lg shadow-sm active:scale-95 transition-transform ${['C'].includes(k)?'bg-red-100 text-red-600':['/','*','-','+'].includes(k)?'bg-blue-100 text-blue-600':'bg-white text-gray-700 hover:bg-gray-50'}`}>{k}</button>)}<button type="button" onClick={()=>h('Back')} className="bg-gray-200 text-gray-600 p-3 rounded-lg font-bold">⌫</button><button type="button" onClick={()=>h('=')} className="bg-yellow-100 text-yellow-700 p-3 rounded-lg font-bold">=</button><button type="button" onClick={()=>h('OK')} className="col-span-2 bg-blue-600 text-white p-3 rounded-lg font-bold">確認金額</button></div></div>)};

// Modals
const TransactionModal=({isOpen,onClose,onSave,onDelete,accounts,categories,budgets,initialData})=>{const[form,setForm]=useState({type:'expense',date:formatDate(new Date()),amount:'',category:'',accountId:'',toAccountId:'',note:'',isInstallment:false,installmentMonths:3,budgetId:'',reconciled:false});const[showCalc,setShowCalc]=useState(false);useEffect(()=>{if(isOpen)setForm({type:initialData?.type||'expense',date:initialData?.date||formatDate(new Date()),category:initialData?.category||'',note:initialData?.note||'',isInstallment:initialData?.isInstallment||false,installmentMonths:initialData?.installmentMonths||3,reconciled:initialData?.reconciled||false,amount:initialData?.amount!==undefined?initialData.amount:'',accountId:initialData?.accountId||'',toAccountId:initialData?.toAccountId||'',budgetId:initialData?.budgetId||''})},[isOpen,initialData]);if(!isOpen)return null;const isEdit=!!initialData?.id;const isCredit=accounts.find(a=>String(a.id)===String(form.accountId))?.type==='credit';return(<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 px-4"><div className="bg-white rounded-2xl w-full max-w-md overflow-hidden animate-fade-in shadow-2xl max-h-[95vh] overflow-y-auto"><div className="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50"><h3 className="font-bold text-gray-800">{isEdit?'編輯交易':'新增交易'}</h3><button onClick={onClose}><SafeIcon icon={Icons.X} fallback="X" className="w-5 h-5 text-gray-500"/></button></div><form onSubmit={(e)=>{e.preventDefault();onSave(form)}} className="p-6 space-y-4"><div className="flex p-1 bg-gray-100 rounded-lg">{['expense','income','transfer'].map(t=><button key={t} type="button" onClick={()=>setForm({...form,type:t,category:'',isInstallment:false})} className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${form.type===t?'bg-white shadow-sm text-blue-600':'text-gray-500 hover:text-gray-700'}`}>{t==='expense'?'支出':t==='income'?'收入':'轉帳'}</button>)}</div><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs text-gray-500 mb-1">日期</label><input type="date" required value={form.date} onChange={e=>setForm({...form,date:e.target.value})} className="w-full p-2 border border-gray-300 rounded-lg"/></div><div><label className="block text-xs text-gray-500 mb-1">金額</label><div className="relative"><input type="text" readOnly placeholder="點擊輸入" value={form.amount} onClick={()=>setShowCalc(true)} className="w-full p-2 border border-gray-300 rounded-lg font-bold text-gray-800 cursor-pointer bg-gray-50"/>{showCalc&&(<div className="absolute top-full left-0 right-0 z-50 mt-1 shadow-xl"><CalculatorKeypad initialValue={form.amount} onConfirm={(v)=>{setForm({...form,amount:v});setShowCalc(false)}}/><div className="fixed inset-0 z-[-1]" onClick={()=>setShowCalc(false)}></div></div>)}</div></div></div>{form.type!=='transfer'&&<div><label className="block text-xs text-gray-500 mb-1">分類</label><select required value={form.category} onChange={e=>setForm({...form,category:e.target.value})} className="w-full p-2 border border-gray-300 rounded-lg"><option value="">選擇分類</option>{(form.type==='expense'?categories.expense:categories.income).map(c=><option key={c} value={c}>{c}</option>)}</select></div>}<div><label className="block text-xs text-gray-500 mb-1">{form.type==='transfer'?'轉出帳戶':'帳戶'}</label><select required value={form.accountId} onChange={e=>setForm({...form,accountId:e.target.value})} className="w-full p-2 border border-gray-300 rounded-lg"><option value="">選擇帳戶</option>{accounts.map(a=><option key={a.id} value={a.id}>{a.name}</option>)}</select></div>{form.type==='expense'&&isCredit&&!isEdit&&<div className="bg-blue-50 p-3 rounded-lg border border-blue-100"><div className="flex items-center gap-2 mb-2"><input type="checkbox" checked={!!form.isInstallment} onChange={e=>setForm({...form,isInstallment:e.target.checked})} className="w-4 h-4 text-blue-600 rounded"/><label className="text-sm font-medium text-blue-800">啟用分期</label></div>{form.isInstallment&&<div className="flex items-center gap-2"><input type="number" min="2" max="36" value={form.installmentMonths} onChange={e=>setForm({...form,installmentMonths:Number(e.target.value)})} className="w-16 p-1 border border-blue-200 rounded text-center text-sm"/><span className="text-sm text-blue-700">期</span></div>}</div>}{form.type==='transfer'&&<div><label className="block text-xs text-gray-500 mb-1">轉入帳戶</label><select required value={form.toAccountId} onChange={e=>setForm({...form,toAccountId:e.target.value})} className="w-full p-2 border border-gray-300 rounded-lg"><option value="">選擇轉入帳戶</option>{accounts.filter(a=>String(a.id)!==form.accountId).map(a=><option key={a.id} value={a.id}>{a.name}</option>)}</select></div>}<div><label className="block text-xs text-gray-500 mb-1">備註</label><input type="text" value={form.note} onChange={e=>setForm({...form,note:e.target.value})} placeholder="例如：午餐" className="w-full p-2 border border-gray-300 rounded-lg"/></div>{form.type==='expense'&&<div><label className="block text-xs text-gray-500 mb-1">歸屬預算</label><select value={form.budgetId} onChange={e=>setForm({...form,budgetId:e.target.value})} className="w-full p-2 border border-gray-300 rounded-lg"><option value="">不列入任何預算</option>{budgets.map(b=><option key={b.id} value={b.id}>{b.name}</option>)}</select></div>}<div className="flex gap-2 mt-4">{isEdit&&<Button type="button" variant="danger" className="flex-1" onClick={(e)=>{e.preventDefault();e.stopPropagation();if(onDelete&&initialData.id)onDelete(initialData.id)}}><SafeIcon icon={Icons.Trash2} fallback="D" className="w-4 h-4"/> 刪除</Button>}<Button type="submit" className="flex-[2]">{isEdit?'更新':'儲存'}</Button></div></form></div></div>)};
const AccountModal=({isOpen,onClose,onSave,initialData})=>{const[f,setF]=useState({name:'',type:'cash',balance:0,cycleStartDay:1,creditLimit:'',statementDate:'',dueDate:'',...initialData});if(!isOpen)return null;const h=(e)=>{e.preventDefault();onSave({...f,balance:Number(f.balance),cycleStartDay:Number(f.cycleStartDay),creditLimit:f.creditLimit?Number(f.creditLimit):'',statementDate:f.statementDate?Number(f.statementDate):'',dueDate:f.dueDate?Number(f.dueDate):''})};return(<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 px-4"><div className="bg-white rounded-2xl w-full max-w-md p-6 animate-fade-in shadow-2xl max-h-[90vh] overflow-y-auto"><div className="flex justify-between items-center mb-4"><h3 className="font-bold text-gray-800">{initialData?.id?'編輯':'新增'}帳戶</h3><button onClick={onClose}><SafeIcon icon={Icons.X} fallback="X" className="w-5 h-5"/></button></div><form onSubmit={h} className="space-y-4"><div><label className="block text-xs text-gray-500">帳戶名稱</label><input required className="w-full p-2 border rounded-lg" value={f.name} onChange={e=>setF({...f,name:e.target.value})}/></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs text-gray-500">類型</label><select className="w-full p-2 border rounded-lg" value={f.type} onChange={e=>setF({...f,type:e.target.value})}><option value="cash">現金</option><option value="bank">銀行</option><option value="credit">信用卡</option></select></div><div><label className="block text-xs text-gray-500">餘額</label><input type="number" required className="w-full p-2 border rounded-lg" value={f.balance} onChange={e=>setF({...f,balance:Number(e.target.value)})}/></div></div><div><label className="block text-xs text-gray-500">帳務週期起始日</label><select className="w-full p-2 border rounded-lg" value={f.cycleStartDay} onChange={e=>setF({...f,cycleStartDay:Number(e.target.value)})}>{[...Array(28)].map((_,i)=><option key={i+1} value={i+1}>{i+1} 號</option>)}</select></div>{f.type==='credit'&&<div className="bg-purple-50 p-4 rounded-lg space-y-3"><div><label className="block text-xs text-purple-700">信用額度</label><input type="number" className="w-full p-2 border rounded" value={f.creditLimit} onChange={e=>setF({...f,creditLimit:Number(e.target.value)})}/></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs text-purple-700">結帳日</label><select className="w-full p-2 border rounded" value={f.statementDate} onChange={e=>setF({...f,statementDate:Number(e.target.value)})}>{[...Array(28)].map((_,i)=><option key={i+1} value={i+1}>{i+1} 號</option>)}</select></div><div><label className="block text-xs text-purple-700">截止日</label><select className="w-full p-2 border rounded" value={f.dueDate} onChange={e=>setF({...f,dueDate:Number(e.target.value)})}>{[...Array(28)].map((_,i)=><option key={i+1} value={i+1}>{i+1} 號</option>)}</select></div></div></div>}<Button type="submit" className="w-full mt-2">儲存</Button></form></div></div>)};
const BudgetModal=({isOpen,onClose,onSave,initialData})=>{if(!isOpen)return null;const h=(e)=>{e.preventDefault();const d=new FormData(e.target);onSave({name:d.get('name'),limit:Number(d.get('limit')),cycleDay:Number(d.get('cycleDay'))})};return(<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 px-4"><div className="bg-white rounded-2xl w-full max-w-sm p-6 animate-fade-in shadow-2xl"><div className="flex justify-between items-center mb-4"><h3 className="font-bold text-gray-800">{initialData?.id?'編輯':'新增'}預算</h3><button onClick={onClose}><SafeIcon icon={Icons.X} fallback="X" className="w-5 h-5"/></button></div><form onSubmit={h} className="space-y-4"><div><label className="block text-xs text-gray-500">預算名稱</label><input name="name" required defaultValue={initialData?.name} className="w-full p-2 border rounded-lg"/></div><div><label className="block text-xs text-gray-500">金額</label><input name="limit" type="number" required defaultValue={initialData?.limit} className="w-full p-2 border rounded-lg"/></div><div><label className="block text-xs text-gray-500">起始日</label><select name="cycleDay" required defaultValue={initialData?.cycleDay||1} className="w-full p-2 border rounded-lg">{[...Array(28)].map((_,i)=><option key={i+1} value={i+1}>{i+1} 號</option>)}</select></div><Button type="submit" className="w-full">儲存</Button></form></div></div>)};
const RecurringModal=({isOpen,onClose,onSave,initialData,accounts,categories,budgets})=>{if(!isOpen)return null;const h=(e)=>{e.preventDefault();const d=new FormData(e.target);onSave({name:d.get('name'),amount:Number(d.get('amount')),type:d.get('type'),day:Number(d.get('day')),category:d.get('category'),accountId:Number(d.get('accountId')),budgetId:d.get('budgetId')?Number(d.get('budgetId')):null,frequency:'每月',isActive:true})};return(<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 px-4"><div className="bg-white rounded-2xl w-full max-w-md p-6 animate-fade-in shadow-2xl overflow-y-auto max-h-[90vh]"><div className="flex justify-between items-center mb-4"><h3 className="font-bold text-gray-800">{initialData?.id?'編輯':'新增'}定期扣款</h3><button onClick={onClose}><SafeIcon icon={Icons.X} fallback="X" className="w-5 h-5"/></button></div><form onSubmit={h} className="space-y-4"><div><label className="block text-xs text-gray-500">名稱</label><input name="name" required defaultValue={initialData?.name} className="w-full p-2 border rounded"/></div><div className="flex gap-4"><div className="flex-1"><label className="block text-xs text-gray-500">類型</label><select name="type" defaultValue={initialData?.type||'expense'} className="w-full p-2 border rounded"><option value="expense">支出</option><option value="income">收入</option></select></div><div className="flex-1"><label className="block text-xs text-gray-500">金額</label><input name="amount" type="number" required defaultValue={initialData?.amount} className="w-full p-2 border rounded"/></div></div><div className="flex gap-4"><div className="flex-1"><label className="block text-xs text-gray-500">執行日</label><select name="day" defaultValue={initialData?.day||1} className="w-full p-2 border rounded">{[...Array(28)].map((_,i)=><option key={i+1} value={i+1}>{i+1} 號</option>)}</select></div><div className="flex-1"><label className="block text-xs text-gray-500">分類</label><select name="category" required defaultValue={initialData?.category} className="w-full p-2 border rounded">{categories.expense.map(c=><option key={c} value={c}>{c}</option>)}</select></div></div><div><label className="block text-xs text-gray-500">扣款帳戶</label><select name="accountId" required defaultValue={initialData?.accountId} className="w-full p-2 border rounded">{accounts.map(a=><option key={a.id} value={a.id}>{a.name}</option>)}</select></div><div><label className="block text-xs text-gray-500">列入預算</label><select name="budgetId" defaultValue={initialData?.budgetId||''} className="w-full p-2 border rounded"><option value="">不列入</option>{budgets.map(b=><option key={b.id} value={b.id}>{b.name}</option>)}</select></div><Button type="submit" className="w-full mt-2">儲存</Button></form></div></div>)};
const CategoryManager=({categories,onUpdate})=>{const[t,setT]=useState('expense');const[n,setN]=useState('');const[ed,setEd]=useState(null);const[ev,setEv]=useState('');const add=()=>{if(!n.trim())return;onUpdate({...categories,[t]:[...categories[t],n.trim()]});setN('')};const save=(old)=>{if(!ev.trim()||ev===old){setEd(null);return}onUpdate({...categories,[t]:categories[t].map(c=>c===old?ev.trim():c)});setEd(null)};const del=(name)=>{if(confirm('刪除?'))onUpdate({...categories,[t]:categories[t].filter(c=>c!==name)})};return(<div className="space-y-6"><h2 className="text-2xl font-bold text-gray-800">分類管理</h2><Card className="h-full"><div className="flex bg-gray-100 p-1 rounded-lg mb-4"><button onClick={()=>setT('expense')} className={`flex-1 py-2 rounded-md text-sm font-medium transition-all ${t==='expense'?'bg-white shadow text-red-600':'text-gray-500'}`}>支出</button><button onClick={()=>setT('income')} className={`flex-1 py-2 rounded-md text-sm font-medium transition-all ${t==='income'?'bg-white shadow text-green-600':'text-gray-500'}`}>收入</button></div><div className="flex gap-2 mb-6"><input value={n} onChange={e=>setN(e.target.value)} placeholder="新增分類..." className="flex-1 p-3 border rounded-xl" onKeyDown={e=>e.key==='Enter'&&add()}/><Button onClick={add}><SafeIcon icon={Icons.Plus} fallback="+"/> 新增</Button></div><div className="space-y-2 max-h-[500px] overflow-y-auto">{categories[t].map(c=><div key={c} className="flex justify-between items-center p-3 bg-gray-50 rounded-xl hover:bg-white border hover:border-gray-200">{ed===c?(<div className="flex gap-2 flex-1"><input autoFocus value={ev} onChange={e=>setEv(e.target.value)} className="flex-1 p-2 border rounded"/><Button onClick={()=>save(c)} className="!px-3 !py-1 text-sm">存</Button><Button onClick={()=>setEd(null)} variant="secondary" className="!px-3 !py-1 text-sm">消</Button></div>):(<><span>{c}</span><div className="flex gap-2"><button onClick={()=>{setEd(c);setEv(c)}} className="p-2 bg-white border rounded text-blue-600"><SafeIcon icon={Icons.Edit2} fallback="E"/></button><button onClick={()=>del(c)} className="p-2 bg-white border rounded text-red-600"><SafeIcon icon={Icons.Trash2} fallback="D"/></button></div></>)}</div>)}</div></Card></div>)};

// 視圖 Views
const DashboardView=({accounts,transactions,budgets,recurring,onOpenEditTx,dashboardCycleDay,setDashboardCycleDay,setTxFilter,setActiveTab})=>{const total=useMemo(()=>accounts.reduce((s,a)=>s+a.balance,0),[accounts]);const mStats=useMemo(()=>{const{start,end}=getCycleRange(dashboardCycleDay,formatDate(new Date()));let i=0,e=0;transactions.forEach(t=>{if(t.date>=start&&t.date<=end){if(t.type==='income')i+=t.amount;if(t.type==='expense')e+=t.amount}});return{income:i,expense:e,cycleStart:start}},[transactions,dashboardCycleDay]);const bStats=useMemo(()=>{const today=new Date();return budgets.map(b=>{const{start,end}=getCycleRange(b.cycleDay,today);const act=transactions.filter(t=>t.budgetId===b.id&&t.type==='expense'&&t.date>=start&&t.date<=end);const s=act.reduce((sum,t)=>sum+t.amount,0);let f=0;recurring.forEach(r=>{if(r.budgetId===b.id&&r.isActive&&r.type==='expense'){const paid=act.some(t=>t.category===r.category&&Math.abs(t.amount-r.amount)<5);if(!paid)f+=r.amount}});return{...b,spent:s,forecast:f,totalEst:s+f,start,end}})},[transactions,budgets,recurring]);const goTx=(type)=>{const{start,end}=getCycleRange(dashboardCycleDay,formatDate(new Date()));setTxFilter({accountId:'all',category:'all',startDate:start,endDate:end,minAmount:'',type});setActiveTab('transactions')};return(<div className="space-y-6"><div className="md:hidden flex justify-between items-center"><h2 className="text-xl font-bold">儀表板</h2><Button onClick={()=>onOpenEditTx(null)} className="py-1 text-sm">記一筆</Button></div><div className="hidden md:flex justify-end gap-2"><div className="flex items-center gap-2 bg-white px-3 py-2 rounded-lg border"><span className="text-xs text-gray-500">本月起始:</span><select value={dashboardCycleDay} onChange={e=>setDashboardCycleDay(Number(e.target.value))}>{[...Array(28)].map((_,i)=><option key={i+1} value={i+1}>{i+1}號</option>)}</select></div><Button onClick={()=>onOpenEditTx(null)}>快速記帳</Button></div><div className="grid grid-cols-1 md:grid-cols-3 gap-4"><Card className="bg-gradient-to-br from-blue-500 to-blue-600 text-white"><p className="text-blue-100 text-sm">總淨資產</p><h2 className="text-3xl font-bold">NT$ {total.toLocaleString()}</h2></Card><Card onClick={()=>goTx('income')}><div className="flex justify-between mb-2"><span className="text-gray-500 text-sm">本月收入</span></div><p className="text-2xl font-bold text-green-600">+{mStats.income.toLocaleString()}</p><p className="text-xs text-gray-400 mt-2 text-right">{mStats.cycleStart} 起</p></Card><Card onClick={()=>goTx('expense')}><div className="flex justify-between mb-2"><span className="text-gray-500 text-sm">本月支出</span></div><p className="text-2xl font-bold text-red-600">-{mStats.expense.toLocaleString()}</p><p className="text-xs text-gray-400 mt-2 text-right">{mStats.cycleStart} 起</p></Card></div><div className="grid grid-cols-1 lg:grid-cols-2 gap-6"><Card onClick={()=>setActiveTab('budget')}><h3 className="font-bold text-gray-800 mb-4">預算概況</h3><div className="space-y-4 max-h-[300px] overflow-y-auto no-scrollbar">{bStats.map((b,i)=><div key={i}><div className="flex justify-between text-sm mb-1"><span>{b.name}</span><span className="text-gray-500 text-xs">預計 ${b.totalEst.toLocaleString()} / ${b.limit.toLocaleString()}</span></div><div className="h-2 bg-gray-100 rounded-full overflow-hidden"><div className={`h-full rounded-full ${b.totalEst>b.limit?'bg-red-500':'bg-blue-500'}`} style={{width:`${Math.min((b.totalEst/b.limit)*100,100)}%`}}></div></div></div>)}</div></Card><Card><h3 className="font-bold text-gray-800 mb-4">近期交易</h3><div className="space-y-3">{transactions.slice(0,5).map(t=><div key={t.id} onClick={()=>onOpenEditTx(t)} className="flex justify-between p-3 bg-gray-50 rounded-lg cursor-pointer"><div><p className="font-medium text-gray-800">{t.note||t.category}</p><p className="text-xs text-gray-500">{t.date}</p></div><span className={`font-bold ${t.type==='income'?'text-green-600':t.type==='expense'?'text-red-600':'text-blue-600'}`}>{t.amount.toLocaleString()}</span></div>)}</div></Card></div></div>)};
const AccountsView=({accounts,transactions,onOpenEditTx,onDeleteTx,onEditAccount,onDeleteAccount,setAccountViewCycleIndex,setSelectedAccountDetailId,selectedAccountDetailId,accountViewCycleIndex})=>{if(selectedAccountDetailId){const acc=accounts.find(a=>a.id===selectedAccountDetailId);const cycleDay=acc.type==='credit'?acc.statementDate||1:acc.cycleStartDay||1;const range=getCycleRange(cycleDay,formatDate(new Date()),accountViewCycleIndex);const txs=transactions.filter(t=>(t.accountId===acc.id||t.toAccountId===acc.id)&&t.date>=range.start&&t.date<=range.end).sort((a,b)=>new Date(b.date)-new Date(a.date));return(<div className="space-y-6"><div className="flex items-center gap-4"><button onClick={()=>setSelectedAccountDetailId(null)} className="p-2 hover:bg-gray-100 rounded-full"><SafeIcon icon={Icons.ChevronLeft} fallback="<"/></button><div><h2 className="text-2xl font-bold">{acc.name}</h2><p className="text-sm text-gray-500">{range.start} ~ {range.end}</p></div></div><Card><div className="flex justify-between mb-4"><button onClick={()=>setAccountViewCycleIndex(p=>p+1)} className="p-2 hover:bg-gray-100"><SafeIcon icon={Icons.ChevronLeft}/></button><span className="font-bold">{accountViewCycleIndex===0?'本期':Math.abs(accountViewCycleIndex)+'期前'}</span><button onClick={()=>setAccountViewCycleIndex(p=>p-1)} className="p-2 hover:bg-gray-100"><SafeIcon icon={Icons.ChevronRight}/></button></div><div className="divide-y">{txs.map(t=><div key={t.id} onClick={()=>onOpenEditTx(t)} className="py-3 flex justify-between cursor-pointer"><div><div className="font-medium">{t.note||t.category}</div><div className="text-xs text-gray-500">{t.date}</div></div><div className="font-bold">{t.amount.toLocaleString()}</div></div>)}</div></Card></div>)}return(<div className="space-y-6"><div className="flex justify-between items-center"><h2 className="text-2xl font-bold">帳戶管理</h2><Button onClick={()=>onEditAccount(null)} variant="outline">新增</Button></div><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">{accounts.map(a=><div key={a.id} onClick={()=>{setSelectedAccountDetailId(a.id);setAccountViewCycleIndex(0)}} className="cursor-pointer"><Card className="hover:shadow-md"><div className="flex justify-between mb-4"><Badge type={a.type}/></div><h3 className="font-medium text-gray-600">{a.name}</h3><p className={`text-2xl font-bold ${a.balance<0?'text-red-600':'text-gray-800'}`}>{a.balance.toLocaleString()}</p><div className="mt-4 pt-4 border-t flex gap-2"><Button onClick={e=>{e.stopPropagation();onEditAccount(a)}} variant="secondary" className="text-xs flex-1">編輯</Button><Button onClick={e=>{e.stopPropagation();onDeleteAccount(a.id)}} variant="secondary" className="text-xs flex-1 text-red-600">刪除</Button></div></Card></div>)}</div></div>)};
const TransactionsView=({transactions,accounts,categories,budgets,onOpenEdit,onOpenAdd,onDelete,filter,setFilter})=>{const filtered=transactions.filter(t=>{if(filter.accountId!=='all'&&String(t.accountId)!==String(filter.accountId))return false;if(filter.category!=='all'&&t.category!==filter.category)return false;if(filter.type!=='all'&&t.type!==filter.type)return false;if(filter.startDate&&t.date<filter.startDate)return false;if(filter.endDate&&t.date>filter.endDate)return false;return true}).sort((a,b)=>new Date(b.date)-new Date(a.date));return(<div className="space-y-6"><div className="flex justify-between items-center"><h2 className="text-2xl font-bold">交易紀錄</h2><Button onClick={onOpenAdd}>新增</Button></div><Card><div className="grid grid-cols-2 md:grid-cols-6 gap-3"><select className="border p-2 rounded" value={filter.accountId} onChange={e=>setFilter({...filter,accountId:e.target.value})}><option value="all">所有帳戶</option>{accounts.map(a=><option key={a.id} value={a.id}>{a.name}</option>)}</select><select className="border p-2 rounded" value={filter.type} onChange={e=>setFilter({...filter,type:e.target.value})}><option value="all">類型</option><option value="expense">支出</option><option value="income">收入</option></select><input type="date" className="border p-2 rounded" value={filter.startDate} onChange={e=>setFilter({...filter,startDate:e.target.value})}/><input type="date" className="border p-2 rounded" value={filter.endDate} onChange={e=>setFilter({...filter,endDate:e.target.value})}/></div></Card><div className="bg-white rounded-xl shadow-sm border overflow-hidden"><table className="w-full text-left"><thead className="bg-gray-50 border-b"><tr><th className="px-6 py-3 text-xs text-gray-500">日期</th><th className="px-6 py-3 text-xs text-gray-500">內容</th><th className="px-6 py-3 text-xs text-gray-500 text-right">金額</th></tr></thead><tbody className="divide-y">{filtered.map(t=><tr key={t.id} onClick={()=>onOpenEdit(t)} className="hover:bg-gray-50 cursor-pointer"><td className="px-6 py-4 text-sm">{t.date}</td><td className="px-6 py-4 text-sm">{t.note||t.category}</td><td className={`px-6 py-4 text-sm font-bold text-right ${t.type==='income'?'text-green-600':t.type==='expense'?'text-red-600':'text-blue-600'}`}>{t.amount.toLocaleString()}</td></tr>)}</tbody></table></div></div>)};
const RecurringView=({recurring,accounts,onEdit,onDelete,onAdd})=>(<div className="space-y-6"><div className="flex justify-between items-center"><h2 className="text-2xl font-bold">定期扣款</h2><Button onClick={onAdd}>新增</Button></div><div className="grid grid-cols-1 md:grid-cols-3 gap-4">{recurring.map(r=><Card key={r.id} className="border-l-4 border-l-purple-500 relative"><div className="absolute top-4 right-4 flex gap-2"><button onClick={()=>onEdit(r)} className="text-blue-500"><SafeIcon icon={Icons.Edit2}/></button><button onClick={()=>onDelete(r.id)} className="text-red-500"><SafeIcon icon={Icons.Trash2}/></button></div><h4 className="font-bold">{r.name}</h4><p className="text-sm text-gray-500">每月 {r.day} 號 • ${r.amount.toLocaleString()}</p><p className="text-xs text-gray-400">{accounts.find(a=>a.id===r.accountId)?.name}</p></Card>)}</div></div>);
const ReconciliationView=({accounts,transactions,onToggleReconcile})=>{const[selAcc,setSelAcc]=useState(accounts[0]?.id);const acc=accounts.find(a=>a.id==selAcc);const range=getCycleRange(acc?.cycleStartDay||1,formatDate(new Date()));const txs=transactions.filter(t=>(t.accountId==selAcc||t.toAccountId==selAcc)&&t.date>=range.start&&t.date<=range.end);return(<div className="space-y-6"><h2 className="text-2xl font-bold">對帳中心</h2><Card><select value={selAcc} onChange={e=>setSelAcc(Number(e.target.value))} className="w-full p-2 border rounded mb-4">{accounts.map(a=><option key={a.id} value={a.id}>{a.name}</option>)}</select><div className="divide-y">{txs.map(t=><div key={t.id} className="flex justify-between items-center py-3"><div><p className="font-medium">{t.note||t.category}</p><p className="text-xs text-gray-500">{t.date}</p></div><div className="flex items-center gap-4"><span className="font-bold">{t.amount.toLocaleString()}</span><input type="checkbox" checked={t.reconciled} onChange={e=>onToggleReconcile(e,t.id)} className="w-5 h-5"/></div></div>)}</div></Card></div>)};
const BudgetsView=({budgets,onEditBudget,onDeleteBudget})=>{return(<div className="space-y-6"><div className="flex justify-between items-center"><h2 className="text-2xl font-bold">預算管理</h2><Button onClick={()=>onEditBudget(null)}>新增</Button></div><div className="grid grid-cols-1 md:grid-cols-2 gap-4">{budgets.map(b=><Card key={b.id} className="relative"><div className="absolute top-4 right-4 flex gap-2"><button onClick={()=>onEditBudget(b)} className="text-blue-500"><SafeIcon icon={Icons.Edit2}/></button><button onClick={()=>onDeleteBudget(b.id)} className="text-red-500"><SafeIcon icon={Icons.Trash2}/></button></div><h4 className="font-bold">{b.name}</h4><p className="text-2xl font-bold text-blue-600">${b.limit.toLocaleString()}</p></Card>)}</div></div>)};
</script>
<script type="text/babel">
// --- Part 3: Main Logic ---
const INITIAL_ACCOUNTS=[{id:1,name:'現金',type:'cash',balance:0,cycleStartDay:1},{id:2,name:'銀行',type:'bank',balance:0,cycleStartDay:1}];
const INITIAL_TRANSACTIONS=[];const INITIAL_CATEGORIES={expense:['餐飲','交通','購物'],income:['薪資']};const INITIAL_BUDGETS=[];const INITIAL_RECURRING=[];

function FinanceManager(){
    const[activeTab,setActiveTab]=React.useState('dashboard');
    const useLS=(k,i)=>{const[v,s]=React.useState(()=>{try{return JSON.parse(localStorage.getItem(k))||i}catch{return i}});const set=n=>{const t=n instanceof Function?n(v):n;s(t);localStorage.setItem(k,JSON.stringify(t))};return[v,set]};
    const[accounts,setAccounts]=useLS('mymoney_accounts',INITIAL_ACCOUNTS);
    const[transactions,setTx]=useLS('mymoney_transactions',INITIAL_TRANSACTIONS);
    const[categories,setCats]=useLS('mymoney_categories',INITIAL_CATEGORIES);
    const[budgets,setBudgets]=useLS('mymoney_budgets',INITIAL_BUDGETS);
    const[recurring,setRec]=useLS('mymoney_recurring',INITIAL_RECURRING);
    const[cycleDay,setCycleDay]=useLS('mymoney_cycle_day',1);
    const[gasUrl,setGasUrl]=useLS('mymoney_gas_url','');
    const[loading,setLoading]=React.useState(false);
    const[filter,setFilter]=React.useState({accountId:'all',category:'all',startDate:'',endDate:'',minAmount:'',type:'all'});
    
    // Modals State
    const[mTx,setMTx]=React.useState(false);const[editTx,setEditTx]=React.useState(null);
    const[mAcc,setMAcc]=React.useState(false);const[editAcc,setEditAcc]=React.useState(null);
    const[mBud,setMBud]=React.useState(false);const[editBud,setEditBud]=React.useState(null);
    const[mRec,setMRec]=React.useState(false);const[editRec,setEditRec]=React.useState(null);
    const[selAccId,setSelAccId]=React.useState(null);const[selBudId,setSelBudId]=React.useState(null);
    const[viewIdx,setViewIdx]=React.useState(0);

    // Auto Recurring Logic
    React.useEffect(()=>{
        const today=new Date();
        const Y=today.getFullYear(),M=today.getMonth();
        let newTxs=[], accUpdates={};
        recurring.forEach(r=>{
            if(!r.isActive)return;
            let d=r.day; if(d>new Date(Y,M+1,0).getDate()) d=new Date(Y,M+1,0).getDate();
            const tDate=new Date(Y,M,d);
            const dateStr=`${Y}-${String(M+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            if(tDate>today)return;
            const exists=transactions.some(t=>t.date===dateStr&&Math.abs(t.amount-r.amount)<1&&t.category===r.category&&(t.note===r.name||t.note===`${r.name} (自動)`));
            if(!exists){
                newTxs.push({id:Date.now()+Math.random(),date:dateStr,type:r.type,amount:r.amount,category:r.category,accountId:r.accountId,note:`${r.name} (自動)`,reconciled:false,budgetId:r.budgetId});
                if(!accUpdates[r.accountId])accUpdates[r.accountId]=0;
                accUpdates[r.accountId]+=(r.type==='expense'?-r.amount:r.amount);
            }
        });
        if(newTxs.length>0){
            setTx(p=>[...newTxs,...p]);
            setAccounts(p=>p.map(a=>accUpdates[a.id]?{...a,balance:a.balance+accUpdates[a.id]}:a));
        }
    },[recurring,transactions]);

    // Cloud Sync
    const syncDownload=async()=>{
        if(!gasUrl)return alert('請設定 URL');setLoading(true);
        try{
            const res=await fetch(gasUrl);const d=await res.json();
            if(confirm('覆蓋本機資料?')){
                if(d.mymoney_accounts)setAccounts(JSON.parse(d.mymoney_accounts));
                if(d.mymoney_transactions)setTx(JSON.parse(d.mymoney_transactions));
                if(d.mymoney_categories)setCats(JSON.parse(d.mymoney_categories));
                if(d.mymoney_budgets)setBudgets(JSON.parse(d.mymoney_budgets));
                if(d.mymoney_recurring)setRec(JSON.parse(d.mymoney_recurring));
                alert('完成');
            }
        }catch(e){alert('失敗:'+e)}finally{setLoading(false)}
    };
    const syncUpload=async()=>{
        if(!gasUrl)return alert('請設定 URL');setLoading(true);
        try{
            const payload=[
                {key:'mymoney_accounts',value:JSON.stringify(accounts)},
                {key:'mymoney_categories',value:JSON.stringify(categories)},
                {key:'mymoney_budgets',value:JSON.stringify(budgets)},
                {key:'mymoney_recurring',value:JSON.stringify(recurring)},
                {key:'mymoney_transactions',value:JSON.stringify(transactions)}
            ];
            for(const task of payload){
                await fetch(gasUrl,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify(task)});
                await new Promise(r=>setTimeout(r,300));
            }
            alert('上傳完成');
        }catch(e){alert('失敗:'+e)}finally{setLoading(false)}
    };

    // Handlers
    const saveTx=(f)=>{
        const amt=Number(f.amount);
        if(editTx){
            const old=transactions.find(t=>t.id===editTx);
            // Revert old balance logic omitted for brevity in compressed version, but functionally fine for edit
            setTx(p=>p.map(t=>t.id===editTx?{...t,...f,amount:amt,accountId:Number(f.accountId)}:t));
            // Simple balance update: revert old, add new
             setAccounts(prev => {
                let temp = [...prev];
                // Revert old
                const oa = temp.find(a=>a.id === old.accountId);
                if(oa) oa.balance += (old.type==='expense'?old.amount:-old.amount);
                // Apply new
                const na = temp.find(a=>a.id === Number(f.accountId));
                if(na) na.balance += (f.type==='expense'?-amt:amt);
                return temp;
            });
        }else{
            setTx(p=>[{id:Date.now(),...f,amount:amt,accountId:Number(f.accountId)},...p]);
            setAccounts(p=>p.map(a=>a.id===Number(f.accountId)?{...a,balance:a.balance+(f.type==='expense'?-amt:amt)}:a));
        }
        setMTx(false);setEditTx(null);
    };

    return (
        <div className="min-h-screen bg-gray-50 flex flex-col md:flex-row font-sans pb-20 md:pb-0">
            {/* Modals */}
            <TransactionModal isOpen={mTx} onClose={()=>setMTx(false)} onSave={saveTx} accounts={accounts} categories={categories} budgets={budgets} initialData={editTx?transactions.find(t=>t.id===editTx):null} onDelete={(id)=>{setTx(p=>p.filter(t=>t.id!==id));setMTx(false)}}/>
            <AccountModal isOpen={mAcc} onClose={()=>setMAcc(false)} onSave={(d)=>{if(d.id)setAccounts(p=>p.map(a=>a.id===d.id?d:a));else setAccounts(p=>[...p,{...d,id:Date.now()}]);setMAcc(false)}} initialData={editAcc}/>
            <BudgetModal isOpen={mBud} onClose={()=>setMBud(false)} onSave={(d)=>{if(d.id)setBudgets(p=>p.map(b=>b.id===d.id?d:b));else setBudgets(p=>[...p,{...d,id:Date.now()}]);setMBud(false)}} initialData={editBud}/>
            <RecurringModal isOpen={mRec} onClose={()=>setMRec(false)} onSave={(d)=>{if(d.id)setRec(p=>p.map(r=>r.id===d.id?d:r));else setRec(p=>[...p,{...d,id:Date.now()}]);setMRec(false)}} initialData={editRec} accounts={accounts} categories={categories} budgets={budgets}/>

            {/* Sidebar */}
            <aside className="w-full md:w-64 bg-white border-r p-6 hidden md:flex flex-col justify-between">
                <div>
                    <h1 className="text-xl font-bold mb-8">MyMoney</h1>
                    <nav className="space-y-2">
                        <NavItem id="dashboard" label="儀表板" icon={Icons.LayoutDashboard} activeTab={activeTab} setActiveTab={setActiveTab}/>
                        <NavItem id="accounts" label="帳戶" icon={Icons.Wallet} activeTab={activeTab} setActiveTab={setActiveTab}/>
                        <NavItem id="transactions" label="交易" icon={Icons.ArrowRightLeft} activeTab={activeTab} setActiveTab={setActiveTab}/>
                        <NavItem id="reconcile" label="對帳" icon={Icons.CheckCircle} activeTab={activeTab} setActiveTab={setActiveTab}/>
                        <NavItem id="budget" label="預算" icon={Icons.PieChart} activeTab={activeTab} setActiveTab={setActiveTab}/>
                        <NavItem id="recurring" label="定期" icon={Icons.Repeat} activeTab={activeTab} setActiveTab={setActiveTab}/>
                        <NavItem id="categories" label="分類" icon={Icons.Tag} activeTab={activeTab} setActiveTab={setActiveTab}/>
                    </nav>
                </div>
                <div className="border-t pt-4">
                    {!gasUrl ? <input placeholder="API URL..." value={gasUrl} onChange={e=>setGasUrl(e.target.value)} className="border p-1 w-full text-xs rounded"/> : <div className="text-xs text-green-600 mb-2">✅ 已連結雲端 <button onClick={()=>setGasUrl('')} className="text-gray-400">✎</button></div>}
                    <div className="grid grid-cols-2 gap-2 mt-2">
                        <button onClick={syncUpload} disabled={loading} className="bg-blue-50 text-blue-600 p-2 rounded text-xs">上傳</button>
                        <button onClick={syncDownload} disabled={loading} className="bg-green-50 text-green-600 p-2 rounded text-xs">下載</button>
                    </div>
                </div>
            </aside>

            {/* Mobile Header */}
            <div className="md:hidden bg-white p-4 flex justify-between items-center shadow-sm sticky top-0 z-10">
                <h1 className="font-bold">MyMoney</h1>
                <div className="flex gap-2">
                     {!gasUrl && <button onClick={()=>setGasUrl(prompt('API URL'))}>🔗</button>}
                     <button onClick={syncUpload} className="text-blue-500">⬆️</button>
                     <button onClick={syncDownload} className="text-green-500">⬇️</button>
                     <button onClick={()=>{setEditTx(null);setMTx(true)}} className="text-xl">➕</button>
                </div>
            </div>

            {/* Main Content */}
            <main className="flex-1 p-4 overflow-y-auto">
                {activeTab==='dashboard' && <DashboardView accounts={accounts} transactions={transactions} budgets={budgets} recurring={recurring} onOpenEditTx={(t)=>{setEditTx(t?t.id:null);setMTx(true)}} dashboardCycleDay={cycleDay} setDashboardCycleDay={setCycleDay} setTxFilter={setFilter} setActiveTab={setActiveTab}/>}
                {activeTab==='accounts' && <AccountsView accounts={accounts} transactions={transactions} onEditAccount={(a)=>{setEditAcc(a);setMAcc(true)}} onDeleteAccount={id=>setAccounts(p=>p.filter(a=>a.id!==id))} onOpenEditTx={(t)=>{setEditTx(t.id);setMTx(true)}} setSelectedAccountDetailId={setSelAccId} selectedAccountDetailId={selAccId} setAccountViewCycleIndex={setViewIdx} accountViewCycleIndex={viewIdx}/>}
                {activeTab==='transactions' && <TransactionsView transactions={transactions} accounts={accounts} categories={categories} budgets={budgets} onOpenEdit={(t)=>{setEditTx(t.id);setMTx(true)}} onOpenAdd={()=>{setEditTx(null);setMTx(true)}} onDelete={id=>setTx(p=>p.filter(t=>t.id!==id))} filter={filter} setFilter={setFilter}/>}
                {activeTab==='reconcile' && <ReconciliationView accounts={accounts} transactions={transactions} onToggleReconcile={(e,id)=>setTx(p=>p.map(t=>t.id===id?{...t,reconciled:!t.reconciled}:t))}/>}
                {activeTab==='budget' && <BudgetsView budgets={budgets} transactions={transactions} recurring={recurring} onEditBudget={(b)=>{setEditBud(b);setMBud(true)}} onDeleteBudget={id=>setBudgets(p=>p.filter(b=>b.id!==id))} selectedBudgetDetailId={selBudId} setSelectedBudgetDetailId={setSelBudId}/>}
                {activeTab==='recurring' && <RecurringView recurring={recurring} accounts={accounts} onEdit={(r)=>{setEditRec(r);setMRec(true)}} onDelete={id=>setRec(p=>p.filter(r=>r.id!==id))} onAdd={()=>{setEditRec(null);setMRec(true)}}/>}
                {activeTab==='categories' && <CategoryManager categories={categories} onUpdate={setCats}/>}
            </main>

            {/* Mobile Nav */}
            <div className="md:hidden fixed bottom-0 w-full bg-white border-t flex justify-between p-2">
                <button onClick={()=>setActiveTab('dashboard')} className="flex-1 text-center text-xs">儀表板</button>
                <button onClick={()=>setActiveTab('accounts')} className="flex-1 text-center text-xs">帳戶</button>
                <button onClick={()=>setActiveTab('transactions')} className="flex-1 text-center text-xs">交易</button>
                <button onClick={()=>setActiveTab('recurring')} className="flex-1 text-center text-xs">定期</button>
                <button onClick={()=>setActiveTab('categories')} className="flex-1 text-center text-xs">分類</button>
            </div>
        </div>
    );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<FinanceManager />);
</script></body></html>
