<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ¥µç°¡è¨˜å¸³ (Pro)</title>
    
    <!-- iOS PWA å°ˆç”¨è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ¥µç°¡è¨˜å¸³">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’¸</text></svg>">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’¸</text></svg>">

    <!-- å¼•å…¥ React èˆ‡ Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            user-select: none;
            -webkit-user-select: none;
            background-color: #F2F4F7;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        button { -webkit-tap-highlight-color: transparent; }
        input[type="date"], input[type="time"] { -webkit-appearance: none; min-height: 1.5rem; }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- å…§å»ºåœ–ç¤ºå…ƒä»¶ ---
        const IconBase = ({ size = 24, children, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                {children}
            </svg>
        );

        const Icons = {
            Plus: (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>,
            X: (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>,
            RefreshCw: (p) => <IconBase {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconBase>,
            Trash2: (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>,
            Wallet: (p) => <IconBase {...p}><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/><path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4"/></IconBase>,
            CreditCard: (p) => <IconBase {...p}><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></IconBase>,
            Building2: (p) => <IconBase {...p}><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></IconBase>,
            ChevronRight: (p) => <IconBase {...p}><path d="m9 18 6-6-6-6"/></IconBase>,
            ChevronLeft: (p) => <IconBase {...p}><path d="m15 18-6-6 6-6"/></IconBase>,
            Settings: (p) => <IconBase {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>,
            Edit2: (p) => <IconBase {...p}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></IconBase>,
            Utensils: (p) => <IconBase {...p}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></IconBase>,
            Bus: (p) => <IconBase {...p}><path d="M8 6v6"/><path d="M15 6v6"/><path d="M2 12h19.6"/><path d="M18 18h3s.5-1.7.8-2.8c.1-.4.2-.8.2-1.2 0-.4-.1-.8-.2-1.2l-1.4-5C20.1 6.8 19.1 6 18 6H4a2 2 0 0 0-2 2v10h3"/><circle cx="7" cy="18" r="2"/><path d="M9 18h5"/><circle cx="16" cy="18" r="2"/></IconBase>,
            ShoppingBag: (p) => <IconBase {...p}><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></IconBase>,
            Gamepad2: (p) => <IconBase {...p}><line x1="6" x2="10" y1="12" y2="12"/><line x1="8" x2="8" y1="10" y2="14"/><line x1="15" x2="15.01" y1="13" y2="13"/><line x1="18" x2="18.01" y1="11" y2="11"/><rect width="20" height="12" x="2" y="6" rx="2"/></IconBase>,
            Plane: (p) => <IconBase {...p}><path d="M2 12h5"/><path d="M13 12h3"/><path d="M9.3 6.3 9 6l6-6 4 4"/><path d="m15 12 3.3 10.7a1 1 0 0 1-1.3 1.3L6.3 15"/><path d="m19 6-7 7"/></IconBase>,
            AlertCircle: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>,
            Briefcase: (p) => <IconBase {...p}><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></IconBase>,
            Coffee: (p) => <IconBase {...p}><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" x2="6" y1="1" y2="4"/><line x1="10" x2="10" y1="1" y2="4"/><line x1="14" x2="14" y1="1" y2="4"/></IconBase>,
            Home: (p) => <IconBase {...p}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></IconBase>,
            Zap: (p) => <IconBase {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconBase>,
            MoreHorizontal: (p) => <IconBase {...p}><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></IconBase>,
            PieChart: (p) => <IconBase {...p}><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></IconBase>,
            Calendar: (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>,
            BarChart3: (p) => <IconBase {...p}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></IconBase>,
            Clock: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>,
            Filter: (p) => <IconBase {...p}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></IconBase>,
            ArrowUp: (p) => <IconBase {...p}><line x1="12" x2="12" y1="19" y2="5"/><polyline points="5 12 12 5 19 12"/></IconBase>,
            ArrowDown: (p) => <IconBase {...p}><line x1="12" x2="12" y1="5" y2="19"/><polyline points="19 12 12 19 5 12"/></IconBase>,
            Check: (p) => <IconBase {...p}><polyline points="20 6 9 17 4 12"/></IconBase>,
            CheckCircle: (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>,
            Circle: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/></IconBase>,
            StopCircle: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><rect x="9" y="9" width="6" height="6"/></IconBase>,
            RotateCcw: (p) => <IconBase {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconBase>,
            Download: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>,
            Upload: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconBase>,
            Heart: (p) => <IconBase {...p}><path d="M19 14c1.49-1.28 3.6-2.5 3.6-4.96C22.6 5.11 19.5 2 15.5 2 12.5 2 11 4 11 4s-1.5-2-4.5-2C2.5 2 .6 5.11.6 9.04c0 2.46 2.1 3.68 3.6 4.96C6 15.77 11 19.5 11 19.5s5-3.73 6.8-5.5z"/></IconBase>,
            Star: (p) => <IconBase {...p}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></IconBase>,
            Book: (p) => <IconBase {...p}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></IconBase>,
            Gift: (p) => <IconBase {...p}><polyline points="20 12 20 22 4 22 4 12"/><rect width="20" height="5" x="2" y="7" rx="1"/><line x1="12" x2="12" y1="22" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></IconBase>,
            Music: (p) => <IconBase {...p}><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></IconBase>,
            Dumbbell: (p) => <IconBase {...p}><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m2 6 4-4"/><path d="m3 10 7-7"/><path d="m14 21 7-7"/></IconBase>,
            Car: (p) => <IconBase {...p}><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><path d="M9 17h6"/><circle cx="17" cy="17" r="2"/></IconBase>,
            Baby: (p) => <IconBase {...p}><path d="M9 12h.01"/><path d="M15 12h.01"/><path d="M10 16c.5.3 1.2.5 2 .5s1.5-.2 2-.5"/><path d="M19 6.3a9 9 0 0 1 1.8 3.9 2 2 0 0 1 0 3.6 9 9 0 0 1-17.6 0 2 2 0 0 1 0-3.6A9 9 0 0 1 12 3c2 0 3.5 1.1 3.5 2.5s-.9 2.5-2 2.5c-.8 0-1.5-.4-1.5-1"/></IconBase>,
            Shirt: (p) => <IconBase {...p}><path d="M20.38 3.46 16 2a4 4 0 0 1-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.47a1 1 0 0 0 .99.84H6v10c0 1.1.9 2 2 2h8a2 2 0 0 0 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.47a2 2 0 0 0-1.34-2.23z"/></IconBase>,
            Smartphone: (p) => <IconBase {...p}><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></IconBase>,
            Wifi: (p) => <IconBase {...p}><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" x2="12.01" y1="20" y2="20"/></IconBase>,
            Droplet: (p) => <IconBase {...p}><path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z"/></IconBase>,
            HelpCircle: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></IconBase>,
            Circle: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/></IconBase>,
        };

        const { 
            Plus, X, RefreshCw, Trash2, Wallet, CreditCard, Building2, 
            ChevronRight, ChevronLeft, ArrowUpRight, ArrowDownLeft, Settings, Edit2, 
            Utensils, Bus, ShoppingBag, Gamepad2, Plane, AlertCircle, 
            Briefcase, Coffee, Home, Zap, MoreHorizontal, PieChart, Info,
            Calendar, BarChart3, Clock, Filter, ArrowUp, ArrowDown, Check, CheckCircle, Circle, StopCircle, RotateCcw, Download, Upload
        } = Icons;

        // ç¯„ä¾‹è³‡æ–™
        const getDemoData = () => {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            const twoDaysAgo = new Date(today);
            twoDaysAgo.setDate(today.getDate() - 2);
            const twoDaysAgoStr = twoDaysAgo.toISOString().split('T')[0];
            const currentMonthStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            const pastMonthStr = `${today.getFullYear()}-${String(today.getMonth()).padStart(2, '0')}`;

            return {
                accounts: [
                    { id: 'acc_cash', name: 'ç¾é‡‘éŒ¢åŒ…', type: 'cash', initialBalance: 3500, billingStartDay: 1 },
                    { id: 'acc_bank', name: 'è–ªè½‰æˆ¶é ­', type: 'bank', initialBalance: 120000, billingStartDay: 1 },
                    { id: 'acc_card', name: 'å¯Œé‚¦ Costco', type: 'credit', initialBalance: 0, creditLimit: 150000, billingStartDay: 5 },
                ],
                transactions: [
                    { id: Date.now(), title: 'æ—©é¤', amount: 65, type: 'expense', category: 'food', accountId: 'acc_cash', date: todayStr, time: '08:30', isReconciled: false },
                    { id: Date.now() - 1, title: 'åŠ æ²¹', amount: 150, type: 'expense', category: 'transport', accountId: 'acc_card', date: todayStr, time: '08:45', isReconciled: false },
                    { id: Date.now() - 2, title: 'åˆé¤', amount: 120, type: 'expense', category: 'food', accountId: 'acc_cash', date: todayStr, time: '12:15', isReconciled: false },
                    { id: Date.now() - 86400000, title: 'å…¨è¯æŽ¡è³¼', amount: 850, type: 'expense', category: 'shopping', accountId: 'acc_card', date: yesterdayStr, time: '19:20', isReconciled: true },
                    { id: Date.now() - 86400001, title: 'é£²æ–™', amount: 50, type: 'expense', category: 'food', accountId: 'acc_cash', date: yesterdayStr, time: '14:00', isReconciled: true },
                    { id: Date.now() - 172800000, title: 'æ™šé¤èšé¤', amount: 450, type: 'expense', category: 'food', accountId: 'acc_card', date: twoDaysAgoStr, time: '19:00', isReconciled: false },
                    { id: 1701000000000, title: 'Netflix', amount: 390, type: 'expense', category: 'entertainment', accountId: 'acc_card', date: `${currentMonthStr}-05`, time: '10:00', isRecurring: true, frequency: 'monthly', includeInBudget: true },
                    { id: 1701000000001, title: 'æˆ¿ç§Ÿ', amount: 15000, type: 'expense', category: 'housing', accountId: 'acc_bank', date: `${currentMonthStr}-01`, time: '09:00', isRecurring: true, frequency: 'monthly', includeInBudget: true },
                    { id: 1698000000000, title: 'iPhone 15 Pro', amount: 36900, type: 'expense', category: 'shopping', accountId: 'acc_card', date: `${pastMonthStr}-15`, time: '14:30', installments: 12, includeInBudget: false }, 
                    { id: 1701000000002, title: 'è–ªè³‡', amount: 55000, type: 'income', category: 'salary', accountId: 'acc_bank', date: `${currentMonthStr}-05`, time: '09:00' }
                ]
            };
        };

        // Hook with Default State Logic
        function useStickyState(defaultValue, key) {
            const [value, setValue] = useState(() => {
                const stickyValue = window.localStorage.getItem(key);
                if (stickyValue !== null) {
                    return JSON.parse(stickyValue);
                } else {
                    if (key === 'expense_accounts') return getDemoData().accounts;
                    if (key === 'expense_transactions') return getDemoData().transactions;
                    return defaultValue;
                }
            });
            useEffect(() => {
                window.localStorage.setItem(key, JSON.stringify(value));
            }, [key, value]);
            return [value, setValue];
        }

        // é è¨­é¡žåˆ¥
        const DEFAULT_EXPENSE_CATEGORIES = [
            { id: 'food', name: 'é£²é£Ÿ', icon: 'Utensils', color: 'bg-orange-100 text-orange-600' },
            { id: 'transport', name: 'äº¤é€š', icon: 'Bus', color: 'bg-blue-100 text-blue-600' },
            { id: 'shopping', name: 'è³¼ç‰©', icon: 'ShoppingBag', color: 'bg-pink-100 text-pink-600' },
            { id: 'entertainment', name: 'å¨›æ¨‚', icon: 'Gamepad2', color: 'bg-purple-100 text-purple-600' },
            { id: 'travel', name: 'æ—…éŠ', icon: 'Plane', color: 'bg-sky-100 text-sky-600' },
            { id: 'housing', name: 'å±…å®¶', icon: 'Home', color: 'bg-emerald-100 text-emerald-600' },
            { id: 'bills', name: 'å¸³å–®', icon: 'Zap', color: 'bg-yellow-100 text-yellow-600' },
            { id: 'others', name: 'å…¶ä»–', icon: 'MoreHorizontal', color: 'bg-slate-100 text-slate-600' },
        ];

        const DEFAULT_INCOME_CATEGORIES = [
            { id: 'salary', name: 'è–ªè³‡', icon: 'Briefcase', color: 'bg-green-100 text-green-600' },
            { id: 'bonus', name: 'çŽé‡‘', icon: 'AlertCircle', color: 'bg-teal-100 text-teal-600' },
            { id: 'investment', name: 'æŠ•è³‡', icon: 'ArrowDownLeft', color: 'bg-lime-100 text-lime-600' },
        ];

        // åœ–ç¤ºé¸æ“‡æ¸…å–®
        const ICON_CHOICES = [
            'Utensils', 'Bus', 'ShoppingBag', 'Gamepad2', 'Plane', 'Home', 'Zap', 'MoreHorizontal',
            'Briefcase', 'AlertCircle', 'ArrowDownLeft', 'Coffee', 'Car', 'Baby', 'Shirt', 
            'Smartphone', 'Wifi', 'Droplet', 'Heart', 'Star', 'Book', 'Gift', 'Music', 'Dumbbell'
        ];

        const COLOR_CHOICES = [
            'bg-orange-100 text-orange-600',
            'bg-blue-100 text-blue-600',
            'bg-pink-100 text-pink-600',
            'bg-purple-100 text-purple-600',
            'bg-sky-100 text-sky-600',
            'bg-emerald-100 text-emerald-600',
            'bg-yellow-100 text-yellow-600',
            'bg-slate-100 text-slate-600',
            'bg-red-100 text-red-600',
            'bg-indigo-100 text-indigo-600',
            'bg-lime-100 text-lime-600',
            'bg-rose-100 text-rose-600'
        ];

        const getCurrentTime = () => {
            const now = new Date();
            return `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        };

        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        function App() {
            const [view, setView] = useState('home'); 
            const [editingAccountId, setEditingAccountId] = useState(null);
            const [editingTransactionId, setEditingTransactionId] = useState(null); 
            const [filterDate, setFilterDate] = useState(''); 
            const [budgetFilterDate, setBudgetFilterDate] = useState(''); 
            const [accountDetailFilterDate, setAccountDetailFilterDate] = useState(''); 
            const [selectedAccountForDetail, setSelectedAccountForDetail] = useState(null); 
            
            const [manageCategoryType, setManageCategoryType] = useState('expense'); 
            const [editingCategoryId, setEditingCategoryId] = useState(null); 

            const [budgetLimit, setBudgetLimit] = useStickyState(30000, 'expense_budget');
            const [budgetStartDay, setBudgetStartDay] = useStickyState(1, 'expense_budget_start_day');
            
            const [accounts, setAccounts] = useStickyState([], 'expense_accounts');
            const [expenseCategories, setExpenseCategories] = useStickyState(DEFAULT_EXPENSE_CATEGORIES, 'expense_categories_v2');
            const [incomeCategories, setIncomeCategories] = useStickyState(DEFAULT_INCOME_CATEGORIES, 'income_categories_v2');
            const [transactions, setTransactions] = useStickyState([], 'expense_transactions');

            const [formData, setFormData] = useState({
                amount: '',
                title: '',
                type: 'expense',
                category: '', 
                accountId: '',
                isRecurring: false,
                recurringCount: '',
                installments: 1,
                includeInBudget: true,
                date: new Date().toISOString().split('T')[0],
                time: getCurrentTime()
            });

            const [accountForm, setAccountForm] = useState({ name: '', initialBalance: '', creditLimit: '', type: 'cash', billingStartDay: 1 });
            const [categoryForm, setCategoryForm] = useState({ name: '', icon: 'Circle', color: COLOR_CHOICES[0] });

            const fileInputRef = useRef(null);

            useEffect(() => {
                if (expenseCategories.length > 0 && !formData.category && formData.type === 'expense') {
                    setFormData(prev => ({ ...prev, category: expenseCategories[0].id }));
                }
                if (incomeCategories.length > 0 && !formData.category && formData.type === 'income') {
                    setFormData(prev => ({ ...prev, category: incomeCategories[0].id }));
                }
            }, [expenseCategories, incomeCategories, formData.type]);

            useEffect(() => {
                if (!formData.accountId && accounts.length > 0) {
                    setFormData(prev => ({ ...prev, accountId: accounts[0].id }));
                }
            }, [accounts]);

            // --- Helpers ---
            const getAccountIcon = (type) => {
                if (type === 'cash') return Wallet;
                if (type === 'bank') return Building2;
                if (type === 'credit') return CreditCard;
                return Wallet;
            };

            const getAccountColor = (type) => {
                 if (type === 'cash') return 'bg-zinc-800 text-white';
                 if (type === 'bank') return 'bg-blue-600 text-white';
                 if (type === 'credit') return 'bg-indigo-600 text-white';
                 return 'bg-zinc-800 text-white';
            }

            const getCategoryObj = (catId, type) => {
                const list = type === 'income' ? incomeCategories : expenseCategories;
                const found = list.find(c => c.id === catId);
                if (found) return { ...found, iconComp: Icons[found.icon] || Icons.HelpCircle };
                return { name: 'æœªçŸ¥', iconComp: Icons.HelpCircle, color: 'bg-gray-200 text-gray-500' };
            };

            const getAccountBalance = (accId) => {
                const account = accounts.find(a => a.id === accId);
                if (!account) return 0;
                let balance = Number(account.initialBalance);
                transactions.filter(t => t.accountId === accId).forEach(t => {
                    const val = Number(t.amount);
                    if (account.type === 'credit') {
                        balance = t.type === 'expense' ? balance - val : balance + val;
                    } else {
                        balance = t.type === 'income' ? balance + val : balance - val;
                    }
                });
                return balance;
            };

            const netWorth = useMemo(() => accounts.reduce((total, acc) => total + getAccountBalance(acc.id), 0), [accounts, transactions]);

            const getCurrentBudgetPeriod = (startDay) => {
                const now = new Date();
                const currentDay = now.getDate();
                let startDate = new Date(now);
                let endDate = new Date(now);
                if (currentDay >= startDay) {
                    startDate.setDate(startDay);
                    endDate.setMonth(endDate.getMonth() + 1);
                    endDate.setDate(startDay - 1);
                } else {
                    startDate.setMonth(startDate.getMonth() - 1);
                    startDate.setDate(startDay);
                    endDate.setDate(startDay - 1);
                }
                return { 
                    startStr: formatDate(startDate), 
                    endStr: formatDate(endDate),
                    display: `${startDate.getMonth() + 1}/${startDate.getDate()} ~ ${endDate.getMonth() + 1}/${endDate.getDate()}`
                };
            };

            const budgetUsed = useMemo(() => {
                const { startStr, endStr } = getCurrentBudgetPeriod(budgetStartDay);
                return transactions.reduce((total, t) => {
                    if (t.type === 'expense' && t.includeInBudget && t.date >= startStr && t.date <= endStr) {
                        return total + (Number(t.amount) / (t.installments || 1));
                    }
                    return total;
                }, 0);
            }, [transactions, budgetStartDay]);

            const monthlyRecurringTotal = useMemo(() => {
                const now = new Date();
                return transactions.filter(t => {
                    if (!t.isRecurring || t.type !== 'expense' || t.recurringEnded) return false;
                    if (t.recurringCount && t.recurringCount > 0) {
                        const tDate = new Date(t.date);
                        const monthsDiff = (now.getFullYear() - tDate.getFullYear()) * 12 + (now.getMonth() - tDate.getMonth());
                        if (monthsDiff >= t.recurringCount) return false;
                    }
                    return true;
                }).reduce((acc, t) => acc + (Number(t.amount) / (t.installments || 1)), 0);
            }, [transactions]);

            const installmentDebt = useMemo(() => {
                const now = new Date();
                return transactions.reduce((acc, t) => {
                    const accObj = accounts.find(a => a.id === t.accountId);
                    if (t.type === 'expense' && t.installments > 1 && accObj?.type === 'credit') {
                        const tDate = new Date(t.date);
                        const monthsPassed = (now.getFullYear() - tDate.getFullYear()) * 12 + (now.getMonth() - tDate.getMonth());
                        const remaining = Math.max(0, t.installments - monthsPassed);
                        if (remaining > 0) {
                            return acc + (Number(t.amount) / t.installments) * remaining;
                        }
                    }
                    return acc;
                }, 0);
            }, [transactions, accounts]);

            const filteredTransactions = useMemo(() => {
                if (!filterDate) return transactions;
                return transactions.filter(t => t.date === filterDate);
            }, [transactions, filterDate]);

            const getGroupedTransactions = (transactionList) => {
                const groups = {};
                [...transactionList].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(t => {
                    const dateStr = t.date; 
                    if (!groups[dateStr]) groups[dateStr] = [];
                    groups[dateStr].push(t);
                });
                return groups;
            }

            const groupedTransactions = useMemo(() => getGroupedTransactions(filteredTransactions), [filteredTransactions]);

            const getDateLabel = (dateStr) => {
                const today = new Date().toISOString().split('T')[0];
                const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
                if (dateStr === today) return 'ä»Šå¤©';
                if (dateStr === yesterday) return 'æ˜¨å¤©';
                return dateStr;
            };

            const getStats = () => {
                const now = new Date();
                const todayStr = now.toISOString().split('T')[0];
                const firstDayOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
                const weekStartStr = firstDayOfWeek.toISOString().split('T')[0];
                const monthStartStr = `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}-01`;
                const yearStartStr = `${new Date().getFullYear()}-01-01`;

                const stats = {
                    today: { income: 0, expense: 0 },
                    week: { income: 0, expense: 0 },
                    month: { income: 0, expense: 0 },
                    year: { income: 0, expense: 0 },
                };

                transactions.forEach(t => {
                    const d = t.date;
                    const val = Number(t.amount);
                    if (d === todayStr) {
                        t.type === 'income' ? stats.today.income += val : stats.today.expense += val;
                    }
                    if (d >= weekStartStr) {
                        t.type === 'income' ? stats.week.income += val : stats.week.expense += val;
                    }
                    if (d >= monthStartStr) {
                        t.type === 'income' ? stats.month.income += val : stats.month.expense += val;
                    }
                    if (d >= yearStartStr) {
                        t.type === 'income' ? stats.year.income += val : stats.year.expense += val;
                    }
                });
                return stats;
            };

            const getBudgetDetails = () => {
                const { startStr, endStr, display } = getCurrentBudgetPeriod(budgetStartDay);
                let budgetTrans = transactions.filter(t => t.type === 'expense' && t.includeInBudget && t.date >= startStr && t.date <= endStr);
                if (budgetFilterDate) budgetTrans = budgetTrans.filter(t => t.date === budgetFilterDate);
                const allPeriodBudgetTrans = transactions.filter(t => t.type === 'expense' && t.includeInBudget && t.date >= startStr && t.date <= endStr);
                const categoryStats = {};
                allPeriodBudgetTrans.forEach(t => {
                    const val = Number(t.amount) / (t.installments || 1);
                    if (!categoryStats[t.category]) categoryStats[t.category] = 0;
                    categoryStats[t.category] += val;
                });
                const totalPeriodExpense = Object.values(categoryStats).reduce((a, b) => a + b, 0);
                const categoryBars = Object.keys(categoryStats).map(catId => {
                    const catObj = getCategoryObj(catId, 'expense');
                    return { ...catObj, amount: categoryStats[catId], percent: totalPeriodExpense > 0 ? (categoryStats[catId] / totalPeriodExpense) * 100 : 0 };
                }).sort((a, b) => b.amount - a.amount);
                return { list: budgetTrans, categories: categoryBars, total: totalPeriodExpense, periodDisplay: display };
            };

            const getAccountDetails = () => {
                if (!selectedAccountForDetail) return { list: [], balance: 0, cycle: '' };
                let accountTrans = transactions.filter(t => t.accountId === selectedAccountForDetail.id);
                if (accountDetailFilterDate) accountTrans = accountTrans.filter(t => t.date === accountDetailFilterDate);
                const now = new Date();
                const currentDay = now.getDate();
                const startDay = selectedAccountForDetail.billingStartDay || 1;
                let cycleStart = new Date(now);
                let cycleEnd = new Date(now);
                if (currentDay >= startDay) {
                    cycleStart.setDate(startDay);
                    cycleEnd.setMonth(cycleEnd.getMonth() + 1);
                    cycleEnd.setDate(startDay - 1); 
                } else {
                    cycleStart.setMonth(cycleStart.getMonth() - 1);
                    cycleStart.setDate(startDay);
                }
                const nextCycleStart = new Date(cycleStart);
                nextCycleStart.setMonth(nextCycleStart.getMonth() + 1);
                cycleEnd = new Date(nextCycleStart);
                cycleEnd.setDate(cycleEnd.getDate() - 1);
                const cycleStr = `${cycleStart.getMonth() + 1}/${cycleStart.getDate()} ~ ${cycleEnd.getMonth() + 1}/${cycleEnd.getDate()}`;
                return { list: getGroupedTransactions(accountTrans), balance: getAccountBalance(selectedAccountForDetail.id), cycle: cycleStr };
            };

            const getRecurringDetails = () => {
                const now = new Date();
                return transactions.filter(t => {
                    if (!t.isRecurring || t.type !== 'expense' || t.recurringEnded) return false;
                    if (t.recurringCount && t.recurringCount > 0) {
                        const tDate = new Date(t.date);
                        const monthsDiff = (now.getFullYear() - tDate.getFullYear()) * 12 + (now.getMonth() - tDate.getMonth());
                        if (monthsDiff >= t.recurringCount) return false;
                    }
                    return true;
                });
            };

            const getInstallmentDetails = () => {
                const now = new Date();
                return transactions.filter(t => {
                    const accObj = accounts.find(a => a.id === t.accountId);
                    if (t.type === 'expense' && t.installments > 1 && accObj?.type === 'credit') {
                        const tDate = new Date(t.date);
                        const monthsPassed = (now.getFullYear() - tDate.getFullYear()) * 12 + (now.getMonth() - tDate.getMonth());
                        return monthsPassed < t.installments;
                    }
                    return false;
                }).map(t => {
                    const tDate = new Date(t.date);
                    const monthsPassed = (now.getFullYear() - tDate.getFullYear()) * 12 + (now.getMonth() - tDate.getMonth());
                    const remaining = Math.max(0, t.installments - monthsPassed);
                    const remainingAmount = (Number(t.amount) / t.installments) * remaining;
                    return { ...t, remaining, remainingAmount };
                });
            };

            // --- Handlers ---
            const handleSubmit = () => {
                if (!formData.amount) return;
                const catObj = getCategoryObj(formData.category, formData.type);
                const finalTitle = formData.title || catObj.name;
                const transactionData = {
                    ...formData,
                    title: finalTitle,
                    amount: Number(formData.amount),
                    installments: Number(formData.installments) || 1,
                    recurringCount: formData.isRecurring && formData.recurringCount ? Number(formData.recurringCount) : null
                };
                if (editingTransactionId) {
                    setTransactions(transactions.map(t => t.id === editingTransactionId ? { ...transactionData, id: editingTransactionId } : t));
                } else {
                    setTransactions([{ ...transactionData, id: Date.now(), isReconciled: false, recurringEnded: false }, ...transactions]);
                }
                resetForm();
                setView('home');
            };

            const resetForm = () => {
                setFormData({ amount: '', title: '', type: 'expense', category: expenseCategories[0]?.id || '', accountId: accounts[0]?.id || '', isRecurring: false, recurringCount: '', installments: 1, includeInBudget: true, date: new Date().toISOString().split('T')[0], time: getCurrentTime() });
                setEditingTransactionId(null);
            };

            const openEditTransaction = (t) => {
                setFormData({ amount: t.amount, title: t.title, type: t.type, category: t.category, accountId: t.accountId, isRecurring: t.isRecurring, recurringCount: t.recurringCount || '', installments: t.installments, includeInBudget: t.includeInBudget, date: t.date, time: t.time || getCurrentTime() });
                setEditingTransactionId(t.id);
                setView('add');
            };

            const toggleReconciled = (id, e) => {
                e.stopPropagation();
                setTransactions(transactions.map(t => t.id === id ? { ...t, isReconciled: !t.isReconciled } : t));
            };

            const exportToCSV = () => {
                const headers = ["æ—¥æœŸ", "æ™‚é–“", "é …ç›®", "é‡‘é¡", "é¡žåž‹", "é¡žåˆ¥", "å¸³æˆ¶", "é€±æœŸæ€§", "åˆ†æœŸ", "å·²å°å¸³"];
                const rows = transactions.map(t => {
                    const acc = accounts.find(a => a.id === t.accountId);
                    const catObj = getCategoryObj(t.category, t.type);
                    return [
                        t.date,
                        t.time || '',
                        `"${t.title.replace(/"/g, '""')}"`, 
                        t.amount,
                        t.type === 'expense' ? 'æ”¯å‡º' : 'æ”¶å…¥',
                        catObj.name,
                        acc ? acc.name : 'æœªçŸ¥å¸³æˆ¶',
                        t.isRecurring ? 'æ˜¯' : 'å¦',
                        t.installments > 1 ? `${t.installments}æœŸ` : '1',
                        t.isReconciled ? 'æ˜¯' : 'å¦'
                    ].join(',');
                });
                const csvContent = "\uFEFF" + [headers.join(','), ...rows].join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `è¨˜å¸³è³‡æ–™_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const loadDemoData = () => {
                if (confirm('ç¢ºå®šè¦æ¸…é™¤ç¾æœ‰è³‡æ–™ä¸¦è¼‰å…¥ç¯„ä¾‹å—Žï¼Ÿé€™ç„¡æ³•å¾©åŽŸã€‚')) {
                    const demo = getDemoData();
                    setAccounts(demo.accounts);
                    setTransactions(demo.transactions);
                    alert('ç¯„ä¾‹è³‡æ–™è¼‰å…¥å®Œæˆï¼');
                    setView('home');
                }
            };
            
            const handleImportCSV = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (!confirm('ã€è­¦å‘Šã€‘åŒ¯å…¥åŠŸèƒ½å°‡æœƒã€Œå®Œå…¨å–ä»£ã€ç›®å‰Appå…§çš„æ‰€æœ‰è¨˜å¸³è³‡æ–™ï¼\n\né€™é©åˆæ‚¨åœ¨ Excel æ•´ç†å®Œæ‰€æœ‰å¸³å‹™å¾Œï¼Œä¸€æ¬¡æ€§åŒæ­¥å›žæ‰‹æ©Ÿã€‚\n\nç¢ºå®šè¦è¦†è“‹å—Žï¼Ÿ')) {
                    e.target.value = null; 
                    return;
                }

                const reader = new FileReader();
                reader.onload = (event) => {
                    const text = event.target.result;
                    const lines = text.split('\n');
                    const newTransactions = [];
                    // Simple CSV parsing (assuming standard format from export)
                    // Skip header
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        // Handle quotes: split by comma but respect quotes
                        const matches = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                        // Simplified split for standard export
                        // A more robust parser would be needed for complex CSVs, but for this app's export:
                        const cols = line.split(','); 
                        // Note: Title might have commas, but we export with quotes. 
                        // Let's use a simple regex split for basic support or assume standard structure
                        // Export format: date, time, "title", amount, type, category, account, recurring, installment, reconciled
                        
                        if (cols.length < 5) continue; 
                        
                        // Extract basic fields (this is a basic parser)
                        const date = cols[0];
                        const time = cols[1];
                        let title = cols[2];
                        if (title.startsWith('"') && title.endsWith('"')) title = title.slice(1, -1).replace(/""/g, '"');
                        const amount = Number(cols[3]);
                        const typeStr = cols[4];
                        const catName = cols[5];
                        const accName = cols[6];
                        const recurringStr = cols[7];
                        const installStr = cols[8];
                        const recStr = cols[9];

                        // Logic to map names to IDs or create new ones
                        // 1. Account
                        let accId = accounts.find(a => a.name === accName)?.id;
                        if (!accId) {
                            // Create new account if not found
                            accId = `acc_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
                            const newAcc = { id: accId, name: accName, type: 'cash', initialBalance: 0 };
                            setAccounts(prev => [...prev, newAcc]); 
                        }

                        // 2. Category
                        const isExpense = typeStr === 'æ”¯å‡º';
                        const catList = isExpense ? expenseCategories : incomeCategories;
                        let catId = catList.find(c => c.name === catName)?.id;
                        if (!catId) {
                            // Fallback to 'others' or create new? Let's fallback to 'others' id if exists, or first
                            catId = catList[0]?.id || 'others'; 
                        }

                        // 3. Installments
                        let installments = 1;
                        if (installStr && installStr.includes('æœŸ')) {
                            installments = parseInt(installStr);
                        } else if (installStr) {
                            installments = parseInt(installStr) || 1;
                        }

                        newTransactions.push({
                            id: Date.now() + i, // Generate new ID to avoid conflict or complex merging
                            title, amount, date, time,
                            type: isExpense ? 'expense' : 'income',
                            category: catId,
                            accountId: accId,
                            isRecurring: recurringStr === 'æ˜¯',
                            installments: installments,
                            isReconciled: recStr === 'æ˜¯',
                            includeInBudget: true // Default
                        });
                    }
                    
                    setTransactions(newTransactions); // Overwrite (Replace All)
                    alert(`æˆåŠŸåŒ¯å…¥ä¸¦è¦†è“‹ï¼å…± ${newTransactions.length} ç­†äº¤æ˜“ã€‚`);
                    e.target.value = null; // Reset input
                    setView('home');
                };
                reader.readAsText(file);
            };

            const stopRecurring = () => {
                if(confirm('ç¢ºå®šè¦å¾žä¸‹å€‹æœˆé–‹å§‹åœæ­¢é€™å€‹å¾ªç’°å—Žï¼Ÿ')) {
                    setTransactions(transactions.map(t => 
                        t.id === editingTransactionId ? { ...t, recurringEnded: true } : t
                    ));
                    resetForm();
                    setView('home');
                }
            };

            const deleteItem = (id, e) => {
                e.stopPropagation();
                if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—Žï¼Ÿ')) {
                    setTransactions(transactions.filter(t => t.id !== id));
                }
            };

            const handleSaveAccount = () => {
                if (!accountForm.name) return;
                const accountData = {
                    ...accountForm,
                    initialBalance: accountForm.type === 'credit' ? 0 : Number(accountForm.initialBalance),
                    creditLimit: accountForm.type === 'credit' ? Number(accountForm.creditLimit) : undefined,
                    billingStartDay: Number(accountForm.billingStartDay) || 1
                };
                if (editingAccountId) {
                    setAccounts(accounts.map(acc => acc.id === editingAccountId ? { ...acc, ...accountData } : acc));
                } else {
                    setAccounts([...accounts, { id: `acc_${Date.now()}`, ...accountData }]);
                }
                setView('manage_accounts');
                setEditingAccountId(null);
            };

            const handleDeleteAccount = (id) => {
                if (accounts.length <= 1) return alert("è‡³å°‘ä¿ç•™ä¸€å€‹å¸³æˆ¶");
                if(confirm('åˆªé™¤å¸³æˆ¶å°‡ç„¡æ³•å¾©åŽŸï¼Œç¢ºå®šå—Žï¼Ÿ')) {
                    setAccounts(accounts.filter(a => a.id !== id));
                    setTransactions(transactions.filter(t => t.accountId !== id)); 
                }
            };

            const handleMoveAccount = (index, direction) => {
                const newAccounts = [...accounts];
                if (direction === 'up' && index > 0) {
                    [newAccounts[index], newAccounts[index - 1]] = [newAccounts[index - 1], newAccounts[index]];
                } else if (direction === 'down' && index < newAccounts.length - 1) {
                    [newAccounts[index], newAccounts[index + 1]] = [newAccounts[index + 1], newAccounts[index]];
                }
                setAccounts(newAccounts);
            };

            const handleMoveCategory = (index, direction) => {
                const isExpense = manageCategoryType === 'expense';
                const currentList = isExpense ? expenseCategories : incomeCategories;
                const setList = isExpense ? setExpenseCategories : setIncomeCategories;
                const newList = [...currentList];
                if (direction === 'up' && index > 0) {
                    [newList[index], newList[index - 1]] = [newList[index - 1], newList[index]];
                } else if (direction === 'down' && index < newList.length - 1) {
                    [newList[index], newList[index + 1]] = [newList[index + 1], newList[index]];
                }
                setList(newList);
            };

            const handleAddCategory = () => {
                if (!categoryForm.name) return;
                const newCat = {
                    id: `cat_${Date.now()}`,
                    name: categoryForm.name,
                    icon: categoryForm.icon,
                    color: categoryForm.color
                };
                if (manageCategoryType === 'expense') {
                    setExpenseCategories([...expenseCategories, newCat]);
                } else {
                    setIncomeCategories([...incomeCategories, newCat]);
                }
                setView('manage_categories');
            };

            const handleDeleteCategory = (id) => {
                if (manageCategoryType === 'expense') {
                    if (expenseCategories.length <= 1) return alert('è‡³å°‘ä¿ç•™ä¸€å€‹é¡žåˆ¥');
                    if(confirm('ç¢ºå®šåˆªé™¤æ­¤é¡žåˆ¥ï¼Ÿ')) setExpenseCategories(expenseCategories.filter(c => c.id !== id));
                } else {
                    if (incomeCategories.length <= 1) return alert('è‡³å°‘ä¿ç•™ä¸€å€‹é¡žåˆ¥');
                    if(confirm('ç¢ºå®šåˆªé™¤æ­¤é¡žåˆ¥ï¼Ÿ')) setIncomeCategories(incomeCategories.filter(c => c.id !== id));
                }
            };

            const openEditAccount = (acc) => { 
                setEditingAccountId(acc.id); 
                setAccountForm({ name: acc.name, initialBalance: acc.initialBalance, creditLimit: acc.creditLimit || '', type: acc.type, billingStartDay: acc.billingStartDay || 1 }); 
                setView('edit_account'); 
            };
            const openAddAccount = () => { 
                setEditingAccountId(null); 
                setAccountForm({ name: '', initialBalance: '', creditLimit: '', type: 'cash', billingStartDay: 1 }); 
                setView('edit_account'); 
            };
            const openManageCategories = (type) => { setManageCategoryType(type); setView('manage_categories'); };
            const openAddCategory = () => { setCategoryForm({ name: '', icon: 'Circle', color: COLOR_CHOICES[0] }); setView('add_category'); };
            const openAccountDetail = (acc) => { setSelectedAccountForDetail(acc); setAccountDetailFilterDate(''); setView('account_detail'); };

            const selectedAccountObj = accounts.find(a => a.id === formData.accountId);
            const isCreditCardSelected = selectedAccountObj?.type === 'credit';
            const currentCategories = formData.type === 'income' ? incomeCategories : expenseCategories;
            const currentBudgetPeriod = getCurrentBudgetPeriod(budgetStartDay);

            return (
                <div className="min-h-screen bg-[#F2F4F7] flex flex-col items-center">
                    <div className="w-full max-w-md bg-white min-h-screen shadow-xl relative flex flex-col">
                        
                        {/* VIEW: Home */}
                        {view === 'home' && (
                            <>
                                <div className="pt-12 pb-4 px-6 bg-white z-10 sticky top-0 shadow-sm">
                                    <div className="flex justify-between items-start mb-6">
                                        <div>
                                            <span className="text-slate-400 text-xs font-bold tracking-widest uppercase">ç¸½è³‡ç”¢æ·¨å€¼</span>
                                            <h1 className="text-4xl font-black text-slate-900 mt-1 tracking-tight">
                                                ${netWorth.toLocaleString()}
                                            </h1>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => setView('stats')} className="p-2 bg-slate-100 rounded-full hover:bg-slate-200">
                                                <BarChart3 size={20} className="text-slate-600" />
                                            </button>
                                            <button onClick={() => setView('manage_accounts')} className="p-2 bg-slate-100 rounded-full hover:bg-slate-200">
                                                <Settings size={20} className="text-slate-600" />
                                            </button>
                                        </div>
                                    </div>

                                    {/* Info Chips */}
                                    <div className="flex gap-2 mb-4 overflow-x-auto scrollbar-hide">
                                        {monthlyRecurringTotal > 0 && (
                                            <div 
                                                onClick={() => setView('recurring_detail')}
                                                className="flex items-center gap-2 bg-orange-50 px-3 py-2 rounded-xl border border-orange-100 shrink-0 cursor-pointer active:scale-95 transition-transform"
                                            >
                                                <RefreshCw size={14} className="text-orange-500"/>
                                                <div>
                                                    <p className="text-[10px] text-orange-400 font-bold uppercase">æ¯æœˆå›ºå®š</p>
                                                    <p className="text-sm font-bold text-orange-700">${monthlyRecurringTotal.toLocaleString()}</p>
                                                </div>
                                            </div>
                                        )}
                                        {installmentDebt > 0 && (
                                            <div 
                                                onClick={() => setView('installment_detail')}
                                                className="flex items-center gap-2 bg-indigo-50 px-3 py-2 rounded-xl border border-indigo-100 shrink-0 cursor-pointer active:scale-95 transition-transform"
                                            >
                                                <CreditCard size={14} className="text-indigo-500"/>
                                                <div>
                                                    <p className="text-[10px] text-indigo-400 font-bold uppercase">åˆ†æœŸå‰©é¤˜</p>
                                                    <p className="text-sm font-bold text-indigo-700">${Math.round(installmentDebt).toLocaleString()}</p>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {/* Budget Bar */}
                                    <div onClick={() => setView('budget_detail')} className="mb-6 bg-slate-50 p-4 rounded-2xl border border-slate-100 relative overflow-hidden cursor-pointer active:scale-[0.99] transition-transform">
                                        <div className="flex justify-between items-end mb-2 relative z-10">
                                            <div>
                                                <p className="text-xs font-bold text-slate-400 uppercase flex items-center gap-1">æœ¬æœŸé ç®—å‰©é¤˜ <ChevronRight size={12}/></p>
                                                <p className={`text-xl font-bold ${(budgetLimit - budgetUsed) < 0 ? 'text-red-500' : 'text-slate-800'}`}>
                                                    ${(budgetLimit - budgetUsed).toLocaleString(undefined, { maximumFractionDigits: 0 })}
                                                </p>
                                            </div>
                                            <div className="text-right">
                                                <p className="text-xs text-slate-400 font-bold">{Math.round((budgetUsed / budgetLimit) * 100)}%</p>
                                            </div>
                                        </div>
                                        <div className="w-full h-2 bg-slate-200 rounded-full overflow-hidden">
                                            <div className={`h-full rounded-full transition-all duration-500 ${budgetUsed > budgetLimit ? 'bg-red-500' : 'bg-slate-900'}`} style={{ width: `${Math.min((budgetUsed / budgetLimit) * 100, 100)}%` }}></div>
                                        </div>
                                        <div className="text-[10px] text-slate-400 mt-2 text-right">
                                            çµ±è¨ˆé€±æœŸï¼š{currentBudgetPeriod.display}
                                        </div>
                                    </div>

                                    {/* Accounts List (Vertical & Full Width) */}
                                    <div className="flex flex-col gap-3 px-1 pb-32">
                                        {accounts.map(acc => {
                                            const bal = getAccountBalance(acc.id);
                                            const Icon = getAccountIcon(acc.type);
                                            const colorClass = getAccountColor(acc.type);
                                            
                                            const isCredit = acc.type === 'credit';
                                            const availableCredit = isCredit && acc.creditLimit ? acc.creditLimit + bal : 0;

                                            return (
                                                <div 
                                                    key={acc.id} 
                                                    onClick={() => openAccountDetail(acc)}
                                                    className={`w-full p-4 rounded-2xl flex items-center justify-between ${colorClass} shadow-lg shadow-slate-200/50 cursor-pointer active:scale-95 transition-transform`}
                                                >
                                                    <div className="flex items-center gap-4">
                                                        <div className="bg-white/20 p-2 rounded-full">
                                                            <Icon size={24} />
                                                        </div>
                                                        <div>
                                                            <p className="text-sm font-bold opacity-90">{acc.name}</p>
                                                            {isCredit ? (
                                                                <p className="text-[10px] opacity-70">å¯ç”¨é¡åº¦</p>
                                                            ) : (
                                                                <p className="text-[10px] opacity-70">ç•¶å‰é¤˜é¡</p>
                                                            )}
                                                        </div>
                                                    </div>
                                                    
                                                    <div className="text-right">
                                                        {isCredit ? (
                                                            <>
                                                                <p className="text-xl font-bold tracking-tight">${availableCredit.toLocaleString()}</p>
                                                                <p className="text-[10px] opacity-70">å·²ç”¨: ${Math.abs(bal).toLocaleString()}</p>
                                                            </>
                                                        ) : (
                                                            <p className="text-xl font-bold tracking-tight">${Math.abs(bal).toLocaleString()}</p>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>

                                {/* Floating Add Button */}
                                <div className="absolute bottom-8 left-0 w-full flex justify-center pointer-events-none z-20 safe-area-bottom">
                                    <button onClick={() => { resetForm(); setView('add'); }} className="pointer-events-auto bg-slate-900 text-white w-16 h-16 rounded-full shadow-xl shadow-slate-300 flex items-center justify-center hover:scale-105 active:scale-95 transition-all"><Plus size={32} /></button>
                                </div>
                            </>
                        )}

                        {/* VIEW: Recurring Details */}
                        {view === 'recurring_detail' && (
                            <div className="h-full bg-white flex flex-col p-6 animate-in slide-in-from-right duration-200 safe-area-bottom overflow-y-auto">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-bold text-slate-900">æ¯æœˆå›ºå®šæ”¯å‡º</h2>
                                    <button onClick={() => setView('home')} className="p-2 bg-slate-100 rounded-full text-slate-600"><ChevronLeft size={20} /></button>
                                </div>
                                <div className="space-y-3">
                                    {getRecurringDetails().length === 0 ? <p className="text-center text-slate-300 py-10">ç›®å‰æ²’æœ‰å›ºå®šæ”¯å‡º</p> : 
                                    getRecurringDetails().map(t => (
                                        <div key={t.id} onClick={() => openEditTransaction(t)} className="flex items-center justify-between p-4 rounded-2xl border border-orange-100 bg-orange-50/30 cursor-pointer">
                                            <div>
                                                <p className="font-bold text-slate-800">{t.title}</p>
                                                <p className="text-xs text-orange-500">æ¯æœˆ {new Date(t.date).getDate()} è™Ÿæ‰£æ¬¾ {t.recurringCount ? `(å‰© ${Math.max(0, t.recurringCount - 1)} æœŸ)` : '(ç„¡é™æœŸ)'}</p>
                                            </div>
                                            <span className="font-bold text-slate-800">${Number(t.amount).toLocaleString()}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* VIEW: Installment Details */}
                        {view === 'installment_detail' && (
                            <div className="h-full bg-white flex flex-col p-6 animate-in slide-in-from-right duration-200 safe-area-bottom overflow-y-auto">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-bold text-slate-900">åˆ†æœŸä»˜æ¬¾æ˜Žç´°</h2>
                                    <button onClick={() => setView('home')} className="p-2 bg-slate-100 rounded-full text-slate-600"><ChevronLeft size={20} /></button>
                                </div>
                                <div className="space-y-3">
                                    {getInstallmentDetails().length === 0 ? <p className="text-center text-slate-300 py-10">ç›®å‰æ²’æœ‰åˆ†æœŸä»˜æ¬¾</p> : 
                                    getInstallmentDetails().map(t => (
                                        <div key={t.id} onClick={() => openEditTransaction(t)} className="p-4 rounded-2xl border border-indigo-100 bg-indigo-50/30 cursor-pointer">
                                            <div className="flex justify-between items-start mb-2">
                                                <p className="font-bold text-slate-800">{t.title}</p>
                                                <span className="font-bold text-indigo-600">${Number(t.amount).toLocaleString()}</span>
                                            </div>
                                            <div className="flex justify-between items-center text-xs text-slate-500">
                                                <span>åˆ† {t.installments} æœŸ (å‰© {t.remaining} æœŸ)</span>
                                                <span className="font-bold text-indigo-400">å‰©é¤˜æ¬¾é …: ${Math.round(t.remainingAmount).toLocaleString()}</span>
                                            </div>
                                            {/* Progress bar */}
                                            <div className="w-full h-1.5 bg-indigo-100 rounded-full mt-2 overflow-hidden">
                                                <div className="h-full bg-indigo-500 rounded-full" style={{ width: `${((t.installments - t.remaining) / t.installments) * 100}%` }}></div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* VIEW: Account Detail (New) */}
                        {view === 'account_detail' && selectedAccountForDetail && (
                            <div className="h-full bg-white flex flex-col p-6 animate-in slide-in-from-right duration-200 safe-area-bottom overflow-y-auto">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-bold text-slate-900 truncate pr-4">{selectedAccountForDetail.name}</h2>
                                    <button onClick={() => setView('home')} className="p-2 bg-slate-100 rounded-full text-slate-600"><ChevronLeft size={20} /></button>
                                </div>

                                {/* Account Summary Card */}
                                <div className={`p-6 rounded-2xl mb-6 shadow-lg ${getAccountColor(selectedAccountForDetail.type)}`}>
                                    <div className="flex justify-between items-start mb-1">
                                        <p className="text-sm opacity-80">ç•¶å‰é¤˜é¡ / å·²ç”¨é¡åº¦</p>
                                        <div className="bg-black/20 px-2 py-1 rounded text-[10px] font-bold">
                                            {selectedAccountForDetail.billingStartDay ? `æ¯æœˆ ${selectedAccountForDetail.billingStartDay} è™Ÿçµå¸³` : 'æœªè¨­å®šçµå¸³æ—¥'}
                                        </div>
                                    </div>
                                    <p className="text-3xl font-bold mb-4">${Math.abs(getAccountDetails().balance).toLocaleString()}</p>
                                    
                                    {selectedAccountForDetail.type === 'credit' ? (
                                        <div className="flex justify-between text-xs opacity-70 border-t border-white/20 pt-3">
                                            <span>ç¸½é¡åº¦: ${selectedAccountForDetail.creditLimit?.toLocaleString()}</span>
                                            <span>æœ¬æœŸé€±æœŸ: {getAccountDetails().cycle}</span>
                                        </div>
                                    ) : (
                                        <div className="flex justify-between text-xs opacity-70 border-t border-white/20 pt-3">
                                            <span>çµ±è¨ˆé€±æœŸ: {getAccountDetails().cycle}</span>
                                        </div>
                                    )}
                                </div>

                                {/* Date Filter for Account Detail */}
                                <div className="flex justify-between items-center mb-6">
                                    <span className="text-xs font-bold text-slate-400 uppercase">äº¤æ˜“æ˜Žç´°</span>
                                    <div className="flex items-center gap-2 bg-slate-50 px-3 py-2 rounded-xl border border-slate-100">
                                        <Calendar size={14} className="text-slate-400"/>
                                        <input 
                                            type="date" 
                                            value={accountDetailFilterDate} 
                                            onChange={(e) => setAccountDetailFilterDate(e.target.value)} 
                                            className="text-sm font-bold text-slate-700 bg-transparent outline-none"
                                        />
                                        {accountDetailFilterDate && (
                                            <button onClick={() => setAccountDetailFilterDate('')} className="text-slate-400 hover:text-red-500"><X size={14}/></button>
                                        )}
                                    </div>
                                </div>

                                {/* Transaction List for Account */}
                                <div className="space-y-4">
                                    {Object.keys(getAccountDetails().list).length === 0 ? (
                                        <div className="text-center text-slate-300 py-10 text-sm">ç„¡ç¬¦åˆæ¢ä»¶çš„ç´€éŒ„</div>
                                    ) : (
                                        Object.keys(getAccountDetails().list).map(dateKey => (
                                            <div key={dateKey}>
                                                <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 sticky top-0 bg-white py-1 z-10">
                                                    {getDateLabel(dateKey)}
                                                </h3>
                                                <div className="space-y-3">
                                                    {getAccountDetails().list[dateKey].map(t => {
                                                        const catObj = getCategoryObj(t.category, t.type);
                                                        const CatIcon = catObj.iconComp;
                                                        
                                                        return (
                                                            <div 
                                                                key={t.id} 
                                                                onClick={() => openEditTransaction(t)}
                                                                className={`flex items-center justify-between p-3 rounded-2xl border ${t.isReconciled ? 'border-green-200 bg-green-50/30' : 'border-slate-100'} cursor-pointer active:bg-slate-50 transition-colors`}
                                                            >
                                                                <div className="flex items-center gap-3">
                                                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center ${catObj.color}`}>
                                                                        <CatIcon size={18} />
                                                                    </div>
                                                                    <div>
                                                                        <p className="font-bold text-slate-800 text-sm">{t.title}</p>
                                                                        <p className="text-[10px] text-slate-400">{t.time} {t.installments > 1 && `(åˆ†${t.installments}æœŸ)`}</p>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div className="flex items-center gap-3">
                                                                    <span className={`font-bold ${t.type === 'income' ? 'text-green-600' : 'text-slate-800'}`}>
                                                                        {t.type === 'expense' ? '-' : '+'}{t.amount.toLocaleString()}
                                                                    </span>
                                                                    {/* å°å¸³å‹¾é¸æŒ‰éˆ• */}
                                                                    <button 
                                                                        onClick={(e) => toggleReconciled(t.id, e)} 
                                                                        className={`p-1 rounded-full transition-colors ${t.isReconciled ? 'text-green-500 bg-green-100' : 'text-slate-300 hover:text-slate-400'}`}
                                                                    >
                                                                        {t.isReconciled ? <CheckCircle size={20} /> : <Circle size={20} />}
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        )}

                        {/* VIEW: Budget Detail */}
                        {view === 'budget_detail' && (
                            <div className="h-full bg-white flex flex-col p-6 animate-in slide-in-from-right duration-200 safe-area-bottom overflow-y-auto">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-bold text-slate-900">æœ¬æœŸé ç®—è©³æƒ…</h2>
                                    <button onClick={() => setView('home')} className="p-2 bg-slate-100 rounded-full text-slate-600"><ChevronLeft size={20} /></button>
                                </div>
                                <p className="text-center text-xs text-slate-400 mb-6">çµ±è¨ˆé€±æœŸï¼š{getBudgetDetails().periodDisplay}</p>

                                {/* Date Filter for Budget View */}
                                <div className="flex justify-between items-center mb-6">
                                    <span className="text-xs font-bold text-slate-400 uppercase">ç¯©é¸æ—¥æœŸ</span>
                                    <div className="flex items-center gap-2 bg-slate-50 px-3 py-2 rounded-xl border border-slate-100">
                                        <Calendar size={14} className="text-slate-400"/>
                                        <input 
                                            type="date" 
                                            value={budgetFilterDate} 
                                            onChange={(e) => setBudgetFilterDate(e.target.value)} 
                                            className="text-sm font-bold text-slate-700 bg-transparent outline-none"
                                        />
                                        {budgetFilterDate && (
                                            <button onClick={() => setBudgetFilterDate('')} className="text-slate-400 hover:text-red-500"><X size={14}/></button>
                                        )}
                                    </div>
                                </div>

                                {/* Category Breakdown Bars */}
                                <div className="mb-8">
                                    <h3 className="text-xs font-bold text-slate-400 uppercase mb-4">é ç®—åˆ†é…æ¯”ä¾‹</h3>
                                    {(() => {
                                        const { categories, total } = getBudgetDetails();
                                        if (total === 0) return <p className="text-sm text-slate-400 text-center py-4">æœ¬æœŸå°šæœªæœ‰é ç®—æ”¯å‡º</p>;
                                        
                                        return (
                                            <div className="space-y-4">
                                                {categories.map((cat, idx) => (
                                                    <div key={idx}>
                                                        <div className="flex justify-between text-sm font-bold text-slate-700 mb-1">
                                                            <div className="flex items-center gap-2">
                                                                <div className={`w-2 h-2 rounded-full ${cat.color.split(' ')[0]}`}></div>
                                                                {cat.name}
                                                            </div>
                                                            <span>{Math.round(cat.percent)}%</span>
                                                        </div>
                                                        <div className="w-full h-2 bg-slate-100 rounded-full overflow-hidden">
                                                            <div className={`h-full rounded-full ${cat.color.split(' ')[0]}`} style={{ width: `${cat.percent}%` }}></div>
                                                        </div>
                                                        <div className="text-right text-[10px] text-slate-400 mt-0.5">${Math.round(cat.amount).toLocaleString()}</div>
                                                    </div>
                                                ))}
                                            </div>
                                        );
                                    })()}
                                </div>

                                {/* Transaction List for Budget */}
                                <div>
                                    <h3 className="text-xs font-bold text-slate-400 uppercase mb-4">æ˜Žç´°åˆ—è¡¨ {budgetFilterDate ? `(${budgetFilterDate})` : ''}</h3>
                                    <div className="space-y-3">
                                        {getBudgetDetails().list.length === 0 ? (
                                            <div className="text-center text-slate-300 py-10 text-sm">ç„¡ç¬¦åˆæ¢ä»¶çš„ç´€éŒ„</div>
                                        ) : (
                                            getBudgetDetails().list.map(t => {
                                                const catObj = getCategoryObj(t.category, t.type);
                                                const CatIcon = catObj.iconComp;
                                                const dateObj = new Date(t.date);
                                                
                                                return (
                                                    <div key={t.id} onClick={() => openEditTransaction(t)} className="flex items-center justify-between p-3 rounded-2xl border border-slate-100 cursor-pointer active:bg-slate-50">
                                                        <div className="flex items-center gap-3">
                                                            <div className={`w-10 h-10 rounded-full flex items-center justify-center ${catObj.color}`}>
                                                                <CatIcon size={18}/>
                                                            </div>
                                                            <div>
                                                                <p className="font-bold text-slate-800 text-sm">{t.title}</p>
                                                                <p className="text-[10px] text-slate-400">{dateObj.getMonth()+1}/{dateObj.getDate()} {t.time}</p>
                                                            </div>
                                                        </div>
                                                        <span className="font-bold text-slate-800">-${Number(t.amount).toLocaleString()}</span>
                                                    </div>
                                                )
                                            })
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* VIEW: Stats */}
                        {view === 'stats' && (
                            <div className="h-full bg-white flex flex-col p-6 animate-in slide-in-from-right duration-200 safe-area-bottom overflow-y-auto">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-bold text-slate-900 flex items-center gap-2">
                                        <BarChart3 size={24}/> æ”¶æ”¯çµç®—
                                    </h2>
                                    <button onClick={() => setView('home')} className="p-2 bg-slate-100 rounded-full text-slate-600"><X size={20} /></button>
                                </div>

                                <div className="space-y-6">
                                    {['today', 'week', 'month', 'year'].map(period => {
                                        const stats = getStats();
                                        const labels = { today: 'ä»Šæ—¥', week: 'æœ¬é€±', month: 'æœ¬æœˆ', year: 'ä»Šå¹´' };
                                        const data = stats[period];
                                        const net = data.income - data.expense;

                                        return (
                                            <div key={period} className="border border-slate-100 rounded-2xl p-5 shadow-sm">
                                                <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 border-b pb-2">{labels[period]}æ¦‚æ³</h3>
                                                <div className="grid grid-cols-3 gap-4 text-center">
                                                    <div>
                                                        <p className="text-xs text-slate-400 mb-1">æ”¶å…¥</p>
                                                        <p className="text-lg font-bold text-green-600">+{data.income.toLocaleString()}</p>
                                                    </div>
                                                    <div>
                                                        <p className="text-xs text-slate-400 mb-1">æ”¯å‡º</p>
                                                        <p className="text-lg font-bold text-slate-800">-{data.expense.toLocaleString()}</p>
                                                    </div>
                                                    <div>
                                                        <p className="text-xs text-slate-400 mb-1">çµé¤˜</p>
                                                        <p className={`text-lg font-bold ${net >= 0 ? 'text-green-600' : 'text-red-500'}`}>
                                                            {net >= 0 ? '+' : ''}{net.toLocaleString()}
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* VIEW: Add/Edit Transaction */}
                        {view === 'add' && (
                            <div className="h-full bg-white flex flex-col p-6 animate-in slide-in-from-bottom duration-200 overflow-y-auto safe-area-bottom">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-bold text-slate-900">{editingTransactionId ? 'ç·¨è¼¯ç´€éŒ„' : 'è¨˜ä¸€ç­†'}</h2>
                                    <button onClick={() => { resetForm(); setView('home'); }} className="p-2 bg-slate-100 rounded-full text-slate-600"><X size={20} /></button>
                                </div>

                                {/* Amount */}
                                <div className="mb-4 text-center">
                                    <input type="number" autoFocus placeholder="0" className="w-full text-center text-5xl font-bold text-slate-900 placeholder-slate-200 outline-none bg-transparent" value={formData.amount} onChange={(e) => setFormData({...formData, amount: e.target.value})} />
                                </div>

                                {/* Date & Time Picker */}
                                <div className="mb-6 flex justify-center gap-2">
                                    <div className="bg-slate-50 px-4 py-2 rounded-xl flex items-center gap-2">
                                        <Calendar size={16} className="text-slate-400"/>
                                        <input type="date" value={formData.date} onChange={(e) => setFormData({...formData, date: e.target.value})} className="bg-transparent font-bold text-slate-700 outline-none text-sm"/>
                                    </div>
                                    <div className="bg-slate-50 px-4 py-2 rounded-xl flex items-center gap-2">
                                        <Clock size={16} className="text-slate-400"/>
                                        <input type="time" value={formData.time} onChange={(e) => setFormData({...formData, time: e.target.value})} className="bg-transparent font-bold text-slate-700 outline-none text-sm"/>
                                    </div>
                                </div>

                                {/* Type Toggle */}
                                <div className="flex bg-slate-100 p-1 rounded-xl mb-6 shrink-0">
                                    <button onClick={() => setFormData({...formData, type: 'expense', category: expenseCategories[0]?.id})} className={`flex-1 py-3 rounded-lg text-xs font-bold transition-all ${formData.type === 'expense' ? 'bg-white shadow text-red-500' : 'text-slate-400'}`}>æ”¯å‡º</button>
                                    <button onClick={() => setFormData({...formData, type: 'income', category: incomeCategories[0]?.id})} className={`flex-1 py-3 rounded-lg text-xs font-bold transition-all ${formData.type === 'income' ? 'bg-white shadow text-green-500' : 'text-slate-400'}`}>æ”¶å…¥</button>
                                </div>

                                {/* Categories Grid */}
                                <div className="mb-6">
                                    <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 block">é¡žåˆ¥</label>
                                    <div className="grid grid-cols-4 gap-3">
                                        {currentCategories.map(cat => {
                                            const isSelected = formData.category === cat.id;
                                            const CatIcon = Icons[cat.icon] || Icons.HelpCircle;
                                            return (
                                                <button key={cat.id} onClick={() => setFormData({...formData, category: cat.id})} className={`flex flex-col items-center gap-1 p-2 rounded-xl transition-all ${isSelected ? 'bg-slate-900 text-white scale-105 shadow-md' : 'bg-slate-50 text-slate-400 hover:bg-slate-100'}`}>
                                                    <CatIcon size={20} />
                                                    <span className="text-[10px] font-bold">{cat.name}</span>
                                                </button>
                                            )
                                        })}
                                    </div>
                                </div>

                                {/* Title Input */}
                                <div className="mb-6">
                                    <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">å‚™è¨» (é¸å¡«)</label>
                                    <input type="text" placeholder={`ä¾‹å¦‚: ${formData.category === 'food' ? 'éº¥ç•¶å‹ž' : 'èªªæ˜Ž...'}`} className="w-full bg-slate-50 rounded-xl px-4 py-3 font-bold text-slate-800 outline-none" value={formData.title} onChange={(e) => setFormData({...formData, title: e.target.value})} />
                                </div>

                                {/* Account Select */}
                                <div className="mb-6">
                                    <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 block">å¸³æˆ¶</label>
                                    <div className="flex gap-3 overflow-x-auto pb-2 scrollbar-hide">
                                        {accounts.map(acc => {
                                            const Icon = getAccountIcon(acc.type);
                                            const isSelected = formData.accountId === acc.id;
                                            return (
                                                <button key={acc.id} onClick={() => setFormData({...formData, accountId: acc.id, installments: 1})} className={`min-w-[100px] p-3 rounded-xl border-2 flex flex-col items-center gap-1 transition-all ${isSelected ? 'border-slate-900 bg-slate-900 text-white' : 'border-slate-100 text-slate-400'}`}>
                                                    <Icon size={20} /> <span className="text-[10px] font-bold truncate w-full text-center">{acc.name}</span>
                                                </button>
                                            )
                                        })}
                                    </div>
                                </div>

                                {/* Advanced Options */}
                                <div className="space-y-3 mb-8">
                                    {isCreditCardSelected && formData.type === 'expense' && (
                                        <div className="bg-indigo-50 p-4 rounded-2xl border border-indigo-100 flex items-center justify-between">
                                            <span className="text-xs font-bold text-indigo-800 flex items-center gap-1"><CreditCard size={12}/> åˆ†æœŸä»˜æ¬¾</span>
                                            <div className="flex items-center gap-2">
                                                <button onClick={() => setFormData({...formData, installments: 1})} className={`px-3 py-1 rounded text-xs font-bold ${formData.installments === 1 ? 'bg-indigo-600 text-white' : 'text-indigo-400 bg-white'}`}>ä¸€æ¬¡</button>
                                                <input type="number" placeholder="æœŸæ•¸" className="w-12 py-1 px-1 text-center rounded text-xs font-bold outline-none border border-indigo-100" value={formData.installments > 1 ? formData.installments : ''} onChange={(e) => setFormData({...formData, installments: e.target.value})} />
                                            </div>
                                        </div>
                                    )}
                                    {formData.type === 'expense' && (
                                        <div className="flex items-center justify-between bg-slate-50 p-3 rounded-xl border border-slate-100">
                                            <div className="flex items-center gap-2"><PieChart size={16} className="text-slate-400"/><span className="text-xs font-bold text-slate-600">ç´å…¥é ç®—</span></div>
                                            <button onClick={() => setFormData({...formData, includeInBudget: !formData.includeInBudget})} className={`w-10 h-6 rounded-full transition-colors relative ${formData.includeInBudget ? 'bg-green-500' : 'bg-slate-300'}`}><div className={`w-4 h-4 bg-white rounded-full shadow-sm absolute top-1 transition-transform ${formData.includeInBudget ? 'left-5' : 'left-1'}`}></div></button>
                                        </div>
                                    )}
                                    <div className="bg-slate-50 p-3 rounded-xl border border-slate-100">
                                        <div className="flex items-center justify-between mb-2">
                                            <div className="flex items-center gap-2"><RefreshCw size={16} className="text-slate-400"/><span className="text-xs font-bold text-slate-600">é€±æœŸæ€§ (æ¯æœˆ)</span></div>
                                            <button onClick={() => setFormData({...formData, isRecurring: !formData.isRecurring})} className={`w-10 h-6 rounded-full transition-colors relative ${formData.isRecurring ? 'bg-blue-600' : 'bg-slate-300'}`}><div className={`w-4 h-4 bg-white rounded-full shadow-sm absolute top-1 transition-transform ${formData.isRecurring ? 'left-5' : 'left-1'}`}></div></button>
                                        </div>
                                        
                                        {/* å¾ªç’°æ¬¡æ•¸è¼¸å…¥æ¡† (ç•¶ isRecurring ç‚º true æ™‚é¡¯ç¤º) */}
                                        {formData.isRecurring && (
                                            <div className="flex items-center gap-2 mt-2 pt-2 border-t border-slate-200 animate-in fade-in">
                                                <label className="text-[10px] font-bold text-slate-400 whitespace-nowrap">å¾ªç’°æ¬¡æ•¸ (ç•™ç©ºä»£è¡¨ç„¡é™)</label>
                                                <input 
                                                    type="number" 
                                                    placeholder="âˆž" 
                                                    min="1"
                                                    value={formData.recurringCount}
                                                    onChange={(e) => setFormData({...formData, recurringCount: e.target.value})}
                                                    className="flex-1 bg-white border border-slate-200 rounded px-2 py-1 text-xs font-bold outline-none text-right"
                                                />
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* ä¸­æ­¢å¾ªç’°æŒ‰éˆ• (åƒ…åœ¨ç·¨è¼¯ä¸”æœªä¸­æ­¢çš„ç„¡é™/æœ‰é™å¾ªç’°äº¤æ˜“é¡¯ç¤º) */}
                                {editingTransactionId && formData.isRecurring && !formData.recurringEnded && (
                                    <button 
                                        type="button" // Add type button to prevent unexpected form submission
                                        onClick={stopRecurring}
                                        className="w-full bg-red-50 text-red-500 py-3 rounded-2xl font-bold text-sm mb-3 flex items-center justify-center gap-2"
                                    >
                                        <StopCircle size={16} /> å¾žä¸‹æœŸé–‹å§‹ä¸­æ­¢å¾ªç’°
                                    </button>
                                )}

                                <button onClick={handleSubmit} className="mt-auto w-full bg-slate-900 text-white py-4 rounded-2xl font-bold text-lg shadow-xl shadow-slate-200 active:scale-95 transition-transform mb-4">
                                    {editingTransactionId ? 'æ›´æ–°ç´€éŒ„' : 'å„²å­˜'}
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>